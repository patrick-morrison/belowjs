(function(U,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],l):(U=typeof globalThis<"u"?globalThis:U||self,l(U.BelowJS={},U.THREE))})(this,function(U,l){"use strict";function Gt(c){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(c){for(const t in c)if(t!=="default"){const i=Object.getOwnPropertyDescriptor(c,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:()=>c[t]})}}return e.default=c,Object.freeze(e)}const p=Gt(l);class le{constructor(){this.events={}}on(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),this}off(e,t){return this.events[e]?(t?this.events[e]=this.events[e].filter(i=>i!==t):this.events[e]=[],this):this}emit(e,t){return this.events[e]?(this.events[e].forEach(i=>{try{i(t)}catch(s){console.error(`Error in event callback for '${e}':`,s)}}),this):this}removeAllListeners(){return this.events={},this}}const Ce={container:"#viewer-container",models:{},scene:{background:662058},camera:{fov:65,near:.05,far:2e3,position:{x:0,y:5,z:10}},renderer:{antialias:!0,powerPreference:"high-performance",pixelRatio:Math.min(window.devicePixelRatio,2),outputColorSpace:"srgb",toneMapping:"none",toneMappingExposure:1},controls:{desktop:{enableDamping:!0,dampingFactor:.08,maxDistance:100,minDistance:.5,enableFocus:!0}},vr:{enabled:!0,movement:{moveSpeed:2,turnSpeed:1.5,flySpeed:1},ramping:{speedRampRate:3,boostRampRate:6},controllers:{leftHand:{movement:!0,modeToggleButtons:[4,5]},rightHand:{turning:!0,verticalMovement:!0,modeToggleButtons:[4,5]},gripBoostMultiplier:3},optimization:{quest2RenderDistance:20,autoDetectDevice:!0}}};function Pt(c={}){const e=Ie(Ce,c);if(c.container&&typeof c.container!="string")throw new Error("Container must be a string selector or element ID");return e}function Ut(c){return Ie(Ce,c||{})}const qe={validate:Pt,mergeConfig:Ut,defaultConfig:Ce};function Ie(c,e){const t={...c};for(const i in e)e[i]&&typeof e[i]=="object"&&!Array.isArray(e[i])?t[i]=Ie(c[i]||{},e[i]):t[i]=e[i];return t}class je{constructor(e={}){this.config=e,this.scene=new p.Scene,this.init()}init(){let e=662058;this.config.background&&(typeof this.config.background=="object"&&this.config.background.value?e=this.config.background.value:e=this.config.background),this.scene.background=new p.Color(e)}add(e){this.scene.add(e)}remove(e){this.scene.remove(e)}getScene(){return this.scene}dispose(){this.scene.clear()}}const ze={type:"change"},Be={type:"start"},He={type:"end"},ue=new l.Ray,Ke=new l.Plane,Nt=Math.cos(70*l.MathUtils.DEG2RAD),R=new l.Vector3,V=2*Math.PI,v={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},Ee=1e-6;class Vt extends l.Controls{constructor(e,t=null){super(e,t),this.state=v.NONE,this.target=new l.Vector3,this.cursor=new l.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:l.MOUSE.ROTATE,MIDDLE:l.MOUSE.DOLLY,RIGHT:l.MOUSE.PAN},this.touches={ONE:l.TOUCH.ROTATE,TWO:l.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new l.Vector3,this._lastQuaternion=new l.Quaternion,this._lastTargetPosition=new l.Vector3,this._quat=new l.Quaternion().setFromUnitVectors(e.up,new l.Vector3(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new l.Spherical,this._sphericalDelta=new l.Spherical,this._scale=1,this._panOffset=new l.Vector3,this._rotateStart=new l.Vector2,this._rotateEnd=new l.Vector2,this._rotateDelta=new l.Vector2,this._panStart=new l.Vector2,this._panEnd=new l.Vector2,this._panDelta=new l.Vector2,this._dollyStart=new l.Vector2,this._dollyEnd=new l.Vector2,this._dollyDelta=new l.Vector2,this._dollyDirection=new l.Vector3,this._mouse=new l.Vector2,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=qt.bind(this),this._onPointerDown=Ot.bind(this),this._onPointerUp=jt.bind(this),this._onContextMenu=Xt.bind(this),this._onMouseWheel=Kt.bind(this),this._onKeyDown=Yt.bind(this),this._onTouchStart=Jt.bind(this),this._onTouchMove=Wt.bind(this),this._onMouseDown=zt.bind(this),this._onMouseMove=Ht.bind(this),this._interceptControlDown=Zt.bind(this),this._interceptControlUp=$t.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(ze),this.update(),this.state=v.NONE}update(e=null){const t=this.object.position;R.copy(t).sub(this.target),R.applyQuaternion(this._quat),this._spherical.setFromVector3(R),this.autoRotate&&this.state===v.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let i=this.minAzimuthAngle,s=this.maxAzimuthAngle;isFinite(i)&&isFinite(s)&&(i<-Math.PI?i+=V:i>Math.PI&&(i-=V),s<-Math.PI?s+=V:s>Math.PI&&(s-=V),i<=s?this._spherical.theta=Math.max(i,Math.min(s,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(i+s)/2?Math.max(i,this._spherical.theta):Math.min(s,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let o=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const n=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),o=n!=this._spherical.radius}if(R.setFromSpherical(this._spherical),R.applyQuaternion(this._quatInverse),t.copy(this.target).add(R),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let n=null;if(this.object.isPerspectiveCamera){const a=R.length();n=this._clampDistance(a*this._scale);const r=a-n;this.object.position.addScaledVector(this._dollyDirection,r),this.object.updateMatrixWorld(),o=!!r}else if(this.object.isOrthographicCamera){const a=new l.Vector3(this._mouse.x,this._mouse.y,0);a.unproject(this.object);const r=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),o=r!==this.object.zoom;const A=new l.Vector3(this._mouse.x,this._mouse.y,0);A.unproject(this.object),this.object.position.sub(A).add(a),this.object.updateMatrixWorld(),n=R.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;n!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(n).add(this.object.position):(ue.origin.copy(this.object.position),ue.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(ue.direction))<Nt?this.object.lookAt(this.target):(Ke.setFromNormalAndCoplanarPoint(this.object.up,this.target),ue.intersectPlane(Ke,this.target))))}else if(this.object.isOrthographicCamera){const n=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),n!==this.object.zoom&&(this.object.updateProjectionMatrix(),o=!0)}return this._scale=1,this._performCursorZoom=!1,o||this._lastPosition.distanceToSquared(this.object.position)>Ee||8*(1-this._lastQuaternion.dot(this.object.quaternion))>Ee||this._lastTargetPosition.distanceToSquared(this.target)>Ee?(this.dispatchEvent(ze),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e!==null?V/60*this.autoRotateSpeed*e:V/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(e*.01);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){R.setFromMatrixColumn(t,0),R.multiplyScalar(-e),this._panOffset.add(R)}_panUp(e,t){this.screenSpacePanning===!0?R.setFromMatrixColumn(t,1):(R.setFromMatrixColumn(t,0),R.crossVectors(this.object.up,R)),R.multiplyScalar(e),this._panOffset.add(R)}_pan(e,t){const i=this.domElement;if(this.object.isPerspectiveCamera){const s=this.object.position;R.copy(s).sub(this.target);let o=R.length();o*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*o/i.clientHeight,this.object.matrix),this._panUp(2*t*o/i.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/i.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/i.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const i=this.domElement.getBoundingClientRect(),s=e-i.left,o=t-i.top,n=i.width,a=i.height;this._mouse.x=s/n*2-1,this._mouse.y=-(o/a)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(V*this._rotateDelta.x/t.clientHeight),this._rotateUp(V*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(V*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-V*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(V*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-V*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0;break}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),i=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._rotateStart.set(i,s)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),i=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._panStart.set(i,s)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),i=e.pageX-t.x,s=e.pageY-t.y,o=Math.sqrt(i*i+s*s);this._dollyStart.set(0,o)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{const i=this._getSecondPointerPosition(e),s=.5*(e.pageX+i.x),o=.5*(e.pageY+i.y);this._rotateEnd.set(s,o)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(V*this._rotateDelta.x/t.clientHeight),this._rotateUp(V*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),i=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._panEnd.set(i,s)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),i=e.pageX-t.x,s=e.pageY-t.y,o=Math.sqrt(i*i+s*s);this._dollyEnd.set(0,o),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const n=(e.pageX+t.x)*.5,a=(e.pageY+t.y)*.5;this._updateZoomParameters(n,a)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId){this._pointers.splice(t,1);return}}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new l.Vector2,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,i={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:i.deltaY*=16;break;case 2:i.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(i.deltaY*=10),i}}function Ot(c){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(c.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(c)&&(this._addPointer(c),c.pointerType==="touch"?this._onTouchStart(c):this._onMouseDown(c)))}function qt(c){this.enabled!==!1&&(c.pointerType==="touch"?this._onTouchMove(c):this._onMouseMove(c))}function jt(c){switch(this._removePointer(c),this._pointers.length){case 0:this.domElement.releasePointerCapture(c.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(He),this.state=v.NONE;break;case 1:const e=this._pointers[0],t=this._pointerPositions[e];this._onTouchStart({pointerId:e,pageX:t.x,pageY:t.y});break}}function zt(c){let e;switch(c.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case l.MOUSE.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(c),this.state=v.DOLLY;break;case l.MOUSE.ROTATE:if(c.ctrlKey||c.metaKey||c.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(c),this.state=v.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(c),this.state=v.ROTATE}break;case l.MOUSE.PAN:if(c.ctrlKey||c.metaKey||c.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(c),this.state=v.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(c),this.state=v.PAN}break;default:this.state=v.NONE}this.state!==v.NONE&&this.dispatchEvent(Be)}function Ht(c){switch(this.state){case v.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(c);break;case v.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(c);break;case v.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(c);break}}function Kt(c){this.enabled===!1||this.enableZoom===!1||this.state!==v.NONE||(c.preventDefault(),this.dispatchEvent(Be),this._handleMouseWheel(this._customWheelEvent(c)),this.dispatchEvent(He))}function Yt(c){this.enabled!==!1&&this._handleKeyDown(c)}function Jt(c){switch(this._trackPointer(c),this._pointers.length){case 1:switch(this.touches.ONE){case l.TOUCH.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(c),this.state=v.TOUCH_ROTATE;break;case l.TOUCH.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(c),this.state=v.TOUCH_PAN;break;default:this.state=v.NONE}break;case 2:switch(this.touches.TWO){case l.TOUCH.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(c),this.state=v.TOUCH_DOLLY_PAN;break;case l.TOUCH.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(c),this.state=v.TOUCH_DOLLY_ROTATE;break;default:this.state=v.NONE}break;default:this.state=v.NONE}this.state!==v.NONE&&this.dispatchEvent(Be)}function Wt(c){switch(this._trackPointer(c),this.state){case v.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(c),this.update();break;case v.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(c),this.update();break;case v.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(c),this.update();break;case v.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(c),this.update();break;default:this.state=v.NONE}}function Xt(c){this.enabled!==!1&&c.preventDefault()}function Zt(c){c.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function $t(c){c.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class Ye extends le{constructor(e={}){super(),this.config=e,this.camera=null,this.controls=null,this.focusAnimation=null,this.init()}init(){this.camera=new p.PerspectiveCamera(this.config.fov||65,window.innerWidth/window.innerHeight,this.config.near||.05,this.config.far||2e3);const e=this.config.position||{x:0,y:5,z:10};this.camera.position.set(e.x,e.y,e.z)}initControls(e){if(!this.controls){this.controls=new Vt(this.camera,e);const t=this.config.desktop||{};this.controls.enableDamping=t.enableDamping??!0,this.controls.dampingFactor=t.dampingFactor??.08,this.controls.maxDistance=t.maxDistance??100,this.controls.minDistance=t.minDistance??.5,this.controls.addEventListener("change",()=>{this.emit("change")})}}update(){this.controls&&this.controls.update()}setSize(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix()}getCamera(){return this.camera}getControls(){return this.controls}frameObject(e,t){const i=t*1.5;this.camera.position.set(e.x+i*.7,e.y+i*.5,e.z+i*.7),this.controls&&(this.controls.target.copy(e),this.controls.update())}focusOn(e,t=null){if(!this.controls)return;this.focusAnimation&&(cancelAnimationFrame(this.focusAnimation),this.focusAnimation=null);const i=this.controls.target.clone(),s=this.camera.position.clone(),o=s.clone().sub(i),n=e.clone().add(o),a=1e3,r=performance.now(),A=()=>{this.focusAnimation&&(cancelAnimationFrame(this.focusAnimation),this.focusAnimation=null,this.controls.removeEventListener("start",A))};this.controls.addEventListener("start",A,{once:!0});const h=()=>{const d=performance.now()-r,g=Math.min(d/a,1),u=1-Math.pow(1-g,3);this.controls.target.lerpVectors(i,e,u),this.camera.position.lerpVectors(s,n,u),g<1?this.focusAnimation=requestAnimationFrame(h):(this.focusAnimation=null,this.controls.removeEventListener("start",A),this.emit("focus-complete",{target:e,position:n}))};this.focusAnimation=requestAnimationFrame(h),this.emit("focus-start",{target:e,startPosition:s,newPosition:n})}dispose(){this.focusAnimation&&(cancelAnimationFrame(this.focusAnimation),this.focusAnimation=null),this.controls&&this.controls.dispose(),this.removeAllListeners()}}function Je(c,e){if(e===l.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),c;if(e===l.TriangleFanDrawMode||e===l.TriangleStripDrawMode){let t=c.getIndex();if(t===null){const n=[],a=c.getAttribute("position");if(a!==void 0){for(let r=0;r<a.count;r++)n.push(r);c.setIndex(n),t=c.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),c}const i=t.count-2,s=[];if(e===l.TriangleFanDrawMode)for(let n=1;n<=i;n++)s.push(t.getX(0)),s.push(t.getX(n)),s.push(t.getX(n+1));else for(let n=0;n<i;n++)n%2===0?(s.push(t.getX(n)),s.push(t.getX(n+1)),s.push(t.getX(n+2))):(s.push(t.getX(n+2)),s.push(t.getX(n+1)),s.push(t.getX(n)));s.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=c.clone();return o.setIndex(s),o.clearGroups(),o}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),c}class We extends l.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new oi(t)}),this.register(function(t){return new ni(t)}),this.register(function(t){return new ui(t)}),this.register(function(t){return new pi(t)}),this.register(function(t){return new mi(t)}),this.register(function(t){return new ri(t)}),this.register(function(t){return new Ai(t)}),this.register(function(t){return new li(t)}),this.register(function(t){return new ci(t)}),this.register(function(t){return new si(t)}),this.register(function(t){return new hi(t)}),this.register(function(t){return new ai(t)}),this.register(function(t){return new gi(t)}),this.register(function(t){return new di(t)}),this.register(function(t){return new ti(t)}),this.register(function(t){return new fi(t)}),this.register(function(t){return new bi(t)})}load(e,t,i,s){const o=this;let n;if(this.resourcePath!=="")n=this.resourcePath;else if(this.path!==""){const A=l.LoaderUtils.extractUrlBase(e);n=l.LoaderUtils.resolveURL(A,this.path)}else n=l.LoaderUtils.extractUrlBase(e);this.manager.itemStart(e);const a=function(A){s?s(A):console.error(A),o.manager.itemError(e),o.manager.itemEnd(e)},r=new l.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,function(A){try{o.parse(A,n,function(h){t(h),o.manager.itemEnd(e)},a)}catch(h){a(h)}},i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let o;const n={},a={},r=new TextDecoder;if(typeof e=="string")o=JSON.parse(e);else if(e instanceof ArrayBuffer)if(r.decode(new Uint8Array(e,0,4))===Xe){try{n[Q.KHR_BINARY_GLTF]=new Ci(e)}catch(d){s&&s(d);return}o=JSON.parse(n[Q.KHR_BINARY_GLTF].content)}else o=JSON.parse(r.decode(e));else o=e;if(o.asset===void 0||o.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const A=new Fi(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});A.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const d=this.pluginCallbacks[h](A);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[d.name]=d,n[d.name]=!0}if(o.extensionsUsed)for(let h=0;h<o.extensionsUsed.length;++h){const d=o.extensionsUsed[h],g=o.extensionsRequired||[];switch(d){case Q.KHR_MATERIALS_UNLIT:n[d]=new ii;break;case Q.KHR_DRACO_MESH_COMPRESSION:n[d]=new Ii(o,this.dracoLoader);break;case Q.KHR_TEXTURE_TRANSFORM:n[d]=new Bi;break;case Q.KHR_MESH_QUANTIZATION:n[d]=new Ei;break;default:g.indexOf(d)>=0&&a[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}A.setExtensions(n),A.setPlugins(a),A.parse(i,s)}parseAsync(e,t){const i=this;return new Promise(function(s,o){i.parse(e,t,s,o)})}}function ei(){let c={};return{get:function(e){return c[e]},add:function(e,t){c[e]=t},remove:function(e){delete c[e]},removeAll:function(){c={}}}}const Q={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ti{constructor(e){this.parser=e,this.name=Q.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,s=t.length;i<s;i++){const o=t[i];o.extensions&&o.extensions[this.name]&&o.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,o.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let s=t.cache.get(i);if(s)return s;const o=t.json,r=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let A;const h=new l.Color(16777215);r.color!==void 0&&h.setRGB(r.color[0],r.color[1],r.color[2],l.LinearSRGBColorSpace);const d=r.range!==void 0?r.range:0;switch(r.type){case"directional":A=new l.DirectionalLight(h),A.target.position.set(0,0,-1),A.add(A.target);break;case"point":A=new l.PointLight(h),A.distance=d;break;case"spot":A=new l.SpotLight(h),A.distance=d,r.spot=r.spot||{},r.spot.innerConeAngle=r.spot.innerConeAngle!==void 0?r.spot.innerConeAngle:0,r.spot.outerConeAngle=r.spot.outerConeAngle!==void 0?r.spot.outerConeAngle:Math.PI/4,A.angle=r.spot.outerConeAngle,A.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,A.target.position.set(0,0,-1),A.add(A.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return A.position.set(0,0,0),Z(A,r),r.intensity!==void 0&&(A.intensity=r.intensity),A.name=t.createUniqueName(r.name||"light_"+e),s=Promise.resolve(A),t.cache.add(i,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,o=i.json.nodes[e],a=(o.extensions&&o.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(r){return i._getNodeRef(t.cache,a,r)})}}class ii{constructor(){this.name=Q.KHR_MATERIALS_UNLIT}getMaterialType(){return l.MeshBasicMaterial}extendParams(e,t,i){const s=[];e.color=new l.Color(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const n=o.baseColorFactor;e.color.setRGB(n[0],n[1],n[2],l.LinearSRGBColorSpace),e.opacity=n[3]}o.baseColorTexture!==void 0&&s.push(i.assignTexture(e,"map",o.baseColorTexture,l.SRGBColorSpace))}return Promise.all(s)}}class si{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=s.extensions[this.name].emissiveStrength;return o!==void 0&&(t.emissiveIntensity=o),Promise.resolve()}}class oi{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],n=s.extensions[this.name];if(n.clearcoatFactor!==void 0&&(t.clearcoat=n.clearcoatFactor),n.clearcoatTexture!==void 0&&o.push(i.assignTexture(t,"clearcoatMap",n.clearcoatTexture)),n.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=n.clearcoatRoughnessFactor),n.clearcoatRoughnessTexture!==void 0&&o.push(i.assignTexture(t,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),n.clearcoatNormalTexture!==void 0&&(o.push(i.assignTexture(t,"clearcoatNormalMap",n.clearcoatNormalTexture)),n.clearcoatNormalTexture.scale!==void 0)){const a=n.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new l.Vector2(a,a)}return Promise.all(o)}}class ni{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_DISPERSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=s.extensions[this.name];return t.dispersion=o.dispersion!==void 0?o.dispersion:0,Promise.resolve()}}class ai{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],n=s.extensions[this.name];return n.iridescenceFactor!==void 0&&(t.iridescence=n.iridescenceFactor),n.iridescenceTexture!==void 0&&o.push(i.assignTexture(t,"iridescenceMap",n.iridescenceTexture)),n.iridescenceIor!==void 0&&(t.iridescenceIOR=n.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),n.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),n.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),n.iridescenceThicknessTexture!==void 0&&o.push(i.assignTexture(t,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(o)}}class ri{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_SHEEN}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[];t.sheenColor=new l.Color(0,0,0),t.sheenRoughness=0,t.sheen=1;const n=s.extensions[this.name];if(n.sheenColorFactor!==void 0){const a=n.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],l.LinearSRGBColorSpace)}return n.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=n.sheenRoughnessFactor),n.sheenColorTexture!==void 0&&o.push(i.assignTexture(t,"sheenColorMap",n.sheenColorTexture,l.SRGBColorSpace)),n.sheenRoughnessTexture!==void 0&&o.push(i.assignTexture(t,"sheenRoughnessMap",n.sheenRoughnessTexture)),Promise.all(o)}}class Ai{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],n=s.extensions[this.name];return n.transmissionFactor!==void 0&&(t.transmission=n.transmissionFactor),n.transmissionTexture!==void 0&&o.push(i.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(o)}}class li{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_VOLUME}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],n=s.extensions[this.name];t.thickness=n.thicknessFactor!==void 0?n.thicknessFactor:0,n.thicknessTexture!==void 0&&o.push(i.assignTexture(t,"thicknessMap",n.thicknessTexture)),t.attenuationDistance=n.attenuationDistance||1/0;const a=n.attenuationColor||[1,1,1];return t.attenuationColor=new l.Color().setRGB(a[0],a[1],a[2],l.LinearSRGBColorSpace),Promise.all(o)}}class ci{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_IOR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=s.extensions[this.name];return t.ior=o.ior!==void 0?o.ior:1.5,Promise.resolve()}}class hi{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_SPECULAR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],n=s.extensions[this.name];t.specularIntensity=n.specularFactor!==void 0?n.specularFactor:1,n.specularTexture!==void 0&&o.push(i.assignTexture(t,"specularIntensityMap",n.specularTexture));const a=n.specularColorFactor||[1,1,1];return t.specularColor=new l.Color().setRGB(a[0],a[1],a[2],l.LinearSRGBColorSpace),n.specularColorTexture!==void 0&&o.push(i.assignTexture(t,"specularColorMap",n.specularColorTexture,l.SRGBColorSpace)),Promise.all(o)}}class di{constructor(e){this.parser=e,this.name=Q.EXT_MATERIALS_BUMP}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],n=s.extensions[this.name];return t.bumpScale=n.bumpFactor!==void 0?n.bumpFactor:1,n.bumpTexture!==void 0&&o.push(i.assignTexture(t,"bumpMap",n.bumpTexture)),Promise.all(o)}}class gi{constructor(e){this.parser=e,this.name=Q.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:l.MeshPhysicalMaterial}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const o=[],n=s.extensions[this.name];return n.anisotropyStrength!==void 0&&(t.anisotropy=n.anisotropyStrength),n.anisotropyRotation!==void 0&&(t.anisotropyRotation=n.anisotropyRotation),n.anisotropyTexture!==void 0&&o.push(i.assignTexture(t,"anisotropyMap",n.anisotropyTexture)),Promise.all(o)}}class ui{constructor(e){this.parser=e,this.name=Q.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,s=i.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const o=s.extensions[this.name],n=t.options.ktx2Loader;if(!n){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o.source,n)}}class pi{constructor(e){this.parser=e,this.name=Q.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,i=this.parser,s=i.json,o=s.textures[e];if(!o.extensions||!o.extensions[t])return null;const n=o.extensions[t],a=s.images[n.source];let r=i.textureLoader;if(a.uri){const A=i.options.manager.getHandler(a.uri);A!==null&&(r=A)}return i.loadTextureImage(e,n.source,r)}}class mi{constructor(e){this.parser=e,this.name=Q.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,i=this.parser,s=i.json,o=s.textures[e];if(!o.extensions||!o.extensions[t])return null;const n=o.extensions[t],a=s.images[n.source];let r=i.textureLoader;if(a.uri){const A=i.options.manager.getHandler(a.uri);A!==null&&(r=A)}return i.loadTextureImage(e,n.source,r)}}class fi{constructor(e){this.name=Q.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const s=i.extensions[this.name],o=this.parser.getDependency("buffer",s.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return o.then(function(a){const r=s.byteOffset||0,A=s.byteLength||0,h=s.count,d=s.byteStride,g=new Uint8Array(a,r,A);return n.decodeGltfBufferAsync?n.decodeGltfBufferAsync(h,d,g,s.mode,s.filter).then(function(u){return u.buffer}):n.ready.then(function(){const u=new ArrayBuffer(h*d);return n.decodeGltfBuffer(new Uint8Array(u),h,d,g,s.mode,s.filter),u})})}else return null}}class bi{constructor(e){this.name=Q.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const s=t.meshes[i.mesh];for(const A of s.primitives)if(A.mode!==j.TRIANGLES&&A.mode!==j.TRIANGLE_STRIP&&A.mode!==j.TRIANGLE_FAN&&A.mode!==void 0)return null;const n=i.extensions[this.name].attributes,a=[],r={};for(const A in n)a.push(this.parser.getDependency("accessor",n[A]).then(h=>(r[A]=h,r[A])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(A=>{const h=A.pop(),d=h.isGroup?h.children:[h],g=A[0].count,u=[];for(const m of d){const I=new l.Matrix4,B=new l.Vector3,f=new l.Quaternion,b=new l.Vector3(1,1,1),E=new l.InstancedMesh(m.geometry,m.material,g);for(let C=0;C<g;C++)r.TRANSLATION&&B.fromBufferAttribute(r.TRANSLATION,C),r.ROTATION&&f.fromBufferAttribute(r.ROTATION,C),r.SCALE&&b.fromBufferAttribute(r.SCALE,C),E.setMatrixAt(C,I.compose(B,f,b));for(const C in r)if(C==="_COLOR_0"){const y=r[C];E.instanceColor=new l.InstancedBufferAttribute(y.array,y.itemSize,y.normalized)}else C!=="TRANSLATION"&&C!=="ROTATION"&&C!=="SCALE"&&m.geometry.setAttribute(C,r[C]);l.Object3D.prototype.copy.call(E,m),this.parser.assignFinalMaterial(E),u.push(E)}return h.isGroup?(h.clear(),h.add(...u),h):u[0]}))}}const Xe="glTF",ce=12,Ze={JSON:1313821514,BIN:5130562};class Ci{constructor(e){this.name=Q.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,ce),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Xe)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-ce,o=new DataView(e,ce);let n=0;for(;n<s;){const a=o.getUint32(n,!0);n+=4;const r=o.getUint32(n,!0);if(n+=4,r===Ze.JSON){const A=new Uint8Array(e,ce+n,a);this.content=i.decode(A)}else if(r===Ze.BIN){const A=ce+n;this.body=e.slice(A,A+a)}n+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ii{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Q.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,s=this.dracoLoader,o=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,a={},r={},A={};for(const h in n){const d=we[h]||h.toLowerCase();a[d]=n[h]}for(const h in e.attributes){const d=we[h]||h.toLowerCase();if(n[h]!==void 0){const g=i.accessors[e.attributes[h]],u=oe[g.componentType];A[d]=u.name,r[d]=g.normalized===!0}}return t.getDependency("bufferView",o).then(function(h){return new Promise(function(d,g){s.decodeDracoFile(h,function(u){for(const m in u.attributes){const I=u.attributes[m],B=r[m];B!==void 0&&(I.normalized=B)}d(u)},a,A,l.LinearSRGBColorSpace,g)})})}}class Bi{constructor(){this.name=Q.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ei{constructor(){this.name=Q.KHR_MESH_QUANTIZATION}}class $e extends l.Interpolant{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,o=e*s*3+s;for(let n=0;n!==s;n++)t[n]=i[o+n];return t}interpolate_(e,t,i,s){const o=this.resultBuffer,n=this.sampleValues,a=this.valueSize,r=a*2,A=a*3,h=s-t,d=(i-t)/h,g=d*d,u=g*d,m=e*A,I=m-A,B=-2*u+3*g,f=u-g,b=1-B,E=f-g+d;for(let C=0;C!==a;C++){const y=n[I+C+a],w=n[I+C+r]*h,S=n[m+C+a],k=n[m+C]*h;o[C]=b*y+E*w+B*S+f*k}return o}}const yi=new l.Quaternion;class wi extends $e{interpolate_(e,t,i,s){const o=super.interpolate_(e,t,i,s);return yi.fromArray(o).normalize().toArray(o),o}}const j={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},oe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},et={9728:l.NearestFilter,9729:l.LinearFilter,9984:l.NearestMipmapNearestFilter,9985:l.LinearMipmapNearestFilter,9986:l.NearestMipmapLinearFilter,9987:l.LinearMipmapLinearFilter},tt={33071:l.ClampToEdgeWrapping,33648:l.MirroredRepeatWrapping,10497:l.RepeatWrapping},ye={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},we={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ee={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Si={CUBICSPLINE:void 0,LINEAR:l.InterpolateLinear,STEP:l.InterpolateDiscrete},Se={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Qi(c){return c.DefaultMaterial===void 0&&(c.DefaultMaterial=new l.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:l.FrontSide})),c.DefaultMaterial}function ie(c,e,t){for(const i in t.extensions)c[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function Z(c,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(c.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Mi(c,e,t){let i=!1,s=!1,o=!1;for(let A=0,h=e.length;A<h;A++){const d=e[A];if(d.POSITION!==void 0&&(i=!0),d.NORMAL!==void 0&&(s=!0),d.COLOR_0!==void 0&&(o=!0),i&&s&&o)break}if(!i&&!s&&!o)return Promise.resolve(c);const n=[],a=[],r=[];for(let A=0,h=e.length;A<h;A++){const d=e[A];if(i){const g=d.POSITION!==void 0?t.getDependency("accessor",d.POSITION):c.attributes.position;n.push(g)}if(s){const g=d.NORMAL!==void 0?t.getDependency("accessor",d.NORMAL):c.attributes.normal;a.push(g)}if(o){const g=d.COLOR_0!==void 0?t.getDependency("accessor",d.COLOR_0):c.attributes.color;r.push(g)}}return Promise.all([Promise.all(n),Promise.all(a),Promise.all(r)]).then(function(A){const h=A[0],d=A[1],g=A[2];return i&&(c.morphAttributes.position=h),s&&(c.morphAttributes.normal=d),o&&(c.morphAttributes.color=g),c.morphTargetsRelative=!0,c})}function vi(c,e){if(c.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)c.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(c.morphTargetInfluences.length===t.length){c.morphTargetDictionary={};for(let i=0,s=t.length;i<s;i++)c.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function xi(c){let e;const t=c.extensions&&c.extensions[Q.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Qe(t.attributes):e=c.indices+":"+Qe(c.attributes)+":"+c.mode,c.targets!==void 0)for(let i=0,s=c.targets.length;i<s;i++)e+=":"+Qe(c.targets[i]);return e}function Qe(c){let e="";const t=Object.keys(c).sort();for(let i=0,s=t.length;i<s;i++)e+=t[i]+":"+c[t[i]]+";";return e}function Me(c){switch(c){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Di(c){return c.search(/\.jpe?g($|\?)/i)>0||c.search(/^data\:image\/jpeg/)===0?"image/jpeg":c.search(/\.webp($|\?)/i)>0||c.search(/^data\:image\/webp/)===0?"image/webp":c.search(/\.ktx2($|\?)/i)>0||c.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Li=new l.Matrix4;class Fi{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ei,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,s=-1,o=!1,n=-1;if(typeof navigator<"u"){const a=navigator.userAgent;i=/^((?!chrome|android).)*safari/i.test(a)===!0;const r=a.match(/Version\/(\d+)/);s=i&&r?parseInt(r[1],10):-1,o=a.indexOf("Firefox")>-1,n=o?a.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||i&&s<17||o&&n<98?this.textureLoader=new l.TextureLoader(this.options.manager):this.textureLoader=new l.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new l.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,s=this.json,o=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(n){return n._markDefs&&n._markDefs()}),Promise.all(this._invokeAll(function(n){return n.beforeRoot&&n.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(n){const a={scene:n[0][s.scene||0],scenes:n[0],animations:n[1],cameras:n[2],asset:s.asset,parser:i,userData:{}};return ie(o,a,s),Z(a,s),Promise.all(i._invokeAll(function(r){return r.afterRoot&&r.afterRoot(a)})).then(function(){for(const r of a.scenes)r.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let s=0,o=t.length;s<o;s++){const n=t[s].joints;for(let a=0,r=n.length;a<r;a++)e[n[a]].isBone=!0}for(let s=0,o=e.length;s<o;s++){const n=e[s];n.mesh!==void 0&&(this._addNodeRef(this.meshCache,n.mesh),n.skin!==void 0&&(i[n.mesh].isSkinnedMesh=!0)),n.camera!==void 0&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const s=i.clone(),o=(n,a)=>{const r=this.associations.get(n);r!=null&&this.associations.set(a,r);for(const[A,h]of n.children.entries())o(h,a.children[A])};return o(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let s=0;s<t.length;s++){const o=e(t[s]);o&&i.push(o)}return i}getDependency(e,t){const i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(o){return o.loadNode&&o.loadNode(t)});break;case"mesh":s=this._invokeOne(function(o){return o.loadMesh&&o.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(o){return o.loadBufferView&&o.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(o){return o.loadMaterial&&o.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(o){return o.loadTexture&&o.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(o){return o.loadAnimation&&o.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(o){return o!=this&&o.getDependency&&o.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(i,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(o,n){return i.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[Q.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(o,n){i.load(l.LoaderUtils.resolveURL(t.uri,s.path),o,void 0,function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const s=t.byteLength||0,o=t.byteOffset||0;return i.slice(o,o+s)})}loadAccessor(e){const t=this,i=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const n=ye[s.type],a=oe[s.componentType],r=s.normalized===!0,A=new a(s.count*n);return Promise.resolve(new l.BufferAttribute(A,n,r))}const o=[];return s.bufferView!==void 0?o.push(this.getDependency("bufferView",s.bufferView)):o.push(null),s.sparse!==void 0&&(o.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(o).then(function(n){const a=n[0],r=ye[s.type],A=oe[s.componentType],h=A.BYTES_PER_ELEMENT,d=h*r,g=s.byteOffset||0,u=s.bufferView!==void 0?i.bufferViews[s.bufferView].byteStride:void 0,m=s.normalized===!0;let I,B;if(u&&u!==d){const f=Math.floor(g/u),b="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+f+":"+s.count;let E=t.cache.get(b);E||(I=new A(a,f*u,s.count*u/h),E=new l.InterleavedBuffer(I,u/h),t.cache.add(b,E)),B=new l.InterleavedBufferAttribute(E,r,g%u/h,m)}else a===null?I=new A(s.count*r):I=new A(a,g,s.count*r),B=new l.BufferAttribute(I,r,m);if(s.sparse!==void 0){const f=ye.SCALAR,b=oe[s.sparse.indices.componentType],E=s.sparse.indices.byteOffset||0,C=s.sparse.values.byteOffset||0,y=new b(n[1],E,s.sparse.count*f),w=new A(n[2],C,s.sparse.count*r);a!==null&&(B=new l.BufferAttribute(B.array.slice(),B.itemSize,B.normalized)),B.normalized=!1;for(let S=0,k=y.length;S<k;S++){const F=y[S];if(B.setX(F,w[S*r]),r>=2&&B.setY(F,w[S*r+1]),r>=3&&B.setZ(F,w[S*r+2]),r>=4&&B.setW(F,w[S*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}B.normalized=m}return B})}loadTexture(e){const t=this.json,i=this.options,o=t.textures[e].source,n=t.images[o];let a=this.textureLoader;if(n.uri){const r=i.manager.getHandler(n.uri);r!==null&&(a=r)}return this.loadTextureImage(e,o,a)}loadTextureImage(e,t,i){const s=this,o=this.json,n=o.textures[e],a=o.images[t],r=(a.uri||a.bufferView)+":"+n.sampler;if(this.textureCache[r])return this.textureCache[r];const A=this.loadImageSource(t,i).then(function(h){h.flipY=!1,h.name=n.name||a.name||"",h.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(h.name=a.uri);const g=(o.samplers||{})[n.sampler]||{};return h.magFilter=et[g.magFilter]||l.LinearFilter,h.minFilter=et[g.minFilter]||l.LinearMipmapLinearFilter,h.wrapS=tt[g.wrapS]||l.RepeatWrapping,h.wrapT=tt[g.wrapT]||l.RepeatWrapping,h.generateMipmaps=!h.isCompressedTexture&&h.minFilter!==l.NearestFilter&&h.minFilter!==l.LinearFilter,s.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[r]=A,A}loadImageSource(e,t){const i=this,s=this.json,o=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(d=>d.clone());const n=s.images[e],a=self.URL||self.webkitURL;let r=n.uri||"",A=!1;if(n.bufferView!==void 0)r=i.getDependency("bufferView",n.bufferView).then(function(d){A=!0;const g=new Blob([d],{type:n.mimeType});return r=a.createObjectURL(g),r});else if(n.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(r).then(function(d){return new Promise(function(g,u){let m=g;t.isImageBitmapLoader===!0&&(m=function(I){const B=new l.Texture(I);B.needsUpdate=!0,g(B)}),t.load(l.LoaderUtils.resolveURL(d,o.path),m,void 0,u)})}).then(function(d){return A===!0&&a.revokeObjectURL(r),Z(d,n),d.userData.mimeType=n.mimeType||Di(n.uri),d}).catch(function(d){throw console.error("THREE.GLTFLoader: Couldn't load texture",r),d});return this.sourceCache[e]=h,h}assignTexture(e,t,i,s){const o=this;return this.getDependency("texture",i.index).then(function(n){if(!n)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(n=n.clone(),n.channel=i.texCoord),o.extensions[Q.KHR_TEXTURE_TRANSFORM]){const a=i.extensions!==void 0?i.extensions[Q.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const r=o.associations.get(n);n=o.extensions[Q.KHR_TEXTURE_TRANSFORM].extendTexture(n,a),o.associations.set(n,r)}}return s!==void 0&&(n.colorSpace=s),e[t]=n,n})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const s=t.attributes.tangent===void 0,o=t.attributes.color!==void 0,n=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+i.uuid;let r=this.cache.get(a);r||(r=new l.PointsMaterial,l.Material.prototype.copy.call(r,i),r.color.copy(i.color),r.map=i.map,r.sizeAttenuation=!1,this.cache.add(a,r)),i=r}else if(e.isLine){const a="LineBasicMaterial:"+i.uuid;let r=this.cache.get(a);r||(r=new l.LineBasicMaterial,l.Material.prototype.copy.call(r,i),r.color.copy(i.color),r.map=i.map,this.cache.add(a,r)),i=r}if(s||o||n){let a="ClonedMaterial:"+i.uuid+":";s&&(a+="derivative-tangents:"),o&&(a+="vertex-colors:"),n&&(a+="flat-shading:");let r=this.cache.get(a);r||(r=i.clone(),o&&(r.vertexColors=!0),n&&(r.flatShading=!0),s&&(r.normalScale&&(r.normalScale.y*=-1),r.clearcoatNormalScale&&(r.clearcoatNormalScale.y*=-1)),this.cache.add(a,r),this.associations.set(r,this.associations.get(i))),i=r}e.material=i}getMaterialType(){return l.MeshStandardMaterial}loadMaterial(e){const t=this,i=this.json,s=this.extensions,o=i.materials[e];let n;const a={},r=o.extensions||{},A=[];if(r[Q.KHR_MATERIALS_UNLIT]){const d=s[Q.KHR_MATERIALS_UNLIT];n=d.getMaterialType(),A.push(d.extendParams(a,o,t))}else{const d=o.pbrMetallicRoughness||{};if(a.color=new l.Color(1,1,1),a.opacity=1,Array.isArray(d.baseColorFactor)){const g=d.baseColorFactor;a.color.setRGB(g[0],g[1],g[2],l.LinearSRGBColorSpace),a.opacity=g[3]}d.baseColorTexture!==void 0&&A.push(t.assignTexture(a,"map",d.baseColorTexture,l.SRGBColorSpace)),a.metalness=d.metallicFactor!==void 0?d.metallicFactor:1,a.roughness=d.roughnessFactor!==void 0?d.roughnessFactor:1,d.metallicRoughnessTexture!==void 0&&(A.push(t.assignTexture(a,"metalnessMap",d.metallicRoughnessTexture)),A.push(t.assignTexture(a,"roughnessMap",d.metallicRoughnessTexture))),n=this._invokeOne(function(g){return g.getMaterialType&&g.getMaterialType(e)}),A.push(Promise.all(this._invokeAll(function(g){return g.extendMaterialParams&&g.extendMaterialParams(e,a)})))}o.doubleSided===!0&&(a.side=l.DoubleSide);const h=o.alphaMode||Se.OPAQUE;if(h===Se.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===Se.MASK&&(a.alphaTest=o.alphaCutoff!==void 0?o.alphaCutoff:.5)),o.normalTexture!==void 0&&n!==l.MeshBasicMaterial&&(A.push(t.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new l.Vector2(1,1),o.normalTexture.scale!==void 0)){const d=o.normalTexture.scale;a.normalScale.set(d,d)}if(o.occlusionTexture!==void 0&&n!==l.MeshBasicMaterial&&(A.push(t.assignTexture(a,"aoMap",o.occlusionTexture)),o.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=o.occlusionTexture.strength)),o.emissiveFactor!==void 0&&n!==l.MeshBasicMaterial){const d=o.emissiveFactor;a.emissive=new l.Color().setRGB(d[0],d[1],d[2],l.LinearSRGBColorSpace)}return o.emissiveTexture!==void 0&&n!==l.MeshBasicMaterial&&A.push(t.assignTexture(a,"emissiveMap",o.emissiveTexture,l.SRGBColorSpace)),Promise.all(A).then(function(){const d=new n(a);return o.name&&(d.name=o.name),Z(d,o),t.associations.set(d,{materials:e}),o.extensions&&ie(s,d,o),d})}createUniqueName(e){const t=l.PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,s=this.primitiveCache;function o(a){return i[Q.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(r){return it(r,a,t)})}const n=[];for(let a=0,r=e.length;a<r;a++){const A=e[a],h=xi(A),d=s[h];if(d)n.push(d.promise);else{let g;A.extensions&&A.extensions[Q.KHR_DRACO_MESH_COMPRESSION]?g=o(A):g=it(new l.BufferGeometry,A,t),s[h]={primitive:A,promise:g},n.push(g)}}return Promise.all(n)}loadMesh(e){const t=this,i=this.json,s=this.extensions,o=i.meshes[e],n=o.primitives,a=[];for(let r=0,A=n.length;r<A;r++){const h=n[r].material===void 0?Qi(this.cache):this.getDependency("material",n[r].material);a.push(h)}return a.push(t.loadGeometries(n)),Promise.all(a).then(function(r){const A=r.slice(0,r.length-1),h=r[r.length-1],d=[];for(let u=0,m=h.length;u<m;u++){const I=h[u],B=n[u];let f;const b=A[u];if(B.mode===j.TRIANGLES||B.mode===j.TRIANGLE_STRIP||B.mode===j.TRIANGLE_FAN||B.mode===void 0)f=o.isSkinnedMesh===!0?new l.SkinnedMesh(I,b):new l.Mesh(I,b),f.isSkinnedMesh===!0&&f.normalizeSkinWeights(),B.mode===j.TRIANGLE_STRIP?f.geometry=Je(f.geometry,l.TriangleStripDrawMode):B.mode===j.TRIANGLE_FAN&&(f.geometry=Je(f.geometry,l.TriangleFanDrawMode));else if(B.mode===j.LINES)f=new l.LineSegments(I,b);else if(B.mode===j.LINE_STRIP)f=new l.Line(I,b);else if(B.mode===j.LINE_LOOP)f=new l.LineLoop(I,b);else if(B.mode===j.POINTS)f=new l.Points(I,b);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+B.mode);Object.keys(f.geometry.morphAttributes).length>0&&vi(f,o),f.name=t.createUniqueName(o.name||"mesh_"+e),Z(f,o),B.extensions&&ie(s,f,B),t.assignFinalMaterial(f),d.push(f)}for(let u=0,m=d.length;u<m;u++)t.associations.set(d[u],{meshes:e,primitives:u});if(d.length===1)return o.extensions&&ie(s,d[0],o),d[0];const g=new l.Group;o.extensions&&ie(s,g,o),t.associations.set(g,{meshes:e});for(let u=0,m=d.length;u<m;u++)g.add(d[u]);return g})}loadCamera(e){let t;const i=this.json.cameras[e],s=i[i.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new l.PerspectiveCamera(l.MathUtils.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):i.type==="orthographic"&&(t=new l.OrthographicCamera(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),Z(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let s=0,o=t.joints.length;s<o;s++)i.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(s){const o=s.pop(),n=s,a=[],r=[];for(let A=0,h=n.length;A<h;A++){const d=n[A];if(d){a.push(d);const g=new l.Matrix4;o!==null&&g.fromArray(o.array,A*16),r.push(g)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[A])}return new l.Skeleton(a,r)})}loadAnimation(e){const t=this.json,i=this,s=t.animations[e],o=s.name?s.name:"animation_"+e,n=[],a=[],r=[],A=[],h=[];for(let d=0,g=s.channels.length;d<g;d++){const u=s.channels[d],m=s.samplers[u.sampler],I=u.target,B=I.node,f=s.parameters!==void 0?s.parameters[m.input]:m.input,b=s.parameters!==void 0?s.parameters[m.output]:m.output;I.node!==void 0&&(n.push(this.getDependency("node",B)),a.push(this.getDependency("accessor",f)),r.push(this.getDependency("accessor",b)),A.push(m),h.push(I))}return Promise.all([Promise.all(n),Promise.all(a),Promise.all(r),Promise.all(A),Promise.all(h)]).then(function(d){const g=d[0],u=d[1],m=d[2],I=d[3],B=d[4],f=[];for(let b=0,E=g.length;b<E;b++){const C=g[b],y=u[b],w=m[b],S=I[b],k=B[b];if(C===void 0)continue;C.updateMatrix&&C.updateMatrix();const F=i._createAnimationTracks(C,y,w,S,k);if(F)for(let M=0;M<F.length;M++)f.push(F[M])}return new l.AnimationClip(o,void 0,f)})}createNodeMesh(e){const t=this.json,i=this,s=t.nodes[e];return s.mesh===void 0?null:i.getDependency("mesh",s.mesh).then(function(o){const n=i._getNodeRef(i.meshCache,s.mesh,o);return s.weights!==void 0&&n.traverse(function(a){if(a.isMesh)for(let r=0,A=s.weights.length;r<A;r++)a.morphTargetInfluences[r]=s.weights[r]}),n})}loadNode(e){const t=this.json,i=this,s=t.nodes[e],o=i._loadNodeShallow(e),n=[],a=s.children||[];for(let A=0,h=a.length;A<h;A++)n.push(i.getDependency("node",a[A]));const r=s.skin===void 0?Promise.resolve(null):i.getDependency("skin",s.skin);return Promise.all([o,Promise.all(n),r]).then(function(A){const h=A[0],d=A[1],g=A[2];g!==null&&h.traverse(function(u){u.isSkinnedMesh&&u.bind(g,Li)});for(let u=0,m=d.length;u<m;u++)h.add(d[u]);return h})}_loadNodeShallow(e){const t=this.json,i=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const o=t.nodes[e],n=o.name?s.createUniqueName(o.name):"",a=[],r=s._invokeOne(function(A){return A.createNodeMesh&&A.createNodeMesh(e)});return r&&a.push(r),o.camera!==void 0&&a.push(s.getDependency("camera",o.camera).then(function(A){return s._getNodeRef(s.cameraCache,o.camera,A)})),s._invokeAll(function(A){return A.createNodeAttachment&&A.createNodeAttachment(e)}).forEach(function(A){a.push(A)}),this.nodeCache[e]=Promise.all(a).then(function(A){let h;if(o.isBone===!0?h=new l.Bone:A.length>1?h=new l.Group:A.length===1?h=A[0]:h=new l.Object3D,h!==A[0])for(let d=0,g=A.length;d<g;d++)h.add(A[d]);if(o.name&&(h.userData.name=o.name,h.name=n),Z(h,o),o.extensions&&ie(i,h,o),o.matrix!==void 0){const d=new l.Matrix4;d.fromArray(o.matrix),h.applyMatrix4(d)}else o.translation!==void 0&&h.position.fromArray(o.translation),o.rotation!==void 0&&h.quaternion.fromArray(o.rotation),o.scale!==void 0&&h.scale.fromArray(o.scale);if(!s.associations.has(h))s.associations.set(h,{});else if(o.mesh!==void 0&&s.meshCache.refs[o.mesh]>1){const d=s.associations.get(h);s.associations.set(h,{...d})}return s.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],s=this,o=new l.Group;i.name&&(o.name=s.createUniqueName(i.name)),Z(o,i),i.extensions&&ie(t,o,i);const n=i.nodes||[],a=[];for(let r=0,A=n.length;r<A;r++)a.push(s.getDependency("node",n[r]));return Promise.all(a).then(function(r){for(let h=0,d=r.length;h<d;h++)o.add(r[h]);const A=h=>{const d=new Map;for(const[g,u]of s.associations)(g instanceof l.Material||g instanceof l.Texture)&&d.set(g,u);return h.traverse(g=>{const u=s.associations.get(g);u!=null&&d.set(g,u)}),d};return s.associations=A(o),o})}_createAnimationTracks(e,t,i,s,o){const n=[],a=e.name?e.name:e.uuid,r=[];ee[o.path]===ee.weights?e.traverse(function(g){g.morphTargetInfluences&&r.push(g.name?g.name:g.uuid)}):r.push(a);let A;switch(ee[o.path]){case ee.weights:A=l.NumberKeyframeTrack;break;case ee.rotation:A=l.QuaternionKeyframeTrack;break;case ee.translation:case ee.scale:A=l.VectorKeyframeTrack;break;default:switch(i.itemSize){case 1:A=l.NumberKeyframeTrack;break;case 2:case 3:default:A=l.VectorKeyframeTrack;break}break}const h=s.interpolation!==void 0?Si[s.interpolation]:l.InterpolateLinear,d=this._getArrayFromAccessor(i);for(let g=0,u=r.length;g<u;g++){const m=new A(r[g]+"."+ee[o.path],t.array,d,h);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(m),n.push(m)}return n}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=Me(t.constructor),s=new Float32Array(t.length);for(let o=0,n=t.length;o<n;o++)s[o]=t[o]*i;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const s=this instanceof l.QuaternionKeyframeTrack?wi:$e;return new s(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ki(c,e,t){const i=e.attributes,s=new l.Box3;if(i.POSITION!==void 0){const a=t.json.accessors[i.POSITION],r=a.min,A=a.max;if(r!==void 0&&A!==void 0){if(s.set(new l.Vector3(r[0],r[1],r[2]),new l.Vector3(A[0],A[1],A[2])),a.normalized){const h=Me(oe[a.componentType]);s.min.multiplyScalar(h),s.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const o=e.targets;if(o!==void 0){const a=new l.Vector3,r=new l.Vector3;for(let A=0,h=o.length;A<h;A++){const d=o[A];if(d.POSITION!==void 0){const g=t.json.accessors[d.POSITION],u=g.min,m=g.max;if(u!==void 0&&m!==void 0){if(r.setX(Math.max(Math.abs(u[0]),Math.abs(m[0]))),r.setY(Math.max(Math.abs(u[1]),Math.abs(m[1]))),r.setZ(Math.max(Math.abs(u[2]),Math.abs(m[2]))),g.normalized){const I=Me(oe[g.componentType]);r.multiplyScalar(I)}a.max(r)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(a)}c.boundingBox=s;const n=new l.Sphere;s.getCenter(n.center),n.radius=s.min.distanceTo(s.max)/2,c.boundingSphere=n}function it(c,e,t){const i=e.attributes,s=[];function o(n,a){return t.getDependency("accessor",n).then(function(r){c.setAttribute(a,r)})}for(const n in i){const a=we[n]||n.toLowerCase();a in c.attributes||s.push(o(i[n],a))}if(e.indices!==void 0&&!c.index){const n=t.getDependency("accessor",e.indices).then(function(a){c.setIndex(a)});s.push(n)}return l.ColorManagement.workingColorSpace!==l.LinearSRGBColorSpace&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${l.ColorManagement.workingColorSpace}" not supported.`),Z(c,e),ki(c,e,t),Promise.all(s).then(function(){return e.targets!==void 0?Mi(c,e.targets,t):c})}const ve=new WeakMap;class Ri extends l.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,s){const o=new l.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,n=>{this.parse(n,t,s)},i,s)}parse(e,t,i=()=>{}){this.decodeDracoFile(e,t,null,null,l.SRGBColorSpace,i).catch(i)}decodeDracoFile(e,t,i,s,o=l.LinearSRGBColorSpace,n=()=>{}){const a={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:o};return this.decodeGeometry(e,a).then(t).catch(n)}decodeGeometry(e,t){const i=JSON.stringify(t);if(ve.has(e)){const r=ve.get(e);if(r.key===i)return r.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const o=this.workerNextTaskID++,n=e.byteLength,a=this._getWorker(o,n).then(r=>(s=r,new Promise((A,h)=>{s._callbacks[o]={resolve:A,reject:h},s.postMessage({type:"decode",id:o,taskConfig:t,buffer:e},[e])}))).then(r=>this._createGeometry(r.geometry));return a.catch(()=>!0).then(()=>{s&&o&&this._releaseTask(s,o)}),ve.set(e,{key:i,promise:a}),a}_createGeometry(e){const t=new l.BufferGeometry;e.index&&t.setIndex(new l.BufferAttribute(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const s=e.attributes[i],o=s.name,n=s.array,a=s.itemSize,r=new l.BufferAttribute(n,a);o==="color"&&(this._assignVertexColorSpace(r,s.vertexColorSpace),r.normalized=!(n instanceof Float32Array)),t.setAttribute(o,r)}return t}_assignVertexColorSpace(e,t){if(t!==l.SRGBColorSpace)return;const i=new l.Color;for(let s=0,o=e.count;s<o;s++)i.fromBufferAttribute(e,s),l.ColorManagement.colorSpaceToWorking(i,l.SRGBColorSpace),e.setXYZ(s,i.r,i.g,i.b)}_loadLibrary(e,t){const i=new l.FileLoader(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise((s,o)=>{i.load(e,s,void 0,o)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(i=>{const s=i[0];e||(this.decoderConfig.wasmBinary=i[1]);const o=Ti.toString(),n=["/* draco decoder */",s,"","/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([n]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(o){const n=o.data;switch(n.type){case"decode":s._callbacks[n.id].resolve(n);break;case"error":s._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,o){return s._taskLoad>o._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function Ti(){let c,e;onmessage=function(n){const a=n.data;switch(a.type){case"init":c=a.decoderConfig,e=new Promise(function(h){c.onModuleLoaded=function(d){h({draco:d})},DracoDecoderModule(c)});break;case"decode":const r=a.buffer,A=a.taskConfig;e.then(h=>{const d=h.draco,g=new d.Decoder;try{const u=t(d,g,new Int8Array(r),A),m=u.attributes.map(I=>I.array.buffer);u.index&&m.push(u.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:u},m)}catch(u){console.error(u),self.postMessage({type:"error",id:a.id,error:u.message})}finally{d.destroy(g)}});break}};function t(n,a,r,A){const h=A.attributeIDs,d=A.attributeTypes;let g,u;const m=a.GetEncodedGeometryType(r);if(m===n.TRIANGULAR_MESH)g=new n.Mesh,u=a.DecodeArrayToMesh(r,r.byteLength,g);else if(m===n.POINT_CLOUD)g=new n.PointCloud,u=a.DecodeArrayToPointCloud(r,r.byteLength,g);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!u.ok()||g.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+u.error_msg());const I={index:null,attributes:[]};for(const B in h){const f=self[d[B]];let b,E;if(A.useUniqueIDs)E=h[B],b=a.GetAttributeByUniqueId(g,E);else{if(E=a.GetAttributeId(g,n[h[B]]),E===-1)continue;b=a.GetAttribute(g,E)}const C=s(n,a,g,B,f,b);B==="color"&&(C.vertexColorSpace=A.vertexColorSpace),I.attributes.push(C)}return m===n.TRIANGULAR_MESH&&(I.index=i(n,a,g)),n.destroy(g),I}function i(n,a,r){const h=r.num_faces()*3,d=h*4,g=n._malloc(d);a.GetTrianglesUInt32Array(r,d,g);const u=new Uint32Array(n.HEAPF32.buffer,g,h).slice();return n._free(g),{array:u,itemSize:1}}function s(n,a,r,A,h,d){const g=d.num_components(),m=r.num_points()*g,I=m*h.BYTES_PER_ELEMENT,B=o(n,h),f=n._malloc(I);a.GetAttributeDataArrayForAllPoints(r,d,B,I,f);const b=new h(n.HEAPF32.buffer,f,m).slice();return n._free(f),{name:A,array:b,itemSize:g}}function o(n,a){switch(a){case Float32Array:return n.DT_FLOAT32;case Int8Array:return n.DT_INT8;case Int16Array:return n.DT_INT16;case Int32Array:return n.DT_INT32;case Uint8Array:return n.DT_UINT8;case Uint16Array:return n.DT_UINT16;case Uint32Array:return n.DT_UINT32}}}class _i{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0,this.workerCreator=null}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:s,msg:o,transfer:n}=this.queue.shift();this.workersResolve[e]=s,this.workers[e].postMessage(o,n)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(i=>{const s=this._getIdleWorker();s!==-1?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=i,this.workers[s].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const Gi=0,st=2,Pi=1,ot=2,Ui=0,Ni=1,Vi=10,Oi=0,nt=9,at=15,rt=16,At=22,lt=37,ct=43,ht=76,dt=83,gt=97,ut=100,pt=103,mt=109,qi=131,ji=132,zi=133,Hi=134,Ki=137,Yi=138,Ji=141,Wi=142,Xi=145,Zi=146,ft=148,bt=152,$i=157,es=158,Ct=165,It=166,xe=1000066e3;class ts{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class he{constructor(e,t,i,s){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,i),this._littleEndian=s,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+4294967296*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){t===void 0&&(t=0);const i=this._offset;let s=0;for(;this._dataView.getUint8(this._offset)!==t&&s<e;)s++,this._offset++;return s<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,s)}}const N=[171,75,84,88,32,50,48,187,13,10,26,10];function Bt(c){return new TextDecoder().decode(c)}function is(c){const e=new Uint8Array(c.buffer,c.byteOffset,N.length);if(e[0]!==N[0]||e[1]!==N[1]||e[2]!==N[2]||e[3]!==N[3]||e[4]!==N[4]||e[5]!==N[5]||e[6]!==N[6]||e[7]!==N[7]||e[8]!==N[8]||e[9]!==N[9]||e[10]!==N[10]||e[11]!==N[11])throw new Error("Missing KTX 2.0 identifier.");const t=new ts,i=17*Uint32Array.BYTES_PER_ELEMENT,s=new he(c,N.length,i,!0);t.vkFormat=s._nextUint32(),t.typeSize=s._nextUint32(),t.pixelWidth=s._nextUint32(),t.pixelHeight=s._nextUint32(),t.pixelDepth=s._nextUint32(),t.layerCount=s._nextUint32(),t.faceCount=s._nextUint32();const o=s._nextUint32();t.supercompressionScheme=s._nextUint32();const n=s._nextUint32(),a=s._nextUint32(),r=s._nextUint32(),A=s._nextUint32(),h=s._nextUint64(),d=s._nextUint64(),g=new he(c,N.length+i,3*o*8,!0);for(let T=0;T<o;T++)t.levels.push({levelData:new Uint8Array(c.buffer,c.byteOffset+g._nextUint64(),g._nextUint64()),uncompressedByteLength:g._nextUint64()});const u=new he(c,n,a,!0),m={vendorId:u._skip(4)._nextUint16(),descriptorType:u._nextUint16(),versionNumber:u._nextUint16(),descriptorBlockSize:u._nextUint16(),colorModel:u._nextUint8(),colorPrimaries:u._nextUint8(),transferFunction:u._nextUint8(),flags:u._nextUint8(),texelBlockDimension:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],bytesPlane:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],samples:[]},I=(m.descriptorBlockSize/4-6)/4;for(let T=0;T<I;T++){const q={bitOffset:u._nextUint16(),bitLength:u._nextUint8(),channelType:u._nextUint8(),samplePosition:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&q.channelType?(q.sampleLower=u._nextInt32(),q.sampleUpper=u._nextInt32()):(q.sampleLower=u._nextUint32(),q.sampleUpper=u._nextUint32()),m.samples[T]=q}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(m);const B=new he(c,r,A,!0);for(;B._offset<A;){const T=B._nextUint32(),q=B._scan(T),te=Bt(q);if(t.keyValue[te]=B._nextUint8Array(T-q.byteLength-1),te.match(/^ktx/i)){const ge=Bt(t.keyValue[te]);t.keyValue[te]=ge.substring(0,ge.lastIndexOf("\0"))}B._skip(T%4?4-T%4:0)}if(d<=0)return t;const f=new he(c,h,d,!0),b=f._nextUint16(),E=f._nextUint16(),C=f._nextUint32(),y=f._nextUint32(),w=f._nextUint32(),S=f._nextUint32(),k=[];for(let T=0;T<o;T++)k.push({imageFlags:f._nextUint32(),rgbSliceByteOffset:f._nextUint32(),rgbSliceByteLength:f._nextUint32(),alphaSliceByteOffset:f._nextUint32(),alphaSliceByteLength:f._nextUint32()});const F=h+f._offset,M=F+C,D=M+y,x=D+w,W=new Uint8Array(c.buffer,c.byteOffset+F,C),X=new Uint8Array(c.buffer,c.byteOffset+M,y),de=new Uint8Array(c.buffer,c.byteOffset+D,w),H=new Uint8Array(c.buffer,c.byteOffset+x,S);return t.globalData={endpointCount:b,selectorCount:E,imageDescs:k,endpointsData:W,selectorsData:X,tablesData:de,extendedData:H},t}let De,$,Le;const Fe={env:{emscripten_notify_memory_growth:function(c){Le=new Uint8Array($.exports.memory.buffer)}}};class ss{init(){return De||(De=typeof fetch<"u"?fetch("data:application/wasm;base64,"+Et).then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,Fe)).then(this._init):WebAssembly.instantiate(Buffer.from(Et,"base64"),Fe).then(this._init),De)}_init(e){$=e.instance,Fe.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!$)throw new Error("ZSTDDecoder: Await .init() before decoding.");const i=e.byteLength,s=$.exports.malloc(i);Le.set(e,s),t=t||Number($.exports.ZSTD_findDecompressedSize(s,i));const o=$.exports.malloc(t),n=$.exports.ZSTD_decompress(o,t,s,i),a=Le.slice(o,o+n);return $.exports.free(s),$.exports.free(o),a}}const Et="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IAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQh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ASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigC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C0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdB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IAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY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wOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEE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",os="display-p3",ns="display-p3-linear",ke=new WeakMap;let Re=0,Te;class z extends l.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new _i,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return this.workerConfig={astcSupported:await e.hasFeatureAsync("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:await e.hasFeatureAsync("texture-compression-etc1"),etc2Supported:await e.hasFeatureAsync("texture-compression-etc2"),dxtSupported:await e.hasFeatureAsync("texture-compression-bc"),bptcSupported:await e.hasFeatureAsync("texture-compression-bptc"),pvrtcSupported:await e.hasFeatureAsync("texture-compression-pvrtc")},this}detectSupport(e){return e.isWebGPURenderer===!0?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:e.hasFeature("texture-compression-bptc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:e.extensions.has("WEBGL_compressed_texture_astc")&&e.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}init(){if(!this.transcoderPending){const e=new l.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),i=new l.FileLoader(this.manager);i.setPath(this.transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const s=i.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,s]).then(([o,n])=>{const a=z.BasisWorker.toString(),r=["/* constants */","let _EngineFormat = "+JSON.stringify(z.EngineFormat),"let _EngineType = "+JSON.stringify(z.EngineType),"let _TranscoderFormat = "+JSON.stringify(z.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(z.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([r])),this.transcoderBinary=n,this.workerPool.setWorkerCreator(()=>{const A=new Worker(this.workerSourceURL),h=this.transcoderBinary.slice(0);return A.postMessage({type:"init",config:this.workerConfig,transcoderBinary:h},[h]),A})}),Re>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Re++}return this.transcoderPending}load(e,t,i,s){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const o=new l.FileLoader(this.manager);o.setPath(this.path),o.setCrossOrigin(this.crossOrigin),o.setWithCredentials(this.withCredentials),o.setResponseType("arraybuffer"),o.load(e,n=>{this.parse(n,t,s)},i,s)}parse(e,t,i){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(ke.has(e))return ke.get(e).promise.then(t).catch(i);this._createTexture(e).then(s=>t?t(s):null).catch(i)}_createTextureFrom(e,t){const{type:i,error:s,data:{faces:o,width:n,height:a,format:r,type:A,dfdFlags:h}}=e;if(i==="error")return Promise.reject(s);let d;if(t.faceCount===6)d=new l.CompressedCubeTexture(o,r,A);else{const g=o[0].mipmaps;d=t.layerCount>1?new l.CompressedArrayTexture(g,n,a,t.layerCount,r,A):new l.CompressedTexture(g,n,a,r,A)}return d.minFilter=o[0].mipmaps.length===1?l.LinearFilter:l.LinearMipmapLinearFilter,d.magFilter=l.LinearFilter,d.generateMipmaps=!1,d.needsUpdate=!0,d.colorSpace=yt(t),d.premultiplyAlpha=!!(h&Pi),d}async _createTexture(e,t={}){const i=is(new Uint8Array(e)),s=i.vkFormat===xe&&i.dataFormatDescriptor[0].colorModel===167;if(!(i.vkFormat===Oi||s&&!this.workerConfig.astcHDRSupported))return rs(i);const n=t,a=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:n},[e])).then(r=>this._createTextureFrom(r.data,i));return ke.set(e,{promise:a}),a}dispose(){this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),Re--}}z.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2},z.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25},z.EngineFormat={RGBAFormat:l.RGBAFormat,RGBA_ASTC_4x4_Format:l.RGBA_ASTC_4x4_Format,RGB_BPTC_UNSIGNED_Format:l.RGB_BPTC_UNSIGNED_Format,RGBA_BPTC_Format:l.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:l.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:l.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:l.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:l.RGB_ETC1_Format,RGB_ETC2_Format:l.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:l.RGB_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT1_Format:l.RGBA_S3TC_DXT1_Format},z.EngineType={UnsignedByteType:l.UnsignedByteType,HalfFloatType:l.HalfFloatType,FloatType:l.FloatType},z.BasisWorker=function(){let c,e,t;const i=_EngineFormat,s=_EngineType,o=_TranscoderFormat,n=_BasisFormat;self.addEventListener("message",function(m){const I=m.data;switch(I.type){case"init":c=I.config,a(I.transcoderBinary);break;case"transcode":e.then(()=>{try{const{faces:B,buffers:f,width:b,height:E,hasAlpha:C,format:y,type:w,dfdFlags:S}=r(I.buffer);self.postMessage({type:"transcode",id:I.id,data:{faces:B,width:b,height:E,hasAlpha:C,format:y,type:w,dfdFlags:S}},f)}catch(B){console.error(B),self.postMessage({type:"error",id:I.id,error:B.message})}});break}});function a(m){e=new Promise(I=>{t={wasmBinary:m,onRuntimeInitialized:I},BASIS(t)}).then(()=>{t.initializeBasis(),t.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function r(m){const I=new t.KTX2File(new Uint8Array(m));function B(){I.close(),I.delete()}if(!I.isValid())throw B(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");let f;if(I.isUASTC())f=n.UASTC;else if(I.isETC1S())f=n.ETC1S;else if(I.isHDR())f=n.UASTC_HDR;else throw new Error("THREE.KTX2Loader: Unknown Basis encoding");const b=I.getWidth(),E=I.getHeight(),C=I.getLayers()||1,y=I.getLevels(),w=I.getFaces(),S=I.getHasAlpha(),k=I.getDFDFlags(),{transcoderFormat:F,engineFormat:M,engineType:D}=d(f,b,E,S);if(!b||!E||!y)throw B(),new Error("THREE.KTX2Loader:	Invalid texture");if(!I.startTranscoding())throw B(),new Error("THREE.KTX2Loader: .startTranscoding failed");const x=[],W=[];for(let X=0;X<w;X++){const de=[];for(let H=0;H<y;H++){const T=[];let q,te;for(let ae=0;ae<C;ae++){const re=I.getImageLevelInfo(H,ae,X);X===0&&H===0&&ae===0&&(re.origWidth%4!==0||re.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),y>1?(q=re.origWidth,te=re.origHeight):(q=re.width,te=re.height);let Ae=new Uint8Array(I.getImageTranscodedSizeInBytes(H,ae,0,F));const Gs=I.transcodeImage(Ae,H,ae,X,F,0,-1,-1);if(D===s.HalfFloatType&&(Ae=new Uint16Array(Ae.buffer,Ae.byteOffset,Ae.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!Gs)throw B(),new Error("THREE.KTX2Loader: .transcodeImage failed.");T.push(Ae)}const ge=u(T);de.push({data:ge,width:q,height:te}),W.push(ge.buffer)}x.push({mipmaps:de,width:b,height:E,format:M,type:D})}return B(),{faces:x,buffers:W,width:b,height:E,hasAlpha:S,dfdFlags:k,format:M,type:D}}const A=[{if:"astcSupported",basisFormat:[n.UASTC],transcoderFormat:[o.ASTC_4x4,o.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],engineType:[s.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[o.BC7_M5,o.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],engineType:[s.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[o.BC1,o.BC3],engineFormat:[i.RGBA_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],engineType:[s.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[o.ETC1,o.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],engineType:[s.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[o.ETC1],engineFormat:[i.RGB_ETC1_Format],engineType:[s.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[o.PVRTC1_4_RGB,o.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],engineType:[s.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[n.UASTC_HDR],transcoderFormat:[o.BC6H],engineFormat:[i.RGB_BPTC_UNSIGNED_Format],engineType:[s.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[n.ETC1S,n.UASTC],transcoderFormat:[o.RGBA32,o.RGBA32],engineFormat:[i.RGBAFormat,i.RGBAFormat],engineType:[s.UnsignedByteType,s.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[n.UASTC_HDR],transcoderFormat:[o.RGBA_HALF],engineFormat:[i.RGBAFormat],engineType:[s.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],h={[n.ETC1S]:A.filter(m=>m.basisFormat.includes(n.ETC1S)).sort((m,I)=>m.priorityUASTC-I.priorityUASTC),[n.UASTC]:A.filter(m=>m.basisFormat.includes(n.UASTC)).sort((m,I)=>m.priorityUASTC-I.priorityUASTC),[n.UASTC_HDR]:A.filter(m=>m.basisFormat.includes(n.UASTC_HDR)).sort((m,I)=>m.priorityHDR-I.priorityHDR)};function d(m,I,B,f){const b=h[m];for(let E=0;E<b.length;E++){const C=b[E];if(C.if&&!c[C.if]||!C.basisFormat.includes(m)||f&&C.transcoderFormat.length<2||C.needsPowerOfTwo&&!(g(I)&&g(B)))continue;const y=C.transcoderFormat[f?1:0],w=C.engineFormat[f?1:0],S=C.engineType[0];return{transcoderFormat:y,engineFormat:w,engineType:S}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}function g(m){return m<=2?!0:(m&m-1)===0&&m!==0}function u(m){if(m.length===1)return m[0];let I=0;for(let b=0;b<m.length;b++){const E=m[b];I+=E.byteLength}const B=new Uint8Array(I);let f=0;for(let b=0;b<m.length;b++){const E=m[b];B.set(E,f),f+=E.byteLength}return B}};const as=new Set([l.RGBAFormat,l.RGFormat,l.RedFormat]),_e={[mt]:l.RGBAFormat,[gt]:l.RGBAFormat,[lt]:l.RGBAFormat,[ct]:l.RGBAFormat,[pt]:l.RGFormat,[dt]:l.RGFormat,[rt]:l.RGFormat,[At]:l.RGFormat,[ut]:l.RedFormat,[ht]:l.RedFormat,[at]:l.RedFormat,[nt]:l.RedFormat,[ft]:l.RGB_ETC2_Format,[bt]:l.RGBA_ETC2_EAC_Format,[xe]:l.RGBA_ASTC_4x4_Format,[es]:l.RGBA_ASTC_4x4_Format,[$i]:l.RGBA_ASTC_4x4_Format,[It]:l.RGBA_ASTC_6x6_Format,[Ct]:l.RGBA_ASTC_6x6_Format,[zi]:l.RGBA_S3TC_DXT1_Format,[Hi]:l.RGBA_S3TC_DXT1_Format,[qi]:l.RGB_S3TC_DXT1_Format,[ji]:l.RGB_S3TC_DXT1_Format,[Yi]:l.RGBA_S3TC_DXT3_Format,[Ki]:l.RGBA_S3TC_DXT3_Format,[Wi]:l.RGBA_S3TC_DXT5_Format,[Ji]:l.RGBA_S3TC_DXT5_Format,[Zi]:l.RGBA_BPTC_Format,[Xi]:l.RGBA_BPTC_Format},Ge={[mt]:l.FloatType,[gt]:l.HalfFloatType,[lt]:l.UnsignedByteType,[ct]:l.UnsignedByteType,[pt]:l.FloatType,[dt]:l.HalfFloatType,[rt]:l.UnsignedByteType,[At]:l.UnsignedByteType,[ut]:l.FloatType,[ht]:l.HalfFloatType,[at]:l.UnsignedByteType,[nt]:l.UnsignedByteType,[ft]:l.UnsignedByteType,[bt]:l.UnsignedByteType,[xe]:l.HalfFloatType,[It]:l.UnsignedByteType,[Ct]:l.UnsignedByteType};async function rs(c){const{vkFormat:e}=c;if(_e[e]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let t;c.supercompressionScheme===st&&(Te||(Te=new Promise(async o=>{const n=new ss;await n.init(),o(n)})),t=await Te);const i=[];for(let o=0;o<c.levels.length;o++){const n=Math.max(1,c.pixelWidth>>o),a=Math.max(1,c.pixelHeight>>o),r=c.pixelDepth?Math.max(1,c.pixelDepth>>o):0,A=c.levels[o];let h;if(c.supercompressionScheme===Gi)h=A.levelData;else if(c.supercompressionScheme===st)h=t.decode(A.levelData,A.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let d;Ge[e]===l.FloatType?d=new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):Ge[e]===l.HalfFloatType?d=new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):d=h,i.push({data:d,width:n,height:a,depth:r})}let s;if(as.has(_e[e]))s=c.pixelDepth===0?new l.DataTexture(i[0].data,c.pixelWidth,c.pixelHeight):new l.Data3DTexture(i[0].data,c.pixelWidth,c.pixelHeight,c.pixelDepth);else{if(c.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");s=new l.CompressedTexture(i,c.pixelWidth,c.pixelHeight),s.minFilter=i.length===1?l.LinearFilter:l.LinearMipmapLinearFilter,s.magFilter=l.LinearFilter}return s.mipmaps=i,s.type=Ge[e],s.format=_e[e],s.colorSpace=yt(c),s.needsUpdate=!0,Promise.resolve(s)}function yt(c){const e=c.dataFormatDescriptor[0];return e.colorPrimaries===Ni?e.transferFunction===ot?l.SRGBColorSpace:l.LinearSRGBColorSpace:e.colorPrimaries===Vi?e.transferFunction===ot?os:ns:(e.colorPrimaries===Ui||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${e.colorPrimaries}"`),l.NoColorSpace)}var As=function(){var c="b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q:Odkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq;w8Wqdbk;esezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9Uc;WFbGgocjdaocjd6EhDaicefhocbhqdnindndndnaeaq9nmbaDaeaq9RaqaDfae6Egkcsfglcl4cifcd4hxalc9WGgmTmecbhPawcjdfhsaohzinaraz9Rax6mvarazaxfgo9RcK6mvczhlcbhHinalgic9WfgOawcj;cbffhldndndndndnazaOco4fRbbaHcoG4ciGPlbedibkal9cb83ibalcwf9cb83ibxikalaoRblaoRbbgOco4gAaAciSgAE86bbawcj;cbfaifglcGfaoclfaAfgARbbaOcl4ciGgCaCciSgCE86bbalcVfaAaCfgARbbaOcd4ciGgCaCciSgCE86bbalc7faAaCfgARbbaOciGgOaOciSgOE86bbalctfaAaOfgARbbaoRbegOco4gCaCciSgCE86bbalc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbalc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbalc93faAaCfgARbbaOciGgOaOciSgOE86bbalc94faAaOfgARbbaoRbdgOco4gCaCciSgCE86bbalc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbalc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbalc97faAaCfgARbbaOciGgOaOciSgOE86bbalc98faAaOfgORbbaoRbigoco4gAaAciSgAE86bbalc99faOaAfgORbbaocl4ciGgAaAciSgAE86bbalc9:faOaAfgORbbaocd4ciGgAaAciSgAE86bbalcufaOaAfglRbbaociGgoaociSgoE86bbalaofhoxdkalaoRbwaoRbbgOcl4gAaAcsSgAE86bbawcj;cbfaifglcGfaocwfaAfgARbbaOcsGgOaOcsSgOE86bbalcVfaAaOfgORbbaoRbegAcl4gCaCcsSgCE86bbalc7faOaCfgORbbaAcsGgAaAcsSgAE86bbalctfaOaAfgORbbaoRbdgAcl4gCaCcsSgCE86bbalc91faOaCfgORbbaAcsGgAaAcsSgAE86bbalc4faOaAfgORbbaoRbigAcl4gCaCcsSgCE86bbalc93faOaCfgORbbaAcsGgAaAcsSgAE86bbalc94faOaAfgORbbaoRblgAcl4gCaCcsSgCE86bbalc95faOaCfgORbbaAcsGgAaAcsSgAE86bbalc96faOaAfgORbbaoRbvgAcl4gCaCcsSgCE86bbalc97faOaCfgORbbaAcsGgAaAcsSgAE86bbalc98faOaAfgORbbaoRbogAcl4gCaCcsSgCE86bbalc99faOaCfgORbbaAcsGgAaAcsSgAE86bbalc9:faOaAfgORbbaoRbrgocl4gAaAcsSgAE86bbalcufaOaAfglRbbaocsGgoaocsSgoE86bbalaofhoxekalao8Pbb83bbalcwfaocwf8Pbb83bbaoczfhokdnaiam9pmbaHcdfhHaiczfhlarao9RcL0mekkaiam6mvaoTmvdnakTmbawaPfRbbhHawcj;cbfhlashiakhOinaialRbbgzce4cbazceG9R7aHfgH86bbaiadfhialcefhlaOcufgOmbkkascefhsaohzaPcefgPad9hmbxikkcbc99arao9Radcaadca0ESEhoxlkaoaxad2fhCdnakmbadhlinaoTmlarao9Rax6mlaoaxfhoalcufglmbkaChoxekcbhmawcjdfhAinarao9Rax6miawamfRbbhHawcj;cbfhlaAhiakhOinaialRbbgzce4cbazceG9R7aHfgH86bbaiadfhialcefhlaOcufgOmbkaAcefhAaoaxfhoamcefgmad9hmbkaChokabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqaombkc9:hoxekc9:hokavcj;ebf8Kjjjjbaok;cseHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgwce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhDaicefgqarfhidnaeTmbcmcsawceSEhkcbhxcbhmcbhPcbhwcbhlindnaiaD9nmbc9:hoxikdndnaqRbbgoc;Ve0mbavc;abfalaocu7gscl4fcsGcitfgzydlhrazydbhzdnaocsGgHak9pmbavawasfcsGcdtfydbaxaHEhoaHThsdndnadcd9hmbabaPcetfgHaz87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHazBdbaHcwfaoBdbaHclfarBdbkaxasfhxcdhHavawcdtfaoBdbawasfhwcehsalhOxdkdndnaHcsSmbaHc987aHamffcefhoxekaicefhoai8SbbgHcFeGhsdndnaHcu9mmbaohixekaicvfhiascFbGhscrhHdninao8SbbgOcFbGaHtasVhsaOcu9kmeaocefhoaHcrfgHc8J9hmbxdkkaocefhikasce4cbasceG9R7amfhokdndnadcd9hmbabaPcetfgHaz87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHazBdbaHcwfaoBdbaHclfarBdbkcdhHavawcdtfaoBdbcehsawcefhwalhOaohmxekdnaocpe0mbaxcefgHavawaDaocsGfRbbgocl49RcsGcdtfydbaocz6gzEhravawao9RcsGcdtfydbaHazfgAaocsGgHEhoaHThCdndnadcd9hmbabaPcetfgHax87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHaxBdbaHcwfaoBdbaHclfarBdbkcdhsavawcdtfaxBdbavawcefgwcsGcdtfarBdbcihHavc;abfalcitfgOaxBdlaOarBdbavawazfgwcsGcdtfaoBdbalcefcsGhOawaCfhwaxhzaAaCfhxxekaxcbaiRbbgOEgzaoc;:eSgHfhraOcsGhCaOcl4hAdndnaOcs0mbarcefhoxekarhoavawaA9RcsGcdtfydbhrkdndnaCmbaocefhxxekaohxavawaO9RcsGcdtfydbhokdndnaHTmbaicefhHxekaicdfhHai8SbegscFeGhzdnascu9kmbaicofhXazcFbGhzcrhidninaH8SbbgscFbGaitazVhzascu9kmeaHcefhHaicrfgic8J9hmbkaXhHxekaHcefhHkazce4cbazceG9R7amfgmhzkdndnaAcsSmbaHhsxekaHcefhsaH8SbbgicFeGhrdnaicu9kmbaHcvfhXarcFbGhrcrhidninas8SbbgHcFbGaitarVhraHcu9kmeascefhsaicrfgic8J9hmbkaXhsxekascefhskarce4cbarceG9R7amfgmhrkdndnaCcsSmbashixekascefhias8SbbgocFeGhHdnaocu9kmbascvfhXaHcFbGhHcrhodninai8SbbgscFbGaotaHVhHascu9kmeaicefhiaocrfgoc8J9hmbkaXhixekaicefhikaHce4cbaHceG9R7amfgmhokdndnadcd9hmbabaPcetfgHaz87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHazBdbaHcwfaoBdbaHclfarBdbkcdhsavawcdtfazBdbavawcefgwcsGcdtfarBdbcihHavc;abfalcitfgXazBdlaXarBdbavawaOcz6aAcsSVfgwcsGcdtfaoBdbawaCTaCcsSVfhwalcefcsGhOkaqcefhqavc;abfaOcitfgOarBdlaOaoBdbavc;abfalasfcsGcitfgraoBdlarazBdbawcsGhwalaHfcsGhlaPcifgPae6mbkkcbc99aiaDSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;oiliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabaiavcefciGfcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavciGfgkcd7cetfaD87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:OhDxekcjjjj94hDkabaiavcufciGfcetfaD87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohvxekcjjjj94hvkabakcetfav87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2gdTmbinababydbgecwtcw91:Yaece91cjjj98Gcjjj;8if::NUdbabclfhbadcufgdmbkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaeczfheaiczfhiadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklzNbb",e="b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q:6dkr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq:p9sqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk:N8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhlaicefhodnaeTmbadTmbalc;WFbGglcjdalcjd6EhwcbhDinawaeaD9RaDawfae6Egqcsfglc9WGgkci2hxakcethmalcl4cifcd4hPabaDad2fhsakc;ab6hzcbhHincbhOaohAdndninaraA9RaP6meavcj;cbfaOak2fhCaAaPfhocbhidnazmbarao9Rc;Gb6mbcbhlinaCalfhidndndndndnaAalco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaiaopbblaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbaoclfaYpQbfaKc:q:yjjbfRbbfhoxdkaiaopbbwaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbaocwfaYpQbfaKc:q:yjjbfRbbfhoxekaiaopbbbpklbaoczfhokdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaiaopbblaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzaoclfaYpQbfaKc:q:yjjbfRbbfhoxdkaiaopbbwaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzaocwfaYpQbfaKc:q:yjjbfRbbfhoxekaiaopbbbpklzaoczfhokdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaiaopbblaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaaoclfaYpQbfaKc:q:yjjbfRbbfhoxdkaiaopbbwaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaaocwfaYpQbfaKc:q:yjjbfRbbfhoxekaiaopbbbpklaaoczfhokdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaiaopbblaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WaoclfaYpQbfaXc:q:yjjbfRbbfhoxdkaiaopbbwaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WaocwfaYpQbfaXc:q:yjjbfRbbfhoxekaiaopbbbpkl8Waoczfhokalc;abfhialcjefak0meaihlarao9Rc;Fb0mbkkdnaiak9pmbaici4hlinarao9RcK6miaCaifhXdndndndndnaAaico4fRbbalcoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpkbbxikaXaopbblaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkbbaoclfaYpQbfaKc:q:yjjbfRbbfhoxdkaXaopbbwaopbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkbbaocwfaYpQbfaKc:q:yjjbfRbbfhoxekaXaopbbbpkbbaoczfhokalcdfhlaiczfgiak6mbkkaoTmeaohAaOcefgOclSmdxbkkc9:hoxlkdnakTmbavcjdfaHfhiavaHfpbdbhYcbhXinaiavcj;cbfaXfglpblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLalakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEalamfpblbg3cep9Ta3aQp9op9Hp9rg3alaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfglaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaladfglaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaladfglaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaladfglaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaladfglaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaladfglaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaladfglaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaladfglaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaladfglaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaladfglaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaladfglaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaladfglaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaladfglaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaladfglaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaladfglaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaladfhiaXczfgXak6mbkkaHclfgHad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfgDae6mbkkcbc99arao9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk::seHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgwce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhDaicefgqarfhidnaeTmbcmcsawceSEhkcbhxcbhmcbhPcbhwcbhlindnaiaD9nmbc9:hoxikdndnaqRbbgoc;Ve0mbavc;abfalaocu7gscl4fcsGcitfgzydlhrazydbhzdnaocsGgHak9pmbavawasfcsGcdtfydbaxaHEhoaHThsdndnadcd9hmbabaPcetfgHaz87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHazBdbaHcwfaoBdbaHclfarBdbkaxasfhxcdhHavawcdtfaoBdbawasfhwcehsalhOxdkdndnaHcsSmbaHc987aHamffcefhoxekaicefhoai8SbbgHcFeGhsdndnaHcu9mmbaohixekaicvfhiascFbGhscrhHdninao8SbbgOcFbGaHtasVhsaOcu9kmeaocefhoaHcrfgHc8J9hmbxdkkaocefhikasce4cbasceG9R7amfhokdndnadcd9hmbabaPcetfgHaz87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHazBdbaHcwfaoBdbaHclfarBdbkcdhHavawcdtfaoBdbcehsawcefhwalhOaohmxekdnaocpe0mbaxcefgHavawaDaocsGfRbbgocl49RcsGcdtfydbaocz6gzEhravawao9RcsGcdtfydbaHazfgAaocsGgHEhoaHThCdndnadcd9hmbabaPcetfgHax87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHaxBdbaHcwfaoBdbaHclfarBdbkcdhsavawcdtfaxBdbavawcefgwcsGcdtfarBdbcihHavc;abfalcitfgOaxBdlaOarBdbavawazfgwcsGcdtfaoBdbalcefcsGhOawaCfhwaxhzaAaCfhxxekaxcbaiRbbgOEgzaoc;:eSgHfhraOcsGhCaOcl4hAdndnaOcs0mbarcefhoxekarhoavawaA9RcsGcdtfydbhrkdndnaCmbaocefhxxekaohxavawaO9RcsGcdtfydbhokdndnaHTmbaicefhHxekaicdfhHai8SbegscFeGhzdnascu9kmbaicofhXazcFbGhzcrhidninaH8SbbgscFbGaitazVhzascu9kmeaHcefhHaicrfgic8J9hmbkaXhHxekaHcefhHkazce4cbazceG9R7amfgmhzkdndnaAcsSmbaHhsxekaHcefhsaH8SbbgicFeGhrdnaicu9kmbaHcvfhXarcFbGhrcrhidninas8SbbgHcFbGaitarVhraHcu9kmeascefhsaicrfgic8J9hmbkaXhsxekascefhskarce4cbarceG9R7amfgmhrkdndnaCcsSmbashixekascefhias8SbbgocFeGhHdnaocu9kmbascvfhXaHcFbGhHcrhodninai8SbbgscFbGaotaHVhHascu9kmeaicefhiaocrfgoc8J9hmbkaXhixekaicefhikaHce4cbaHceG9R7amfgmhokdndnadcd9hmbabaPcetfgHaz87ebaHclfao87ebaHcdfar87ebxekabaPcdtfgHazBdbaHcwfaoBdbaHclfarBdbkcdhsavawcdtfazBdbavawcefgwcsGcdtfarBdbcihHavc;abfalcitfgXazBdlaXarBdbavawaOcz6aAcsSVfgwcsGcdtfaoBdbawaCTaCcsSVfhwalcefcsGhOkaqcefhqavc;abfaOcitfgOarBdlaOaoBdbavc;abfalasfcsGcitfgraoBdlarazBdbawcsGhwalaHfcsGhlaPcifgPae6mbkkcbc99aiaDSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:wPliuo97eue978Jjjjjbca9Rhiaec98Ghldndnadcl9hmbdnalTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalaeSmeaipxbbbbbbbbbbbbbbbbgqpklbaiabalcdtfgdaeciGglcdtgv;8qbbdnalTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDaqp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkadaiav;8qbbskdnalTmbcbhvabhdinadczfgxaxpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oaoarpmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgval6mbkkalaeSmbaiaeciGgvcitgdfcbcaad9R;8kbaiabalcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmbediwDqkzHOAKY8AEgwczp:Reczp:Sep;6egraDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eawczp:Sep;6egwp;Gearp;Gep;Kep;Legopxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegrpxb;:FSb;:FSb;:FSb;:FSararp;Meaoaop;Meawaqawamp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFFbbFFbbFFbbFFbbp9oaoawp;Meaqp;Keczp:Rep9qgoarawp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogrpmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oaoarpmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalaeSmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaDakp;Mearp;Keamp9oaqakp;Mearp;Keczp:Rep9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbheabhdinadadpbbbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepkbbadczfhdaeclfgeav6mbkkdnavalSmbaialciGgecdtgdVcbc;abad9R;8kbaiabavcdtfgvad;8qbbdnaeTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepklbkavaiad;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz:Dbb",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var s=WebAssembly.validate(t)?a(e):a(c),o,n=WebAssembly.instantiate(s,{}).then(function(f){o=f.instance,o.exports.__wasm_call_ctors()});function a(f){for(var b=new Uint8Array(f.length),E=0;E<f.length;++E){var C=f.charCodeAt(E);b[E]=C>96?C-97:C>64?C-39:C+4}for(var y=0,E=0;E<f.length;++E)b[y++]=b[E]<60?i[b[E]]:(b[E]-60)*64+b[++E];return b.buffer.slice(0,y)}function r(f,b,E,C,y,w,S){var k=f.exports.sbrk,F=C+3&-4,M=k(F*y),D=k(w.length),x=new Uint8Array(f.exports.memory.buffer);x.set(w,D);var W=b(M,C,y,D,w.length);if(W==0&&S&&S(M,F,y),E.set(x.subarray(M,M+C*y)),k(M-k(0)),W!=0)throw new Error("Malformed buffer data: "+W)}var A={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},h={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},d=[],g=0;function u(f){var b={object:new Worker(f),pending:0,requests:{}};return b.object.onmessage=function(E){var C=E.data;b.pending-=C.count,b.requests[C.id][C.action](C.value),delete b.requests[C.id]},b}function m(f){for(var b="self.ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(s)+"]), {}).then(function(result) { result.instance.exports.__wasm_call_ctors(); return result.instance; });self.onmessage = "+B.name+";"+r.toString()+B.toString(),E=new Blob([b],{type:"text/javascript"}),C=URL.createObjectURL(E),y=d.length;y<f;++y)d[y]=u(C);for(var y=f;y<d.length;++y)d[y].object.postMessage({});d.length=f,URL.revokeObjectURL(C)}function I(f,b,E,C,y){for(var w=d[0],S=1;S<d.length;++S)d[S].pending<w.pending&&(w=d[S]);return new Promise(function(k,F){var M=new Uint8Array(E),D=++g;w.pending+=f,w.requests[D]={resolve:k,reject:F},w.object.postMessage({id:D,count:f,size:b,source:M,mode:C,filter:y},[M.buffer])})}function B(f){var b=f.data;if(!b.id)return self.close();self.ready.then(function(E){try{var C=new Uint8Array(b.count*b.size);r(E,E.exports[b.mode],C,b.count,b.size,b.source,E.exports[b.filter]),self.postMessage({id:b.id,count:b.count,action:"resolve",value:C},[C.buffer])}catch(y){self.postMessage({id:b.id,count:b.count,action:"reject",value:y})}})}return{ready:n,supported:!0,useWorkers:function(f){m(f)},decodeVertexBuffer:function(f,b,E,C,y){r(o,o.exports.meshopt_decodeVertexBuffer,f,b,E,C,o.exports[A[y]])},decodeIndexBuffer:function(f,b,E,C){r(o,o.exports.meshopt_decodeIndexBuffer,f,b,E,C)},decodeIndexSequence:function(f,b,E,C){r(o,o.exports.meshopt_decodeIndexSequence,f,b,E,C)},decodeGltfBuffer:function(f,b,E,C,y,w){r(o,o.exports[h[y]],f,b,E,C,o.exports[A[w]])},decodeGltfBufferAsync:function(f,b,E,C,y){return d.length>0?I(f,b,E,h[C],A[y]):n.then(function(){var w=new Uint8Array(f*b);return r(o,o.exports[h[C]],w,f,b,E,o.exports[A[y]]),w})}}}();class O{constructor(e=null){this.renderer=e,this.loader=new We,this.dracoLoader=new Ri,this.ktx2Loader=null,this.dracoLoader.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.6/"),this.loader.setDRACOLoader(this.dracoLoader),this.loader.setMeshoptDecoder(As),this.cache=new Map,this.ktx2SetupComplete=!1,this.setupKTX2Loader()}setupKTX2Loader(){if(O.sharedKTX2SetupComplete&&O.sharedKTX2Loader){this.ktx2Loader=O.sharedKTX2Loader,this.ktx2SetupComplete=!0,this.loader.setKTX2Loader(this.ktx2Loader);return}try{O.sharedKTX2Loader||(O.sharedKTX2Loader=new z,O.sharedKTX2Loader.setTranscoderPath("https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/libs/basis/")),this.ktx2Loader=O.sharedKTX2Loader,this.renderer&&!O.sharedKTX2SetupComplete&&(this.ktx2Loader.detectSupport(this.renderer),O.sharedKTX2SetupComplete=!0),this.loader.setKTX2Loader(this.ktx2Loader),this.ktx2SetupComplete=!0}catch(e){console.warn("KTX2 loader setup failed, falling back to standard textures:",e),this.ktx2Loader=null}}setRenderer(e){if(this.renderer=e,this.ktx2Loader&&e&&!this.ktx2SetupComplete)try{this.ktx2Loader.detectSupport(e),this.loader.setKTX2Loader(this.ktx2Loader)}catch(t){console.warn("Failed to set up KTX2 loader with renderer:",t)}!this.ktx2Loader&&e&&this.setupKTX2Loader()}async load(e,t=null,i=null){if(this.cache.has(e)){const o=this.cache.get(e).scene.clone(!0);return this.processModel({scene:o})}return new Promise((s,o)=>{if(i&&(i.addEventListener("abort",()=>{o(new Error("Loading cancelled"))}),i.aborted)){o(new Error("Loading cancelled"));return}this.loader.load(e,n=>{if(i&&i.aborted){o(new Error("Loading cancelled"));return}this.cache.set(e,n);const a=this.processModel(n);s(a)},n=>{i&&i.aborted||t&&t(n)},n=>{o(n)})})}processModel(e){const t=e.scene;t.traverse(s=>{if(s.isLight&&(s.visible=!1),s.isMesh&&s.material){s.castShadow=!0,s.receiveShadow=!0;const o=Array.isArray(s.material)?s.material:[s.material];o.forEach((n,a)=>{if(n.emissive&&n.emissive.setHex(0),n.emissiveIntensity!==void 0&&(n.emissiveIntensity=0),n.emissiveMap&&(n.emissiveMap=null),n.lightMap&&(n.lightMap=null),n.lightMapIntensity!==void 0&&(n.lightMapIntensity=0),n.type==="MeshBasicMaterial"||n.type==="MeshPhongMaterial"){const A=new p.MeshLambertMaterial({map:n.map,color:n.color||new p.Color(16777215),transparent:n.transparent,opacity:n.opacity!==void 0?n.opacity:1,alphaMap:n.alphaMap,side:n.side!==void 0?n.side:p.FrontSide,wireframe:n.wireframe||!1,vertexColors:n.vertexColors||!1,fog:n.fog!==void 0?n.fog:!0,aoMap:n.aoMap,aoMapIntensity:n.aoMapIntensity||1,envMap:n.envMap,reflectivity:n.reflectivity||1,refractionRatio:n.refractionRatio||.98,combine:n.combine||p.MultiplyOperation,normalMap:n.normalMap,normalScale:n.normalScale||new p.Vector2(1,1),flatShading:!1});A.map&&(A.map.anisotropy=this.renderer.capabilities.getMaxAnisotropy(),A.map.needsUpdate=!0),A.normalMap&&(A.normalMap.anisotropy=this.renderer.capabilities.getMaxAnisotropy(),A.normalMap.needsUpdate=!0),A.needsUpdate=!0,Array.isArray(s.material)?s.material[a]=A:s.material=A}else(n.type==="MeshStandardMaterial"||n.type==="MeshPhysicalMaterial")&&(n.needsUpdate=!0);const r=Array.isArray(s.material)?s.material[a]:s.material;r&&r.needsUpdate!==void 0&&(r.needsUpdate=!0)}),s.geometry&&(s.geometry.computeVertexNormals(),s.geometry.normalizeNormals(),o.some(a=>a.normalMap)&&s.geometry.computeTangents())}});const i=new p.Box3().setFromObject(t);return t.userData.boundingBox=i,t}processMaterial(e){e&&e.needsUpdate!==void 0&&(e.needsUpdate=!0)}dispose(){this.dracoLoader&&this.dracoLoader.dispose(),this.cache.clear(),this.ktx2SetupComplete=!1}}O.sharedKTX2Loader=null,O.sharedKTX2SetupComplete=!1;class ne{static createButton(e,t={}){const i=document.createElement("button");function s(){let A=null;async function h(u){u.addEventListener("end",d),await e.xr.setSession(u),i.textContent="EXIT VR",A=u}function d(){A.removeEventListener("end",d),i.textContent="ENTER VR",A=null}i.style.display="",i.style.cursor="pointer",i.style.left="calc(50% - 50px)",i.style.width="100px",i.textContent="ENTER VR";const g={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};i.onmouseenter=function(){i.style.opacity="1.0"},i.onmouseleave=function(){i.style.opacity="0.5"},i.onclick=function(){A===null?navigator.xr.requestSession("immersive-vr",g).then(h):(A.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",g).then(h).catch(u=>{console.warn(u)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",g).then(h).catch(u=>{console.warn(u)})}function o(){i.style.display="",i.style.cursor="auto",i.style.left="calc(50% - 75px)",i.style.width="150px",i.onmouseenter=null,i.onmouseleave=null,i.onclick=null}function n(){o(),i.textContent="VR NOT SUPPORTED"}function a(A){o(),console.warn("Exception when trying to call xr.isSessionSupported",A),i.textContent="VR NOT ALLOWED"}function r(A){A.style.position="absolute",A.style.bottom="20px",A.style.padding="12px 6px",A.style.border="1px solid #fff",A.style.borderRadius="4px",A.style.background="rgba(0,0,0,0.1)",A.style.color="#fff",A.style.font="normal 13px sans-serif",A.style.textAlign="center",A.style.opacity="0.5",A.style.outline="none",A.style.zIndex="999"}if("xr"in navigator)return i.id="VRButton",i.style.display="none",r(i),navigator.xr.isSessionSupported("immersive-vr").then(function(A){A?s():n(),A&&ne.xrSessionIsGranted&&i.click()}).catch(a),i;{const A=document.createElement("a");return window.isSecureContext===!1?(A.href=document.location.href.replace(/^http:/,"https:"),A.innerHTML="WEBXR NEEDS HTTPS"):(A.href="https://immersiveweb.dev/",A.innerHTML="WEBXR NOT AVAILABLE"),A.style.left="calc(50% - 90px)",A.style.width="180px",A.style.textDecoration="none",r(A),A}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{ne.xrSessionIsGranted=!0})}}}ne.xrSessionIsGranted=!1,ne.registerSessionGrantedListener();class ls{constructor(e,t,i,s=null){this.renderer=e,this.camera=t,this.scene=i,this.container=s||document.body,this.isVRSupported=!1,this.isVRPresenting=!1,this.isQuest2=!1,this.isQuest3=!1,this.vrButton=null,this.onSessionStart=null,this.onSessionEnd=null}init(){this.renderer.xr.enabled=!0,this.checkVRSupported(),this.removeExistingVRButtons(),this.checkVRSupported().then(()=>{this.isVRSupported&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.createVRButton()}):this.createVRButton())}),this.setupSessionListeners(),"xr"in navigator?navigator.xr.isSessionSupported("immersive-vr").then(e=>{e||this.startVRButtonMonitoring()}).catch(()=>{this.startVRButtonMonitoring()}):this.startVRButtonMonitoring()}checkVRSupported(){return new Promise(e=>{try{"xr"in navigator?navigator.xr.isSessionSupported("immersive-vr").then(t=>{this.isVRSupported=t,e()}).catch(t=>{console.warn("VR support check failed:",t),this.isVRSupported=!1,e()}):(this.isVRSupported=!1,e())}catch(t){console.warn("VR support check error:",t),this.isVRSupported=!1,e()}})}createVRButton(){try{this.waitForVRCSS().then(()=>{const e={optionalFeatures:["hand-tracking","local-floor","bounded-floor","layers"]};this.vrButton=ne.createButton(this.renderer,e),this.vrButton.innerHTML='<span class="vr-icon">🥽</span>ENTER VR',this.vrButton.className="vr-button-glass vr-button-available",this.vrButton.disabled=!1,this.vrButton.style.cssText=`
          position: fixed !important;
          bottom: 80px !important;
          left: 50% !important;
          transform: translateX(-50%) !important;
          z-index: 2147483647 !important;
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          pointer-events: auto !important;
          cursor: pointer !important;
        `,this.container.appendChild(this.vrButton),this.styleVRButton()})}catch(e){console.error("❌ VR button creation failed:",e)}}styleVRButton(){const e=()=>{const t=document.querySelector("button.vr-button-glass")||document.querySelector("button")||this.vrButton;return t?(t.style.display="flex",t.style.visibility="visible",t.style.opacity="1",t.innerHTML='<span class="vr-icon">🥽</span>ENTER VR',t.classList.contains("vr-button-glass")||t.classList.add("vr-button-glass"),t.disabled=!1,t.classList.remove("vr-generic-disabled"),!0):!1};e()||(setTimeout(e,100),setTimeout(e,300),setTimeout(e,500))}updateVRButton(){}setupSessionListeners(){this.renderer.xr.addEventListener("sessionstart",()=>{this.isVRPresenting=!0;const e=this.detectQuestDevice();this.applyQuestOptimizations(e),this.onSessionStart&&this.onSessionStart()}),this.renderer.xr.addEventListener("sessionend",()=>{this.isVRPresenting=!1,this.onSessionEnd&&this.onSessionEnd()})}detectQuestDevice(){try{const e=navigator.userAgent.toLowerCase();return e.includes("quest 2")||e.includes("oculus quest 2")||e.includes("oculus")&&e.includes("android")&&!e.includes("quest 3")?(this.isQuest2=!0,"quest2"):e.includes("quest 3")||e.includes("oculus quest 3")||e.includes("meta quest 3")?(this.isQuest3=!0,"quest3"):"unknown"}catch(e){return console.warn("Device detection failed:",e),"unknown"}}applyQuestOptimizations(e){e==="quest2"&&(this.camera.far=20,this.camera.updateProjectionMatrix())}async waitForVRCSS(){return new Promise(e=>{const t=()=>{const i=document.createElement("div");i.className="vr-mode-active",i.style.display="none",this.container.appendChild(i);const s=window.getComputedStyle(i),o=s.getPropertyValue("--vr-css-loaded")==="true"||s.opacity==="0.999";this.container.removeChild(i),o?e():setTimeout(t,50)};setTimeout(t,100)})}removeExistingVRButtons(){document.querySelectorAll('button.legacy-vr-button, a[href="#VR"]').forEach(t=>{try{t.parentNode&&t.parentNode.removeChild(t)}catch(i){console.warn("Failed to remove VR button:",i)}})}startVRButtonMonitoring(){new MutationObserver(t=>{t.forEach(i=>{i.addedNodes.forEach(s=>{if(s.nodeType===Node.ELEMENT_NODE){const o=s.querySelectorAll?s.querySelectorAll('button.legacy-vr-button, a[href="#VR"]'):[];if(o.length>0||s.tagName==="BUTTON"&&s.classList.contains("legacy-vr-button")){const n=o.length>0?o[0]:s;n.style.display="none"}}})})}).observe(document.body,{childList:!0,subtree:!0})}getVRStatus(){return{supported:this.isVRSupported,presenting:this.isVRPresenting,isQuest2:this.isQuest2,isQuest3:this.isQuest3}}dispose(){this.vrButton&&this.vrButton.parentNode&&this.vrButton.parentNode.removeChild(this.vrButton),this.isQuest2=!1,this.isQuest3=!1,this.isVRSupported=!1,this.isVRPresenting=!1}}const L={ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function wt(c){const e=await fetch(c);if(e.ok)return e.json();throw new Error(e.statusText)}async function cs(c){if(!c)throw new Error("No basePath supplied");return await wt(`${c}/profilesList.json`)}async function hs(c,e,t=null,i=!0){if(!c)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const s=await cs(e);let o;if(c.profiles.some(r=>{const A=s[r];return A&&(o={profileId:r,profilePath:`${e}/${A.path}`,deprecated:!!A.deprecated}),!!o}),!o){if(!t)throw new Error("No matching profile name found");const r=s[t];if(!r)throw new Error(`No matching profile name found and default profile "${t}" missing.`);o={profileId:t,profilePath:`${e}/${r.path}`,deprecated:!!r.deprecated}}const n=await wt(o.profilePath);let a;if(i){let r;if(c.handedness==="any"?r=n.layouts[Object.keys(n.layouts)[0]]:r=n.layouts[c.handedness],!r)throw new Error(`No matching handedness, ${c.handedness}, in profile ${o.profileId}`);r.assetPath&&(a=o.profilePath.replace("profile.json",r.assetPath))}return{profile:n,assetPath:a}}const ds={xAxis:0,yAxis:0,button:0,state:L.ComponentState.DEFAULT};function gs(c=0,e=0){let t=c,i=e;if(Math.sqrt(c*c+e*e)>1){const n=Math.atan2(e,c);t=Math.cos(n),i=Math.sin(n)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:i*.5+.5}}class us{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===L.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(ds)}updateFromComponent({xAxis:e,yAxis:t,button:i,state:s}){const{normalizedXAxis:o,normalizedYAxis:n}=gs(e,t);switch(this.componentProperty){case L.ComponentProperty.X_AXIS:this.value=this.states.includes(s)?o:.5;break;case L.ComponentProperty.Y_AXIS:this.value=this.states.includes(s)?n:.5;break;case L.ComponentProperty.BUTTON:this.value=this.states.includes(s)?i:0;break;case L.ComponentProperty.STATE:this.valueNodeProperty===L.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(s):this.value=this.states.includes(s)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class ps{constructor(e,t){if(!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(i=>{const s=new us(t.visualResponses[i]);this.visualResponses[i]=s}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:L.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=L.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=L.ComponentState.PRESSED:(t.touched||this.values.button>L.ButtonTouchThreshold)&&(this.values.state=L.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===L.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>L.AxisTouchThreshold&&(this.values.state=L.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===L.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>L.AxisTouchThreshold&&(this.values.state=L.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class ms{constructor(e,t,i){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=i,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(s=>{const o=this.layoutDescription.components[s];this.components[s]=new ps(s,o)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const fs="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",bs="generic-trigger";class Cs extends l.Object3D{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e?this:(this.envMap=e,this.traverse(t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),this)}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(i=>{const{valueNode:s,minNode:o,maxNode:n,value:a,valueNodeProperty:r}=i;s&&(r===L.VisualResponseProperty.VISIBILITY?s.visible=a:r===L.VisualResponseProperty.TRANSFORM&&(s.quaternion.slerpQuaternions(o.quaternion,n.quaternion,a),s.position.lerpVectors(o.position,n.position,a)))})}))}}function Is(c,e){Object.values(c.components).forEach(t=>{const{type:i,touchPointNodeName:s,visualResponses:o}=t;if(i===L.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(s),t.touchPointNode){const n=new l.SphereGeometry(.001),a=new l.MeshBasicMaterial({color:255}),r=new l.Mesh(n,a);t.touchPointNode.add(r)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(o).forEach(n=>{const{valueNodeName:a,minNodeName:r,maxNodeName:A,valueNodeProperty:h}=n;if(h===L.VisualResponseProperty.TRANSFORM){if(n.minNode=e.getObjectByName(r),n.maxNode=e.getObjectByName(A),!n.minNode){console.warn(`Could not find ${r} in the model`);return}if(!n.maxNode){console.warn(`Could not find ${A} in the model`);return}}n.valueNode=e.getObjectByName(a),n.valueNode||console.warn(`Could not find ${a} in the model`)})})}function St(c,e){Is(c.motionController,e),c.envMap&&e.traverse(t=>{t.isMesh&&(t.material.envMap=c.envMap,t.material.needsUpdate=!0)}),c.add(e)}class Bs{constructor(e=null,t=null){this.gltfLoader=e,this.path=fs,this._assetCache={},this.onLoad=t,this.gltfLoader||(this.gltfLoader=new We)}setPath(e){return this.path=e,this}createControllerModel(e){const t=new Cs;let i=null;return e.addEventListener("connected",s=>{const o=s.data;o.targetRayMode!=="tracked-pointer"||!o.gamepad||o.hand||hs(o,this.path,bs).then(({profile:n,assetPath:a})=>{t.motionController=new ms(o,n,a);const r=this._assetCache[t.motionController.assetUrl];if(r)i=r.scene.clone(),St(t,i),this.onLoad&&this.onLoad(i);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,A=>{this._assetCache[t.motionController.assetUrl]=A,i=A.scene.clone(),St(t,i),this.onLoad&&this.onLoad(i)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(n=>{console.warn(n)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(i),i=null}),t}}class Es{constructor(e,t){this.renderer=e,this.camera=t,this.controller1=null,this.controller2=null,this.controllerGrip1=null,this.controllerGrip2=null,this.controllers=[],this.controllerGrips=[],this.buttonStates=new Map,this.inputDeadzone=.15,this.turnSmoothingFactor=.1,this.lastTurnInput=0,this.onSelectStart=null,this.onSelectEnd=null,this.onSqueezeStart=null,this.onSqueezeEnd=null,this.onModeToggle=null,this.onMovementStart=null,this.onMovementStop=null,this.handsActive=!1,this.handStates={left:{pinch:!1,fist:!1,direction:new p.Vector3},right:{pinch:!1,fist:!1,direction:new p.Vector3}}}init(){this.initControllers(),this.initHands()}initHands(){const e=this.renderer.xr.getSession&&this.renderer.xr.getSession();e&&(e.addEventListener("inputsourceschange",()=>{this.checkHandsActive()}),this.checkHandsActive())}checkHandsActive(){const e=this.renderer.xr.getSession&&this.renderer.xr.getSession();if(!e)return;let t=!1;for(let i of e.inputSources)i.hand&&(t=!0);this.handsActive=t}updateHandGestures(){const e=this.renderer.xr.getSession&&this.renderer.xr.getSession();if(e){for(let t of e.inputSources)if(t.hand&&t.handedness){const i=t.handedness,s=t.hand.get("thumb-tip"),o=t.hand.get("index-finger-tip");if(!s||!o||!s.transform||!o.transform)console.warn(`[HandTracking] No joint data for ${i} hand:`,{thumbTip:s,indexTip:o}),this.handStates[i].pinch=!1;else{const r=new p.Vector3().setFromMatrixPosition(new p.Matrix4().fromArray(s.transform.matrix)),A=new p.Vector3().setFromMatrixPosition(new p.Matrix4().fromArray(o.transform.matrix)),h=r.distanceTo(A);this.handStates[i].pinch=h<.025,this.handStates[i].pinch}let n=!0;const a=t.hand.get("wrist");if(a&&a.transform){const r=new p.Vector3().setFromMatrixPosition(new p.Matrix4().fromArray(a.transform.matrix));for(let A of["index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]){const h=t.hand.get(A);if(!h||!h.transform){console.warn(`[HandTracking] No joint data for ${A} on ${i} hand.`),n=!1;continue}new p.Vector3().setFromMatrixPosition(new p.Matrix4().fromArray(h.transform.matrix)).distanceTo(r)>.045&&(n=!1)}}else console.warn(`[HandTracking] No palm joint for ${i} hand.`),n=!1;if(this.handStates[i].fist=n,o&&a&&o.transform&&a.transform){const r=new p.Vector3().setFromMatrixPosition(new p.Matrix4().fromArray(a.transform.matrix)),A=new p.Vector3().setFromMatrixPosition(new p.Matrix4().fromArray(o.transform.matrix));this.handStates[i].direction=new p.Vector3().subVectors(A,r).normalize()}}}}initControllers(){const e=new Bs;for(let t=0;t<2;t++){const i=this.renderer.xr.getController(t),s=this.renderer.xr.getControllerGrip(t);s.add(e.createControllerModel(s)),this.camera.parent.add(i),this.camera.parent.add(s),this.controllers.push(i),this.controllerGrips.push(s)}this.setupControllerEvents()}setupControllerEvents(){this.controllers.forEach((e,t)=>{e.addEventListener("connected",i=>{const{handedness:s,targetRayMode:o,profiles:n}=i.data,a=Array.isArray(n)&&n.some(r=>r&&r.toLowerCase().includes("hand"));o!=="tracked-pointer"||a||(s==="left"?(this.controller1=e,this.controllerGrip1=this.controllerGrips[t]):s==="right"&&(this.controller2=e,this.controllerGrip2=this.controllerGrips[t]),e.userData.handedness=s,e.userData.initialised=!0)}),e.addEventListener("disconnected",()=>{}),e.addEventListener("selectstart",i=>{e.userData&&e.userData.initialised&&this.onControllerSelectStart(e,i)}),e.addEventListener("selectend",i=>{e.userData&&e.userData.initialised&&this.onControllerSelectEnd(e,i)}),e.addEventListener("squeezestart",i=>{e.userData&&e.userData.initialised&&this.onControllerSqueezeStart(e,i)}),e.addEventListener("squeezeend",i=>{e.userData&&e.userData.initialised&&this.onControllerSqueezeEnd(e,i)})})}onControllerSelectStart(e,t){const i=e.userData.handedness;this.onSelectStart&&this.onSelectStart(i,e,t)}onControllerSelectEnd(e,t){const i=e.userData.handedness;this.onSelectEnd&&this.onSelectEnd(i,e,t)}onControllerSqueezeStart(e,t){const i=e.userData.handedness;this.onSqueezeStart&&this.onSqueezeStart(i,e,t)}onControllerSqueezeEnd(e,t){const i=e.userData.handedness;this.onSqueezeEnd&&this.onSqueezeEnd(i,e,t)}checkControllerButtons(){const e=this.renderer.xr.getSession();if(e){for(let t of e.inputSources)if(t.gamepad&&t.handedness){const i=t.gamepad,s=t.handedness,o=`debug-${s}`;this.buttonStates.get(o)||this.buttonStates.set(o,!0);let n=[];s==="left"?n=[4,5]:s==="right"&&(n=[4,5]),n.forEach(a=>{if(i.buttons[a]){const r=i.buttons[a],A=`${s}-${a}`,h=this.buttonStates.get(A)||!1,d=r.pressed;d&&!h&&this.onModeToggle&&this.onModeToggle(),this.buttonStates.set(A,d)}})}}}getControllerInput(){const e=this.renderer.xr.getSession();if(!e)return{movement:null,teleport:null};let t=null,i=null;for(let s of e.inputSources)if(s.gamepad&&s.handedness){const o=s.gamepad,n=s.handedness;if(o.axes.length>=4){const a=o.axes[2]||0,r=o.axes[3]||0,A=o.axes[0]||0,h=o.axes[1]||0,d=Math.abs(a)>this.inputDeadzone?a:0,g=Math.abs(r)>this.inputDeadzone?r:0,u=Math.abs(A)>this.inputDeadzone?A:0,m=Math.abs(h)>this.inputDeadzone?h:0;n==="left"?(d!==0||g!==0)&&(t={x:d,y:g,handedness:"left"}):n==="right"&&(u!==0||m!==0)&&(i={x:u,y:m,handedness:"right"})}}return{movement:t,teleport:i}}getControllers(){return{controller1:this.controller1,controller2:this.controller2,controllerGrip1:this.controllerGrip1,controllerGrip2:this.controllerGrip2,controllers:this.controllers,controllerGrips:this.controllerGrips}}dispose(){this.controllers.forEach(e=>{e.parent&&e.parent.remove(e)}),this.controllerGrips.forEach(e=>{e.parent&&e.parent.remove(e)}),this.controller1=null,this.controller2=null,this.controllerGrip1=null,this.controllerGrip2=null,this.controllers=[],this.controllerGrips=[],this.buttonStates.clear()}}class ys{constructor(e,t){this.scene=e,this.camera=t,this.teleportController=null,this.teleportMarker=null,this.teleportCurve=null,this.teleportFloor=null,this.validTeleportPosition=null,this.teleportThreshold=.7,this.teleportReleaseThreshold=.3,this.teleportPressed=!1,this.teleportMaxMagnitude=0,this.teleportFloorHeight=null,this.teleportFloorMin=-10,this.teleportFloorMax=10,this.lastSnapTurnTime=0,this.onTeleport=null,this.onTeleportStart=null,this.onTeleportEnd=null}init(){this.setupTeleportation()}setupTeleportation(){this.createTeleportArc()}createTeleportArc(){const e=[new p.Vector3(0,0,0),new p.Vector3(0,1,-5)],t=new p.CatmullRomCurve3(e),i=new p.TubeGeometry(t,20,.03,8,!1),s=new p.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.8,side:p.DoubleSide});if(this.teleportCurve=new p.Mesh(i,s),this.teleportCurve.visible=!1,this.scene.add(this.teleportCurve),!this.teleportMarker){const o=new p.RingGeometry(.4,.6,20),n=new p.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.9,side:p.DoubleSide});this.teleportMarker=new p.Mesh(o,n),this.teleportMarker.rotation.x=-Math.PI/2,this.teleportMarker.visible=!1,this.scene.add(this.teleportMarker);const a=new p.RingGeometry(.3,.7,20),r=new p.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.3,side:p.DoubleSide}),A=new p.Mesh(a,r);A.rotation.x=-Math.PI/2,this.teleportMarker.add(A)}if(!this.teleportFloor){const o=new p.PlaneGeometry(100,100),n=new p.MeshBasicMaterial({color:65280,transparent:!0,opacity:.1,side:p.DoubleSide,visible:!1});this.teleportFloor=new p.Mesh(o,n),this.teleportFloor.rotation.x=-Math.PI/2,this.teleportFloor.visible=!1,this.scene.add(this.teleportFloor)}}executeTeleport(){if(!this.validTeleportPosition)return;const e=this.validTeleportPosition.clone();this.camera.parent.position.copy(e),this.onTeleport&&this.onTeleport(e),this.validTeleportPosition=null}dashToPosition(e){const t=this.camera.parent.position.clone(),i=t.distanceTo(e),s=Math.min(i*.2,1);let o=0;const n=()=>{o+=1/60;const a=Math.min(o/s,1),r=1-Math.pow(1-a,3);this.camera.parent.position.lerpVectors(t,e,r),a<1&&requestAnimationFrame(n)};n()}processSnapTurn(e,t=30){this.lastSnapTurnTime||(this.lastSnapTurnTime=0);const i=Date.now();if(!(i-this.lastSnapTurnTime<500)&&Math.abs(e)>.7){const s=t*Math.PI/180,o=e>0?1:-1;this.camera.parent.rotation.y-=o*s,this.camera.parent.rotation.y=this.normalizeAngle(this.camera.parent.rotation.y),this.lastSnapTurnTime=i}}normalizeAngle(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}processTeleportation(e,t,i){const s=Math.sqrt(t*t+i*i),o=e&&e.inputSource&&e.inputSource.handedness==="right",n=i;if(s>this.teleportThreshold&&!this.teleportPressed)this.teleportPressed=!0,this.teleportMaxMagnitude=s,this.teleportController=e,this.teleportFloorHeight=this.camera.parent.position.y,this.showTeleportArc(),this.onTeleportStart&&this.onTeleportStart();else if(this.teleportPressed){if(this.teleportMaxMagnitude=Math.max(this.teleportMaxMagnitude,s),o&&Math.abs(n)>.1){const a=.06666666666666667;this.teleportFloorHeight+=n*a,this.teleportFloorHeight=Math.max(this.teleportFloorMin,Math.min(this.teleportFloorMax,this.teleportFloorHeight)),this.updateTeleportFloor()}this.updateTeleportArc(),s<this.teleportReleaseThreshold&&(this.calculateAndExecuteTeleport(),this.hideTeleportArc(),this.teleportPressed=!1,this.teleportMaxMagnitude=0,this.teleportController=null,this.onTeleportEnd&&this.onTeleportEnd())}}showTeleportArc(){this.teleportCurve||this.createTeleportArc(),this.teleportCurve.visible=!0,this.teleportMarker&&(this.teleportMarker.visible=!0,this.teleportMarker.children&&this.teleportMarker.children.length>0&&this.teleportMarker.children.forEach(e=>e.visible=!0)),this.updateTeleportFloor()}hideTeleportArc(){this.teleportCurve&&(this.teleportCurve.visible=!1),this.teleportMarker&&(this.teleportMarker.visible=!1,this.teleportMarker.children&&this.teleportMarker.children.length>0&&this.teleportMarker.children.forEach(e=>e.visible=!1)),this.teleportFloor&&(this.teleportFloor.visible=!1)}updateTeleportArc(){if(!this.teleportController||!this.teleportCurve)return;const e=new p.Vector3;this.teleportController.getWorldPosition(e);const t=new p.Quaternion;this.teleportController.getWorldQuaternion(t);const i=new p.Vector3(0,0,-1);i.applyQuaternion(t);const s=3,o=30,n=Math.min(this.teleportMaxMagnitude/this.teleportThreshold,1),a=o-s,r=Math.pow(n,.7),A=s+a*r,h=[],d=40,g=-9.8;let u=Math.sqrt(A*Math.abs(g)/2);if(i.y>.3?u*=1-i.y*.5:i.y<-.5&&(u*=1+Math.abs(i.y)*.3),Math.sqrt(i.x*i.x+i.z*i.z)>.1){const M=Math.min(1,A/(u*2));u*=M}const I=i.x*u,B=Math.max(i.y*u,u*.3),f=i.z*u,b=B/Math.abs(g),E=Math.max(b*2.2,1.5),C=this.teleportFloorHeight;let y=null,w=!1,S=e.y,k=0,F=8;for(let M=0;M<=d;M++){const D=M/d*E,x=new p.Vector3(e.x+I*D,e.y+B*D+.5*g*D*D,e.z+f*D);Math.abs(x.y-e.y)>F&&(x.y=e.y+Math.sign(x.y-e.y)*F),!w&&x.y<S&&(w=!0,k=D),h.push(x);const W=w?D-k:0,X=w&&W>.1;if(!y&&X&&x.y<=C){if(M>0){const H=h[M-1],T=(C-H.y)/(x.y-H.y);y=new p.Vector3().lerpVectors(H,x,T),y.y=C}else y=x.clone(),y.y=C;h[M]=y,h.length=M+1;break}if(S=x.y,Math.sqrt(Math.pow(x.x-e.x,2)+Math.pow(x.z-e.z,2))>o){X&&(y=new p.Vector3(x.x,C,x.z),h[M]=y,h.length=M+1);break}}if(!y&&h.length>0){let M=h[0],D=0;for(let x=1;x<h.length;x++)h[x].y<M.y&&(M=h[x],D=x);D>h.length/3&&(y=new p.Vector3(M.x,C,M.z),h.length=D+1,h[D]=y)}if(h.length>1){const M=new p.CatmullRomCurve3(h),D=new p.TubeGeometry(M,20,.03,6,!1);this.teleportCurve.geometry&&this.teleportCurve.geometry.dispose(),this.teleportCurve.geometry=D}this.teleportMarker&&y&&(this.teleportMarker.position.copy(y),this.teleportMarker.visible=!0,this.teleportFloorHeight<-.5?this.teleportMarker.material.color.setHex(8965375):this.teleportFloorHeight>.5?this.teleportMarker.material.color.setHex(16777096):this.teleportMarker.material.color.setHex(16777215))}updateTeleportFloor(){this.teleportFloor&&this.teleportFloorHeight!==null&&(this.teleportFloor.position.y=this.teleportFloorHeight,this.teleportFloor.visible=!0,this.teleportFloor.material.visible=!0,this.teleportFloor.material.opacity=.15,this.teleportFloorHeight<-.5?this.teleportFloor.material.color.setHex(4491519):this.teleportFloorHeight>.5?this.teleportFloor.material.color.setHex(16777028):this.teleportFloor.material.color.setHex(4521864),this.updateTeleportArc())}updateTeleportArcHeight(){this.updateTeleportFloor()}calculateAndExecuteTeleport(){if(!(!this.teleportController||this.teleportMaxMagnitude<this.teleportThreshold)&&this.teleportMarker&&this.teleportMarker.visible){const e=this.teleportMarker.position.clone(),t=this.camera.parent.position,i=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.z-t.z,2));if(i>=3&&i<=30){const s=new p.Vector3(e.x,this.teleportFloorHeight,e.z);this.validTeleportPosition=s,this.executeTeleport(),this.teleportFloorHeight=null}}}adjustFloorHeight(e){this.teleportFloorHeight=Math.max(this.teleportFloorMin,Math.min(this.teleportFloorMax,this.teleportFloorHeight+e)),this.updateTeleportFloor()}setFloorHeight(e){this.teleportFloorHeight=Math.max(this.teleportFloorMin,Math.min(this.teleportFloorMax,e)),this.updateTeleportFloor()}resetTeleportState(){this.teleportPressed=!1,this.teleportMaxMagnitude=0,this.teleportController=null,this.validTeleportPosition=null,this.hideTeleportArc()}dispose(){this.teleportCurve&&(this.teleportCurve.geometry&&this.teleportCurve.geometry.dispose(),this.teleportCurve.material&&this.teleportCurve.material.dispose(),this.scene.remove(this.teleportCurve)),this.teleportMarker&&(this.teleportMarker.geometry&&this.teleportMarker.geometry.dispose(),this.teleportMarker.material&&this.teleportMarker.material.dispose(),this.scene.remove(this.teleportMarker)),this.teleportFloor&&(this.teleportFloor.geometry&&this.teleportFloor.geometry.dispose(),this.teleportFloor.material&&this.teleportFloor.material.dispose(),this.scene.remove(this.teleportFloor)),this.resetTeleportState()}resetSnapTurnState(){this.lastSnapTurnTime=0}}class ws{constructor(e,t){this.camera=e,this.renderer=t,this.MOVE_SPEED=2,this.TURN_SPEED=1.5,this.FLY_SPEED=1,this.currentSpeed=0,this.targetSpeed=0,this.currentBoostLevel=0,this.targetBoostLevel=0,this.SPEED_RAMP_RATE=3,this.BOOST_RAMP_RATE=6,this.handMoveActive=!1,this.handMoveBoost=!1,this.handMoveDirection=new p.Vector3,this.isMoving=!1,this.inputDeadzone=.15,this.turnSmoothingFactor=.1,this.lastTurnInput=0,this.comfortSettings={locomotionMode:"smooth",turningMode:"smooth",snapTurnAngle:30,reducedMotion:!1,showTeleportArc:!0,comfortSpeed:.5},this.onMovementStart=null,this.onMovementStop=null,this.onMovementUpdate=null,this.teleportSystem=null}init(){this.setupLocomotion()}startMovement(e="forward"){this.isMoving=!0,this.targetSpeed=this.MOVE_SPEED,this.onMovementStart&&this.onMovementStart()}stopMovement(){this.isMoving=!1,this.targetSpeed=0,this.onMovementStop&&this.onMovementStop()}setTeleportSystem(e){this.teleportSystem=e}updateMovement(e,t){const i=this.renderer.xr.getSession();if(!i||i.visibilityState!=="visible")return;if(t.updateHandGestures&&t.handsActive){t.updateHandGestures();let d=null,g=new p.Vector3,u=!1;for(const m of["left","right"])if(t.handStates[m].pinch){d=m,g.copy(t.handStates[m].direction),u=t.handStates[m].fist;break}if(d){this.handMoveActive=!0,this.handMoveBoost=u,this.handMoveDirection.copy(g);const m=this.MOVE_SPEED*(u?3:1)*e;this.camera.parent.position.addScaledVector(g,m),this.isMoving=!0,this.onMovementStart&&!this._wasMoving&&this.onMovementStart(),this.onMovementUpdate&&this.onMovementUpdate({isMoving:!0,currentSpeed:this.MOVE_SPEED,isBoosted:u,currentBoostLevel:u?1:0}),this._wasMoving=!0;return}else this.handMoveActive&&this.onMovementStop&&this.onMovementStop(),this.handMoveActive=!1,this.isMoving=!1,this._wasMoving=!1}if(!t.controller1||!t.controller2)return;let s=!1,o=!1;for(let d=0;d<i.inputSources.length;d++){const g=i.inputSources[d];if(!g||!g.gamepad||!g.gamepad.buttons||!g.gamepad.axes||g.gamepad.axes.length<4)continue;const u=g.gamepad,I=g.handedness==="left"?t.controller1:t.controller2;if(!I)continue;const B=u.axes[2]||0,f=u.axes[3]||0;if(g.handedness==="left"){const b=u.buttons[1],E=b&&b.pressed?3:1,C=this.comfortSettings.reducedMotion?this.comfortSettings.comfortSpeed:1;if(b&&b.pressed&&(o=!0),this.comfortSettings.locomotionMode==="teleport"&&this.teleportSystem){this.teleportSystem.processTeleportation(I,B,f);continue}else{const y=new p.Vector3;this.camera.getWorldDirection(y),y.y=0,y.normalize();const w=new p.Vector3().crossVectors(y,this.camera.up).normalize();if(Math.abs(f)>.1){const S=this.MOVE_SPEED*E*C*this.currentSpeed*e;this.camera.parent.position.addScaledVector(y,-f*S),s=!0}if(Math.abs(B)>.1){const S=this.MOVE_SPEED*E*C*this.currentSpeed*e;this.camera.parent.position.addScaledVector(w,B*S),s=!0}}}if(g.handedness==="right"){const b=u.buttons[1],E=b&&b.pressed?3:1,C=this.comfortSettings.reducedMotion?this.comfortSettings.comfortSpeed:1;if(b&&b.pressed&&Math.abs(f)>.1&&(o=!0),this.teleportSystem&&this.teleportSystem.teleportPressed&&this.teleportSystem.teleportCurve&&this.teleportSystem.teleportCurve.visible){if(Math.abs(f)>.1){const y=4*e;this.teleportSystem.adjustFloorHeight(f*y)}}else{if(this.comfortSettings.turningMode==="snap"&&this.teleportSystem)this.teleportSystem.processSnapTurn(B,this.comfortSettings.snapTurnAngle);else if(Math.abs(B)>this.inputDeadzone){const y=this.lastTurnInput*this.turnSmoothingFactor+B*(1-this.turnSmoothingFactor);if(this.lastTurnInput=y,Math.abs(y)>this.inputDeadzone){const w=this.comfortSettings.reducedMotion?this.TURN_SPEED*.5:this.TURN_SPEED,S=y*w*Math.min(e,1/30);this.camera.parent.rotation.y-=S,this.camera.parent.rotation.y=this.normalizeAngle(this.camera.parent.rotation.y)}}else this.lastTurnInput*=.9;if(Math.abs(f)>.1){const y=this.FLY_SPEED*E*C*this.currentSpeed*e;this.camera.parent.position.y-=f*y,s=!0}}}}const n=this.isMoving;this.isMoving=s;const r=(this.isMoving?this.MOVE_SPEED:0)-this.currentSpeed;this.currentSpeed+=r*this.SPEED_RAMP_RATE*e,this.currentSpeed=Math.max(0,this.currentSpeed);const h=(o?1:0)-this.currentBoostLevel;this.currentBoostLevel+=h*this.BOOST_RAMP_RATE*e,this.currentBoostLevel=Math.max(0,Math.min(1,this.currentBoostLevel)),!n&&this.isMoving&&this.onMovementStart&&this.onMovementStart(),n&&!this.isMoving&&this.onMovementStop&&this.onMovementStop(),this.onMovementUpdate&&this.onMovementUpdate({isMoving:this.isMoving,currentSpeed:this.currentSpeed,isBoosted:o,currentBoostLevel:this.currentBoostLevel})}normalizeAngle(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}correctDrift(){const e=this.camera.parent;e.rotation.y=this.normalizeAngle(e.rotation.y),e.position.x=Math.round(e.position.x*1e3)/1e3,e.position.y=Math.round(e.position.y*1e3)/1e3,e.position.z=Math.round(e.position.z*1e3)/1e3}setComfortSettings(e){const t=["smooth","teleport"],i=["smooth","snap"];if(e.locomotionMode&&t.includes(e.locomotionMode)){const s=this.comfortSettings.locomotionMode;this.comfortSettings.locomotionMode=e.locomotionMode,s!==e.locomotionMode&&this.teleportSystem&&this.teleportSystem.resetTeleportState()}if(e.turningMode&&i.includes(e.turningMode)){const s=this.comfortSettings.turningMode;this.comfortSettings.turningMode=e.turningMode,s!==e.turningMode&&this.teleportSystem&&this.teleportSystem.resetSnapTurnState()}typeof e.snapTurnAngle=="number"&&e.snapTurnAngle>0&&e.snapTurnAngle<=90&&(this.comfortSettings.snapTurnAngle=e.snapTurnAngle),typeof e.reducedMotion=="boolean"&&(this.comfortSettings.reducedMotion=e.reducedMotion),typeof e.showTeleportArc=="boolean"&&(this.comfortSettings.showTeleportArc=e.showTeleportArc),typeof e.comfortSpeed=="number"&&e.comfortSpeed>0&&e.comfortSpeed<=2&&(this.comfortSettings.comfortSpeed=e.comfortSpeed),this.ensureComfortSettingsApplied()}getComfortSettings(){return{...this.comfortSettings}}setComfortPreset(e){const t={"max-comfort":{locomotionMode:"teleport",turningMode:"snap",snapTurnAngle:30,reducedMotion:!0,showTeleportArc:!0,comfortSpeed:.3},balanced:{locomotionMode:"smooth",turningMode:"smooth",reducedMotion:!0,showTeleportArc:!0,comfortSpeed:.7},performance:{locomotionMode:"smooth",turningMode:"smooth",reducedMotion:!1,showTeleportArc:!1,comfortSpeed:1}};t[e]?this.setComfortSettings(t[e]):console.warn(`Unknown comfort preset: ${e}`)}setupLocomotion(){}ensureComfortSettingsApplied(){}getMovementState(){return{isMoving:this.isMoving,currentSpeed:this.currentSpeed,targetSpeed:this.targetSpeed,currentBoostLevel:this.currentBoostLevel,targetBoostLevel:this.targetBoostLevel}}}class Ss{constructor(){this.settings={locomotionMode:"smooth",turningMode:"smooth",snapTurnAngle:30,reducedMotion:!1,showTeleportArc:!0,comfortSpeed:.5},this.presets={"max-comfort":{locomotionMode:"teleport",turningMode:"snap",snapTurnAngle:30,reducedMotion:!0,showTeleportArc:!0,comfortSpeed:.3},balanced:{locomotionMode:"smooth",turningMode:"smooth",reducedMotion:!0,showTeleportArc:!0,comfortSpeed:.7},performance:{locomotionMode:"smooth",turningMode:"smooth",reducedMotion:!1,showTeleportArc:!1,comfortSpeed:1}},this.onSettingsChange=null}setSettings(e){const t=["smooth","teleport"],i=["smooth","snap"];let s=!1;return e.locomotionMode&&t.includes(e.locomotionMode)&&this.settings.locomotionMode!==e.locomotionMode&&(this.settings.locomotionMode=e.locomotionMode,s=!0),e.turningMode&&i.includes(e.turningMode)&&this.settings.turningMode!==e.turningMode&&(this.settings.turningMode=e.turningMode,s=!0),typeof e.snapTurnAngle=="number"&&e.snapTurnAngle>0&&e.snapTurnAngle<=90&&this.settings.snapTurnAngle!==e.snapTurnAngle&&(this.settings.snapTurnAngle=e.snapTurnAngle,s=!0),typeof e.reducedMotion=="boolean"&&this.settings.reducedMotion!==e.reducedMotion&&(this.settings.reducedMotion=e.reducedMotion,s=!0),typeof e.showTeleportArc=="boolean"&&this.settings.showTeleportArc!==e.showTeleportArc&&(this.settings.showTeleportArc=e.showTeleportArc,s=!0),typeof e.comfortSpeed=="number"&&e.comfortSpeed>0&&e.comfortSpeed<=2&&this.settings.comfortSpeed!==e.comfortSpeed&&(this.settings.comfortSpeed=e.comfortSpeed,s=!0),s&&this.onSettingsChange&&this.onSettingsChange(this.settings),s}getSettings(){return{...this.settings}}setPreset(e){return this.presets[e]?(this.setSettings(this.presets[e]),!0):(console.warn(`Unknown comfort preset: ${e}`),!1)}getPresets(){return Object.keys(this.presets)}getPreset(e){return this.presets[e]?{...this.presets[e]}:null}addCustomPreset(e,t){const i={};return t.locomotionMode&&["smooth","teleport"].includes(t.locomotionMode)&&(i.locomotionMode=t.locomotionMode),t.turningMode&&["smooth","snap"].includes(t.turningMode)&&(i.turningMode=t.turningMode),typeof t.snapTurnAngle=="number"&&t.snapTurnAngle>0&&t.snapTurnAngle<=90&&(i.snapTurnAngle=t.snapTurnAngle),typeof t.reducedMotion=="boolean"&&(i.reducedMotion=t.reducedMotion),typeof t.showTeleportArc=="boolean"&&(i.showTeleportArc=t.showTeleportArc),typeof t.comfortSpeed=="number"&&t.comfortSpeed>0&&t.comfortSpeed<=2&&(i.comfortSpeed=t.comfortSpeed),Object.keys(i).length>0?(this.presets[e]=i,!0):(console.warn("Invalid settings for custom preset"),!1)}toggleLocomotionMode(){const e=this.settings.locomotionMode==="smooth"?"teleport":"smooth";return this.setSettings({locomotionMode:e})}toggleTurningMode(){const e=this.settings.turningMode==="smooth"?"snap":"smooth";return this.setSettings({turningMode:e})}toggleReducedMotion(){return this.setSettings({reducedMotion:!this.settings.reducedMotion})}getComfortLevel(){let e=0;return this.settings.locomotionMode==="teleport"?e+=40:this.settings.locomotionMode==="smooth"&&(e+=20),this.settings.turningMode==="snap"?e+=30:this.settings.turningMode==="smooth"&&(e+=15),this.settings.reducedMotion&&(e+=20),this.settings.comfortSpeed<=.5?e+=10:this.settings.comfortSpeed<=.8&&(e+=5),Math.min(100,e)}getRecommendations(){const e=[];return this.settings.locomotionMode==="smooth"&&e.push("Consider teleportation for maximum comfort"),this.settings.turningMode==="smooth"&&e.push("Try snap turning to reduce motion sickness"),this.settings.reducedMotion||e.push("Enable reduced motion for gentler movement"),this.settings.comfortSpeed>.8&&e.push("Lower movement speed for increased comfort"),e}exportSettings(){return JSON.stringify(this.settings,null,2)}importSettings(e){try{const t=JSON.parse(e);return this.setSettings(t)}catch(t){return console.error("Failed to import settings:",t),!1}}}class Qs{constructor(){this.soundEnabled=!1,this.audioContext=null,this.dpvSound=null,this.dpvHighSound=null,this.ambienceSound=null,this.currentMovementSound=null,this.currentBoostSound=null,this.currentAmbienceSound=null,this.baseGainNode=null,this.boostGainNode=null,this.ambienceGainNode=null,this.baseVolumeMultiplier=1.52,this.boostVolumeMultiplier=1.01,this.ambienceVolume=.1}async init(e="./sound/"){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext);const[t,i,s]=await Promise.all([this.loadAudioBuffer(e+"dpv.ogg"),this.loadAudioBuffer(e+"dpvhigh.ogg"),this.loadAudioBuffer(e+"vrambience.ogg")]);this.dpvSound=t,this.dpvHighSound=i,this.ambienceSound=s,this.startAmbientSound(),this.soundEnabled=!0}catch(t){console.warn("🔇 VR Audio initialization failed:",t),this.soundEnabled=!1}}async loadAudioBuffer(e){const i=await(await fetch(e)).arrayBuffer();return await this.audioContext.decodeAudioData(i)}initAudioOnInteraction(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume()}startAmbientSound(){if(!(!this.audioContext||!this.ambienceSound||this.currentAmbienceSound))try{const e=this.audioContext.createBufferSource();this.ambienceGainNode=this.audioContext.createGain(),e.buffer=this.ambienceSound,e.connect(this.ambienceGainNode),this.ambienceGainNode.connect(this.audioContext.destination),e.loop=!0,this.ambienceGainNode.gain.setValueAtTime(this.ambienceVolume,this.audioContext.currentTime),e.start(),this.currentAmbienceSound=e}catch(e){console.warn("🔇 Error starting ambient sound:",e)}}stopAmbientSound(){if(this.currentAmbienceSound&&this.ambienceGainNode&&this.audioContext)try{this.currentAmbienceSound.stop(),this.currentAmbienceSound=null,this.ambienceGainNode=null}catch(e){console.warn("🔇 Error stopping ambient sound:",e)}}startMovementSound(){if(!(!this.audioContext||!this.dpvSound||!this.dpvHighSound)){this.currentMovementSound&&(this.currentMovementSound.stop(),this.currentMovementSound=null),this.currentBoostSound&&(this.currentBoostSound.stop(),this.currentBoostSound=null),this.baseGainNode&&this.baseGainNode.disconnect(),this.boostGainNode&&this.boostGainNode.disconnect();try{const e=this.audioContext.createBufferSource();this.baseGainNode=this.audioContext.createGain(),e.buffer=this.dpvSound,e.connect(this.baseGainNode),this.baseGainNode.connect(this.audioContext.destination),e.loop=!0,this.baseGainNode.gain.setValueAtTime(0,this.audioContext.currentTime),e.start(),this.currentMovementSound=e;const t=this.audioContext.createBufferSource();this.boostGainNode=this.audioContext.createGain(),t.buffer=this.dpvHighSound,t.connect(this.boostGainNode),this.boostGainNode.connect(this.audioContext.destination),t.loop=!0,this.boostGainNode.gain.setValueAtTime(0,this.audioContext.currentTime),t.start(),this.currentBoostSound=t}catch(e){console.warn("🔇 Error playing movement sound:",e)}}}stopMovementSound(){if(this.baseGainNode&&this.audioContext)try{this.baseGainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+.2),setTimeout(()=>{this.currentMovementSound&&(this.currentMovementSound.stop(),this.currentMovementSound=null)},250)}catch(e){console.warn("🔇 Error stopping base movement sound:",e)}if(this.boostGainNode&&this.audioContext)try{this.boostGainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+.2),setTimeout(()=>{this.currentBoostSound&&(this.currentBoostSound.stop(),this.currentBoostSound=null),this.baseGainNode=null,this.boostGainNode=null},250)}catch(e){console.warn("🔇 Error stopping boost movement sound:",e)}}updateAudioLevels(e,t){if(!(!this.baseGainNode||!this.boostGainNode||!this.audioContext))try{const i=e*this.baseVolumeMultiplier,s=t*this.boostVolumeMultiplier;this.baseGainNode.gain.linearRampToValueAtTime(i,this.audioContext.currentTime+.1),this.boostGainNode.gain.linearRampToValueAtTime(s,this.audioContext.currentTime+.1)}catch(i){console.warn("🔇 Error updating audio levels:",i)}}setVolumeMultipliers(e,t,i){typeof e=="number"&&e>=0&&(this.baseVolumeMultiplier=e),typeof t=="number"&&t>=0&&(this.boostVolumeMultiplier=t),typeof i=="number"&&i>=0&&(this.ambienceVolume=i,this.ambienceGainNode&&this.ambienceGainNode.gain.setValueAtTime(i,this.audioContext.currentTime))}getAudioStatus(){return{enabled:this.soundEnabled,contextState:this.audioContext?this.audioContext.state:"none",ambiencePlaying:!!this.currentAmbienceSound,movementPlaying:!!this.currentMovementSound,boostPlaying:!!this.currentBoostSound}}setMuted(e){if(this.audioContext)try{const t=e?0:1;this.ambienceGainNode&&this.ambienceGainNode.gain.linearRampToValueAtTime(e?0:this.ambienceVolume,this.audioContext.currentTime+.1),this.baseGainNode&&this.baseGainNode.gain.linearRampToValueAtTime(t,this.audioContext.currentTime+.1),this.boostGainNode&&this.boostGainNode.gain.linearRampToValueAtTime(t,this.audioContext.currentTime+.1)}catch(t){console.warn("🔇 Error setting mute state:",t)}}dispose(){if(this.stopAmbientSound(),this.stopMovementSound(),this.audioContext)try{this.audioContext.close(),this.audioContext=null}catch(e){console.warn("🔇 Audio context disposal failed:",e)}this.dpvSound=null,this.dpvHighSound=null,this.ambienceSound=null,this.currentMovementSound=null,this.currentBoostSound=null,this.currentAmbienceSound=null,this.baseGainNode=null,this.boostGainNode=null,this.ambienceGainNode=null,this.soundEnabled=!1}}class Qt{constructor(e,t,i,s="./sound/",o=!0,n=null){this.renderer=e,this.camera=t,this.scene=i,this.audioPath=s,this.enableAudio=o,this.container=n,this.vrCore=new ls(e,t,i,n),this.vrControllers=new Es(e,t),this.vrTeleport=new ys(i,t),this.vrLocomotion=new ws(t,e),this.vrComfort=new Ss,this.vrAudio=this.enableAudio?new Qs:null,this.isVRSupported=!1,this.isVRPresenting=!1,this.controller1=null,this.controller2=null,this.controllerGrip1=null,this.controllerGrip2=null,this.controllers=[],this.controllerGrips=[],this._preVRCameraState={target:null,position:null,zoom:null,minDistance:null,maxDistance:null,enableDamping:null,dampingFactor:null,enableZoom:null,enablePan:null,enableRotate:null,autoRotate:null,autoRotateSpeed:null,controls:null},this.lastComfortLog=0,this.onModeToggle=null,this.onMovementStart=null,this.onMovementStop=null,this.onMovementUpdate=null,this.init()}init(){this.vrCore.init(),this.vrControllers.init(),this.vrTeleport.init(),this.vrLocomotion.init(),this.setupModuleConnections(),this.vrAudio&&this.vrAudio.init(this.audioPath).catch(e=>{console.warn("🔇 Sound system initialization failed:",e)})}setupModuleConnections(){this.vrCore.onSessionStart=()=>{console.debug("[VRManager] VR session starting - saving camera state"),this._saveCameraState(),this.isVRPresenting=!0,this.vrAudio&&this.vrAudio.initAudioOnInteraction()},this.vrCore.onSessionEnd=()=>{console.debug("[VRManager] VR session ending - will restore camera state"),this.isVRPresenting=!1,setTimeout(()=>{this._restoreCameraState()},100)},this.vrControllers.onSelectStart=(e,t,i)=>{},this.vrControllers.onSelectEnd=(e,t,i)=>{},this.vrControllers.onSqueezeStart=(e,t,i)=>{this.vrLocomotion.currentBoostLevel=1,this.vrLocomotion.targetBoostLevel=1},this.vrControllers.onSqueezeEnd=(e,t,i)=>{this.vrLocomotion.currentBoostLevel=0,this.vrLocomotion.targetBoostLevel=0},this.vrControllers.onModeToggle=()=>{this.onModeToggle&&this.onModeToggle()},this.vrLocomotion.onMovementStart=()=>{this.vrAudio&&this.vrAudio.startMovementSound(),this.onMovementStart&&this.onMovementStart()},this.vrLocomotion.onMovementStop=()=>{this.vrAudio&&this.vrAudio.stopMovementSound(),this.onMovementStop&&this.onMovementStop()},this.vrLocomotion.onMovementUpdate=e=>{this.vrAudio&&this.vrAudio.updateAudioLevels(e.currentSpeed,e.currentBoostLevel),this.onMovementUpdate&&this.onMovementUpdate(e)},this.vrComfort.onSettingsChange=e=>{this.vrLocomotion.setComfortSettings(e)},this.vrLocomotion.setTeleportSystem(this.vrTeleport),typeof this._comfortSettingsInitialized>"u"&&(this.vrLocomotion.setComfortSettings(this.vrComfort.getSettings()),this._comfortSettingsInitialized=!0)}startMovement(e="forward"){this.vrLocomotion.startMovement(e)}stopMovement(){this.vrLocomotion.stopMovement()}update(e){this.vrControllers.checkControllerButtons();const t={...this.vrControllers.getControllers(),handsActive:this.vrControllers.handsActive,handStates:this.vrControllers.handStates,updateHandGestures:this.vrControllers.updateHandGestures?this.vrControllers.updateHandGestures.bind(this.vrControllers):void 0};this.vrLocomotion.updateMovement(e,t),this.syncLegacyProperties(),this.ensureComfortSettingsApplied(),this.vrLocomotion.correctDrift()}syncLegacyProperties(){const e=this.vrCore.getVRStatus();this.isVRSupported=e.supported,this.isVRPresenting=e.presenting;const t=this.vrControllers.getControllers();this.controller1=t.controller1,this.controller2=t.controller2,this.controllerGrip1=t.controllerGrip1,this.controllerGrip2=t.controllerGrip2,this.controllers=t.controllers,this.controllerGrips=t.controllerGrips}setComfortSettings(e){this.vrComfort.setSettings(e)}getComfortSettings(){return this.vrComfort.getSettings()}setComfortPreset(e){this.vrComfort.setPreset(e)}ensureComfortSettingsApplied(){if(!this.isVRPresenting)return;this.vrComfort.getSettings().locomotionMode==="teleport"&&(!this.vrTeleport.teleportCurve||!this.vrTeleport.teleportMarker)&&this.vrTeleport.setupTeleportation(),(!this.lastComfortLog||Date.now()-this.lastComfortLog>1e4)&&(this.lastComfortLog=Date.now())}applyVRPositions(e){if(!(!this.isVRPresenting||!e))try{e.camera&&(this.camera.position.copy(e.camera.position),this.camera.quaternion.copy(e.camera.quaternion)),e.dolly&&(this.camera.parent.position.copy(e.dolly.position),this.camera.parent.quaternion.copy(e.dolly.quaternion))}catch(t){console.warn("VR position application failed:",t)}}setControls(e){this._preVRCameraState.controls=e}_saveCameraState(){if(this._preVRCameraState.controls&&this._preVRCameraState.controls.target&&this.camera){const e=this._preVRCameraState.controls;this._preVRCameraState.target=e.target.clone(),this._preVRCameraState.position=this.camera.position.clone(),this._preVRCameraState.zoom=this.camera.zoom,this._preVRCameraState.minDistance=e.minDistance,this._preVRCameraState.maxDistance=e.maxDistance,this._preVRCameraState.enableDamping=e.enableDamping,this._preVRCameraState.dampingFactor=e.dampingFactor,this._preVRCameraState.enableZoom=e.enableZoom,this._preVRCameraState.enablePan=e.enablePan,this._preVRCameraState.enableRotate=e.enableRotate,this._preVRCameraState.autoRotate=e.autoRotate,this._preVRCameraState.autoRotateSpeed=e.autoRotateSpeed,console.debug("[VRManager] Saved complete pre-VR camera state:",{target:this._preVRCameraState.target.toArray(),position:this._preVRCameraState.position.toArray(),zoom:this._preVRCameraState.zoom,minDistance:this._preVRCameraState.minDistance,maxDistance:this._preVRCameraState.maxDistance,enableDamping:this._preVRCameraState.enableDamping})}}_restoreCameraState(){if(!this._preVRCameraState.controls||!this._preVRCameraState.target||!this._preVRCameraState.position){console.debug("[VRManager] No saved camera state to restore");return}const e=this._preVRCameraState.controls;console.debug("[VRManager] Restoring complete camera state from pre-VR:",{target:this._preVRCameraState.target.toArray(),position:this._preVRCameraState.position.toArray(),zoom:this._preVRCameraState.zoom}),this.camera.position.copy(this._preVRCameraState.position),this.camera.zoom=this._preVRCameraState.zoom||1,this.camera.updateProjectionMatrix(),e.target.copy(this._preVRCameraState.target),e.minDistance=this._preVRCameraState.minDistance,e.maxDistance=this._preVRCameraState.maxDistance,e.enableDamping=this._preVRCameraState.enableDamping,e.dampingFactor=this._preVRCameraState.dampingFactor,e.enableZoom=this._preVRCameraState.enableZoom,e.enablePan=this._preVRCameraState.enablePan,e.enableRotate=this._preVRCameraState.enableRotate,e.autoRotate=this._preVRCameraState.autoRotate,e.autoRotateSpeed=this._preVRCameraState.autoRotateSpeed,e.update(),console.debug("[VRManager] Camera state restoration complete")}getVRStatus(){const e=this.vrCore.getVRStatus(),t=this.vrAudio?this.vrAudio.getAudioStatus():{enabled:!1},i=this.vrLocomotion.getMovementState(),s=this.vrComfort.getSettings();return{...e,audio:t,movement:i,comfort:s}}setAudioMuted(e){this.vrAudio&&this.vrAudio.setMuted(e)}setAudioVolumeMultipliers(e,t,i){this.vrAudio&&this.vrAudio.setVolumeMultipliers(e,t,i)}resetTeleportState(){this.vrTeleport.resetTeleportState()}dispose(){this.vrCore.dispose(),this.vrControllers.dispose(),this.vrTeleport.dispose(),this.vrAudio&&this.vrAudio.dispose(),this.onModeToggle=null,this.onMovementStart=null,this.onMovementStop=null,this.onMovementUpdate=null}checkVRSupport(){return this.vrCore.checkVRSupported()}normalizeAngle(e){return this.vrLocomotion.normalizeAngle(e)}}class Mt{static init(e){typeof window>"u"||(window.belowViewer=e,window.camera=()=>{var n,a;if(!((n=e.cameraManager)!=null&&n.camera)||!((a=e.cameraManager)!=null&&a.controls))return console.warn("Camera not initialized"),null;const t=e.cameraManager.camera.position,i=e.cameraManager.controls.target,s=e.dolly?{dolly:{x:parseFloat(e.dolly.position.x.toFixed(3)),y:parseFloat(e.dolly.position.y.toFixed(3)),z:parseFloat(e.dolly.position.z.toFixed(3))},rotation:{x:parseFloat(e.dolly.rotation.x.toFixed(3)),y:parseFloat(e.dolly.rotation.y.toFixed(3)),z:parseFloat(e.dolly.rotation.z.toFixed(3))}}:{dolly:{x:0,y:2,z:15},rotation:{x:0,y:0,z:0}},o={desktop:{camera:{x:parseFloat(t.x.toFixed(3)),y:parseFloat(t.y.toFixed(3)),z:parseFloat(t.z.toFixed(3))},target:{x:parseFloat(i.x.toFixed(3)),y:parseFloat(i.y.toFixed(3)),z:parseFloat(i.z.toFixed(3))}},vr:s};return console.log("🎥 Current camera positions:"),console.log("📋 Copy this for initialPositions config:"),console.log(JSON.stringify(o,null,2)),o},window.scene=()=>{var s;if(!((s=e.sceneManager)!=null&&s.scene))return console.warn("Scene not initialized"),null;const t=e.sceneManager.scene,i={children:t.children.length,lights:t.children.filter(o=>o.isLight).length,meshes:t.children.filter(o=>o.isMesh).length,groups:t.children.filter(o=>o.isGroup).length,background:t.background,fog:t.fog?{type:t.fog.constructor.name,color:t.fog.color.getHexString(),near:t.fog.near,far:t.fog.far}:null};return console.log("🌍 Scene information:"),console.table(i),console.log("Scene object:",t),{info:i,scene:t}},window.models=()=>{const t=e.getLoadedModels();if(t.length===0)return console.log("📦 No models loaded"),[];const i=t.map((s,o)=>{const n=s.model,a=n.userData.boundingBox;return{index:o,url:s.url,name:n.name||"Unnamed",position:{x:parseFloat(n.position.x.toFixed(3)),y:parseFloat(n.position.y.toFixed(3)),z:parseFloat(n.position.z.toFixed(3))},rotation:{x:parseFloat(n.rotation.x.toFixed(3)),y:parseFloat(n.rotation.y.toFixed(3)),z:parseFloat(n.rotation.z.toFixed(3))},scale:{x:parseFloat(n.scale.x.toFixed(3)),y:parseFloat(n.scale.y.toFixed(3)),z:parseFloat(n.scale.z.toFixed(3))},boundingBox:a?{min:{x:parseFloat(a.min.x.toFixed(3)),y:parseFloat(a.min.y.toFixed(3)),z:parseFloat(a.min.z.toFixed(3))},max:{x:parseFloat(a.max.x.toFixed(3)),y:parseFloat(a.max.y.toFixed(3)),z:parseFloat(a.max.z.toFixed(3))}}:null,visible:n.visible,children:n.children.length}});return console.log("📦 Loaded models:"),console.table(i),{models:i,rawData:t}},window.vr=()=>{if(!e.vrManager)return console.log("🥽 VR not enabled"),null;const t={isPresenting:e.isVRPresenting(),isSupported:navigator.xr!==void 0,dollyPosition:e.dolly?{x:parseFloat(e.dolly.position.x.toFixed(3)),y:parseFloat(e.dolly.position.y.toFixed(3)),z:parseFloat(e.dolly.position.z.toFixed(3))}:null,comfortSettings:e.getVRComfortSettings()};return console.log("🥽 VR information:"),console.table(t),t},window.debugHelp=()=>{console.log("🔧 BelowJS Debug Commands:"),console.log("  camera()    - Get current camera position data"),console.log("  scene()     - Get scene information and object counts"),console.log("  models()    - Get loaded models information"),console.log("  vr()        - Get VR state and settings"),console.log("  debugHelp() - Show this help message"),console.log(""),console.log("Global objects:"),console.log("  belowViewer - Direct access to BelowViewer instance")},console.log("🔧 BelowJS debug commands loaded! Type debugHelp() for available commands."))}static cleanup(){typeof window>"u"||(delete window.camera,delete window.scene,delete window.models,delete window.vr,delete window.debugHelp,delete window.belowViewer)}}class vt extends le{constructor(e,t={}){var i;super(),this.container=e,this.config=qe.validate(t),this.renderer=null,this.sceneManager=null,this.cameraManager=null,this.modelLoader=null,this.vrManager=null,this.isVREnabled=((i=this.config.vr)==null?void 0:i.enabled)!==!1,this.dolly=null,this.isInitialized=!1,this.loadedModels=[],this.currentAbortController=null,this.init()}init(){try{this.initRenderer(),this.sceneManager=new je(this.config.scene),this.cameraManager=new Ye(this.config.camera),this.modelLoader=new O(this.renderer),this.isVREnabled&&this.initVR(),this.cameraManager.initControls(this.renderer.domElement),this.setupEventListeners(),this.startRenderLoop(),this.isInitialized=!0,typeof window<"u"&&Mt.init(this),this.emit("initialized")}catch(e){console.error("Failed to initialize BelowViewer:",e),this.emit("error",e)}}initRenderer(){this.renderer=new p.WebGLRenderer({antialias:this.config.renderer.antialias,alpha:this.config.renderer.alpha,powerPreference:this.config.renderer.powerPreference}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=p.PCFSoftShadowMap,this.renderer.outputColorSpace=p.SRGBColorSpace,this.config.renderer.toneMapping==="aces-filmic"?this.renderer.toneMapping=p.ACESFilmicToneMapping:this.config.renderer.toneMapping==="none"&&(this.renderer.toneMapping=p.NoToneMapping),this.renderer.toneMappingExposure=this.config.renderer.toneMappingExposure,this.container.appendChild(this.renderer.domElement)}initVR(){this.dolly=new p.Group,this.dolly.add(this.cameraManager.camera),this.sceneManager.scene.add(this.dolly);const e=this.config.audioPath||"./sound/",t=this.config.enableVRAudio!==!1;this.vrManager=new Qt(this.renderer,this.cameraManager.camera,this.sceneManager.scene,e,t,this.container),this.vrManager.setControls(this.cameraManager.controls),this.vrManager.onModeToggle=()=>{this.emit("vr-mode-toggle")},this.vrManager.onMovementStart=()=>{this.emit("vr-movement-start")},this.vrManager.onMovementStop=()=>{this.emit("vr-movement-stop")},this.vrManager.onMovementUpdate=(i,s)=>{this.emit("vr-movement-update",{speed:i,boostLevel:s})},this.vrManager.onSessionStart=()=>{if(this.loadedModels.length>0){const i=this.loadedModels[this.loadedModels.length-1];i.options&&i.options.initialPositions&&this.vrManager.applyVRPositions(i.options.initialPositions)}this.cameraManager.controls&&(this.cameraManager.controls.enabled=!1),this.emit("vr-session-start")},this.vrManager.onSessionEnd=()=>{if(this.cameraManager.controls&&(this.cameraManager.controls.enabled=!0,this.cameraManager.controls.update()),this.dolly.position.set(0,0,0),this.dolly.rotation.set(0,0,0),this.loadedModels.length>0){const i=this.loadedModels[this.loadedModels.length-1];i.options&&i.options.initialPositions&&i.options.initialPositions.desktop&&this.applyDesktopPositions(i.options.initialPositions.desktop)}this.emit("vr-session-end")}}setupEventListeners(){window.addEventListener("resize",this.onWindowResize.bind(this)),this.cameraManager&&this.cameraManager.on("change",()=>{this.emit("camera-change")})}onWindowResize(){if(!this.isInitialized)return;const e=this.container.clientWidth,t=this.container.clientHeight;this.cameraManager.setSize(e,t),this.renderer.setSize(e,t),this.emit("resize",{width:e,height:t})}async loadModel(e,t={}){this.currentAbortController&&this.currentAbortController.abort(),this.currentAbortController=new AbortController;const i=this.currentAbortController.signal;try{this.emit("model-load-start",{url:e});const s=a=>{i.aborted||this.emit("model-load-progress",{url:e,progress:a})},o=await this.modelLoader.load(e,s,i);if(i.aborted)return null;t.position&&o.position.fromArray(t.position),t.rotation&&o.rotation.fromArray(t.rotation),t.scale&&(typeof t.scale=="number"?o.scale.setScalar(t.scale):o.scale.fromArray(t.scale));const n=this.centerModel(o);return this.sceneManager.add(o),this.loadedModels.push({model:o,url:e,options:t,originalCenter:n}),this.loadedModels.length===1&&t.autoFrame!==!1&&this.frameModel(o),this.currentAbortController&&this.currentAbortController.signal===i&&(this.currentAbortController=null),this.emit("model-loaded",{model:o,url:e}),o}catch(s){if(this.currentAbortController&&this.currentAbortController.signal===i&&(this.currentAbortController=null),!i.aborted&&s.message!=="Loading cancelled")throw console.error("Failed to load model:",s),this.emit("model-load-error",{url:e,error:s}),s;if(i.aborted||s.message==="Loading cancelled")return this.emit("model-load-cancelled",{url:e}),null;throw s}}frameModel(e){if(!e.userData.boundingBox){const o=new p.Box3().setFromObject(e);e.userData.boundingBox=o}const t=e.userData.boundingBox,i=t.getSize(new p.Vector3).length(),s=t.getCenter(new p.Vector3);this.cameraManager.frameObject(s,i)}centerModel(e){if(!e.userData.boundingBox){const s=new p.Box3().setFromObject(e);e.userData.boundingBox=s}const i=e.userData.boundingBox.getCenter(new p.Vector3);return e.position.sub(i),e.userData.boundingBox=new p.Box3().setFromObject(e),i}startRenderLoop(){let e=0;const t=i=>{const s=Math.min((i-e)/1e3,.1);e=i,this.vrManager&&this.vrManager.update(s),this.cameraManager&&this.cameraManager.update(),this.emit("before-render",s),this.renderer&&this.sceneManager&&this.cameraManager&&this.renderer.render(this.sceneManager.scene,this.cameraManager.camera)};this.renderer.setAnimationLoop(t)}getScene(){var e;return(e=this.sceneManager)==null?void 0:e.scene}getCamera(){var e;return(e=this.cameraManager)==null?void 0:e.camera}getRenderer(){return this.renderer}getLoadedModels(){return this.loadedModels}getCurrentModel(){return this.loadedModels.length>0?this.loadedModels[this.loadedModels.length-1]:null}removeModel(e){const t=this.loadedModels.findIndex(i=>i.model===e);t>=0&&(this.sceneManager.remove(e),this.loadedModels.splice(t,1),this.emit("model-removed",{model:e}))}clearModels(){this.loadedModels.forEach(({model:e})=>{e.traverse(t=>{t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(i=>{i.map&&i.map.dispose(),i.normalMap&&i.normalMap.dispose(),i.roughnessMap&&i.roughnessMap.dispose(),i.metalnessMap&&i.metalnessMap.dispose(),i.dispose()}):(t.material.map&&t.material.map.dispose(),t.material.normalMap&&t.material.normalMap.dispose(),t.material.roughnessMap&&t.material.roughnessMap.dispose(),t.material.metalnessMap&&t.material.metalnessMap.dispose(),t.material.dispose())))}),this.sceneManager.remove(e)}),this.loadedModels.length=0,this.emit("models-cleared")}dispose(){this.currentAbortController&&this.currentAbortController.abort(),typeof window<"u"&&Mt.cleanup(),this.vrManager&&(this.vrManager.dispose(),this.vrManager=null),this.renderer&&this.renderer.setAnimationLoop(null),this.loadedModels.forEach(({model:e})=>{e.parent&&e.parent.remove(e),e.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose())})}),this.loadedModels=[],this.cameraManager&&(this.cameraManager.dispose(),this.cameraManager=null),this.renderer&&(this.renderer.dispose(),this.renderer.domElement&&this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),window.removeEventListener("resize",this.onWindowResize.bind(this)),this.removeAllListeners(),this.isInitialized=!1}applyDesktopPositions(e){if(!e||!this.cameraManager)return;const t=()=>{e.camera&&this.cameraManager.camera.position.set(e.camera.x,e.camera.y,e.camera.z),e.target&&this.cameraManager.controls&&(this.cameraManager.controls.target.set(e.target.x,e.target.y,e.target.z),this.cameraManager.controls.update(),requestAnimationFrame(()=>{this.cameraManager.controls.update()}))};t(),setTimeout(t,50)}isVRPresenting(){return this.vrManager?this.vrManager.isVRPresenting:!1}getVRManager(){return this.vrManager}setVRComfortSettings(e){this.vrManager&&this.vrManager.setComfortSettings(e)}getVRComfortSettings(){return this.vrManager?this.vrManager.getComfortSettings():null}setVRComfortPreset(e){this.vrManager&&this.vrManager.setComfortPreset(e)}applyInitialPositions(e){if(!e)return;const t=this.isVRPresenting();t&&e.vr&&this.vrManager?this.vrManager.applyVRPositions(e):!t&&e.desktop&&this.applyDesktopPositions(e.desktop)}}const xt=new l.Box3,pe=new l.Vector3;class Dt extends l.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],i=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(i),this.setAttribute("position",new l.Float32BufferAttribute(e,3)),this.setAttribute("uv",new l.Float32BufferAttribute(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new l.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceStart",new l.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceEnd",new l.InterleavedBufferAttribute(i,3,3)),this.instanceCount=this.attributes.instanceStart.count,this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new l.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceColorStart",new l.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceColorEnd",new l.InterleavedBufferAttribute(i,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new l.WireframeGeometry(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new l.Box3);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),xt.setFromBufferAttribute(t),this.boundingBox.union(xt))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new l.Sphere),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const i=this.boundingSphere.center;this.boundingBox.getCenter(i);let s=0;for(let o=0,n=e.count;o<n;o++)pe.fromBufferAttribute(e,o),s=Math.max(s,i.distanceToSquared(pe)),pe.fromBufferAttribute(t,o),s=Math.max(s,i.distanceToSquared(pe));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}}l.UniformsLib.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new l.Vector2(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},l.ShaderLib.line={uniforms:l.UniformsUtils.merge([l.UniformsLib.common,l.UniformsLib.fog,l.UniformsLib.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );
				vec3 worldUp = normalize( cross( worldDir, tmpFwd ) );
				vec3 worldFwd = cross( worldDir, worldUp );
				worldPos = position.y < 0.5 ? start: end;

				// height offset
				float hw = linewidth * 0.5;
				worldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// cap extension
					worldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;

					// add width to the box
					worldPos.xyz += worldFwd * hw;

					// endcaps
					if ( position.y > 1.0 || position.y < 0.0 ) {

						worldPos.xyz -= worldFwd * 2.0 * hw;

					}

				#endif

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			float alpha = opacity;
			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class me extends l.ShaderMaterial{constructor(e){super({type:"LineMaterial",uniforms:l.UniformsUtils.clone(l.ShaderLib.line.uniforms),vertexShader:l.ShaderLib.line.vertexShader,fragmentShader:l.ShaderLib.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(e){e===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(e){this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}get dashed(){return"USE_DASH"in this.defines}set dashed(e){e===!0!==this.dashed&&(this.needsUpdate=!0),e===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(e){this.uniforms.dashScale.value=e}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(e){this.uniforms.dashOffset.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e}get opacity(){return this.uniforms.opacity.value}set opacity(e){this.uniforms&&(this.uniforms.opacity.value=e)}get resolution(){return this.uniforms.resolution.value}set resolution(e){this.uniforms.resolution.value.copy(e)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(e){this.defines&&(e===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),e===!0?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const Pe=new l.Vector4,Lt=new l.Vector3,Ft=new l.Vector3,_=new l.Vector4,G=new l.Vector4,K=new l.Vector4,Ue=new l.Vector3,Ne=new l.Matrix4,P=new l.Line3,kt=new l.Vector3,fe=new l.Box3,be=new l.Sphere,Y=new l.Vector4;let J,se;function Rt(c,e,t){return Y.set(0,0,-e,1).applyMatrix4(c.projectionMatrix),Y.multiplyScalar(1/Y.w),Y.x=se/t.width,Y.y=se/t.height,Y.applyMatrix4(c.projectionMatrixInverse),Y.multiplyScalar(1/Y.w),Math.abs(Math.max(Y.x,Y.y))}function Ms(c,e){const t=c.matrixWorld,i=c.geometry,s=i.attributes.instanceStart,o=i.attributes.instanceEnd,n=Math.min(i.instanceCount,s.count);for(let a=0,r=n;a<r;a++){P.start.fromBufferAttribute(s,a),P.end.fromBufferAttribute(o,a),P.applyMatrix4(t);const A=new l.Vector3,h=new l.Vector3;J.distanceSqToSegment(P.start,P.end,h,A),h.distanceTo(A)<se*.5&&e.push({point:h,pointOnLine:A,distance:J.origin.distanceTo(h),object:c,face:null,faceIndex:a,uv:null,uv1:null})}}function vs(c,e,t){const i=e.projectionMatrix,o=c.material.resolution,n=c.matrixWorld,a=c.geometry,r=a.attributes.instanceStart,A=a.attributes.instanceEnd,h=Math.min(a.instanceCount,r.count),d=-e.near;J.at(1,K),K.w=1,K.applyMatrix4(e.matrixWorldInverse),K.applyMatrix4(i),K.multiplyScalar(1/K.w),K.x*=o.x/2,K.y*=o.y/2,K.z=0,Ue.copy(K),Ne.multiplyMatrices(e.matrixWorldInverse,n);for(let g=0,u=h;g<u;g++){if(_.fromBufferAttribute(r,g),G.fromBufferAttribute(A,g),_.w=1,G.w=1,_.applyMatrix4(Ne),G.applyMatrix4(Ne),_.z>d&&G.z>d)continue;if(_.z>d){const E=_.z-G.z,C=(_.z-d)/E;_.lerp(G,C)}else if(G.z>d){const E=G.z-_.z,C=(G.z-d)/E;G.lerp(_,C)}_.applyMatrix4(i),G.applyMatrix4(i),_.multiplyScalar(1/_.w),G.multiplyScalar(1/G.w),_.x*=o.x/2,_.y*=o.y/2,G.x*=o.x/2,G.y*=o.y/2,P.start.copy(_),P.start.z=0,P.end.copy(G),P.end.z=0;const I=P.closestPointToPointParameter(Ue,!0);P.at(I,kt);const B=l.MathUtils.lerp(_.z,G.z,I),f=B>=-1&&B<=1,b=Ue.distanceTo(kt)<se*.5;if(f&&b){P.start.fromBufferAttribute(r,g),P.end.fromBufferAttribute(A,g),P.start.applyMatrix4(n),P.end.applyMatrix4(n);const E=new l.Vector3,C=new l.Vector3;J.distanceSqToSegment(P.start,P.end,C,E),t.push({point:C,pointOnLine:E,distance:J.origin.distanceTo(C),object:c,face:null,faceIndex:g,uv:null,uv1:null})}}}class xs extends l.Mesh{constructor(e=new Dt,t=new me({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,i=e.attributes.instanceEnd,s=new Float32Array(2*t.count);for(let n=0,a=0,r=t.count;n<r;n++,a+=2)Lt.fromBufferAttribute(t,n),Ft.fromBufferAttribute(i,n),s[a]=a===0?0:s[a-1],s[a+1]=s[a]+Lt.distanceTo(Ft);const o=new l.InstancedInterleavedBuffer(s,2,1);return e.setAttribute("instanceDistanceStart",new l.InterleavedBufferAttribute(o,1,0)),e.setAttribute("instanceDistanceEnd",new l.InterleavedBufferAttribute(o,1,1)),this}raycast(e,t){const i=this.material.worldUnits,s=e.camera;s===null&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const o=e.params.Line2!==void 0&&e.params.Line2.threshold||0;J=e.ray;const n=this.matrixWorld,a=this.geometry,r=this.material;se=r.linewidth+o,a.boundingSphere===null&&a.computeBoundingSphere(),be.copy(a.boundingSphere).applyMatrix4(n);let A;if(i)A=se*.5;else{const d=Math.max(s.near,be.distanceToPoint(J.origin));A=Rt(s,d,r.resolution)}if(be.radius+=A,J.intersectsSphere(be)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),fe.copy(a.boundingBox).applyMatrix4(n);let h;if(i)h=se*.5;else{const d=Math.max(s.near,fe.distanceToPoint(J.origin));h=Rt(s,d,r.resolution)}fe.expandByScalar(h),J.intersectsBox(fe)!==!1&&(i?Ms(this,t):vs(this,s,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(Pe),this.material.uniforms.resolution.value.set(Pe.z,Pe.w))}}class Ve extends Dt{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,i=new Float32Array(2*t);for(let s=0;s<t;s+=3)i[2*s]=e[s],i[2*s+1]=e[s+1],i[2*s+2]=e[s+2],i[2*s+3]=e[s+3],i[2*s+4]=e[s+4],i[2*s+5]=e[s+5];return super.setPositions(i),this}setColors(e){const t=e.length-3,i=new Float32Array(2*t);for(let s=0;s<t;s+=3)i[2*s]=e[s],i[2*s+1]=e[s+1],i[2*s+2]=e[s+2],i[2*s+3]=e[s+3],i[2*s+4]=e[s+4],i[2*s+5]=e[s+5];return super.setColors(i),this}setFromPoints(e){const t=e.length-1,i=new Float32Array(6*t);for(let s=0;s<t;s++)i[6*s]=e[s].x,i[6*s+1]=e[s].y,i[6*s+2]=e[s].z||0,i[6*s+3]=e[s+1].x,i[6*s+4]=e[s+1].y,i[6*s+5]=e[s+1].z||0;return super.setPositions(i),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class Tt extends xs{constructor(e=new Ve,t=new me({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}class Ds{setRaycastTargets(e){const t=[],i=s=>{Array.isArray(s)?s.forEach(i):s&&typeof s=="object"&&(s.isMesh&&s.geometry&&!this.isMeasurementHelper(s)?(s.updateMatrixWorld(!0),t.push(s)):s.traverse&&s.traverse(o=>{o.isMesh&&o.geometry&&!this.isMeasurementHelper(o)&&(o.updateMatrixWorld(!0),t.push(o))}))};i(e),this._raycastTargets=t}isMeasurementHelper(e){if(!e)return!1;if(e.geometry===this.sphereGeometry||e.userData.isMeasurementSphere||e.type==="Line2"||e.type==="Line"||e.geometry&&e.geometry.type==="LineGeometry")return!0;const t=["RingGeometry","TubeGeometry","PlaneGeometry","CircleGeometry"];return!!(e.geometry&&t.includes(e.geometry.type)||typeof e.name=="string"&&e.name.startsWith("MeasurementHelper"))}setTarget(e){e?this.setRaycastTargets(e):this.setRaycastTargets([])}constructor({scene:e,camera:t,renderer:i,controls:s,dolly:o,config:n={},theme:a="dark"}){this.ghostSpheres={left:null,right:null},this.MAX_SPHERES=2,this.measurementSpheres=[],this.measurementLine=null,this.measurementLabel=null,this.previousTriggerState={},this.unifiedMeasurementPoints=[],this.unifiedMeasurementLine=null,this.desktopMeasurementPoints=[],this.desktopMeasurementLine=null,typeof window<"u"&&(window.measurementSystem=this),this.scene=e,this.camera=t,this.renderer=i,this.controls=s,this.dolly=o,this.config=n,this.theme=a,this._raycastTargets=e&&e.children?e.children:[],this.enabled=!0,this.isVR=!1,this.measurementPanel=null,this.desktopMeasurementMode=!1,this.measurementSystemEnabled=!0,this.desktopMeasurementPoints=[],this.connectionLine=null,this.desktopMeasurementLine=null,this.measurementSprite=null,this.measurementCanvas=null,this.measurementTexture=null,this.lastClickTime=0,this.lastTriggerTime=0,this._wasInVR=!1,this.focusAnimation=null,this.mouse=new p.Vector2,this.raycaster=new p.Raycaster;const r=()=>{let A=null,h=null,d=null,g=null;if(e&&e.children&&e.children.forEach(u=>{u&&u.inputSource&&u.inputSource.handedness&&(u.inputSource.handedness==="left"&&(A=u),u.inputSource.handedness==="right"&&(h=u))}),(!A||!h)&&i&&i.xr&&i.xr.getController)try{A=A||i.xr.getController(0),h=h||i.xr.getController(1)}catch{}A&&h?(this.attachVR({controller1:A,controller2:h,controllerGrip1:d,controllerGrip2:g}),this.ghostSpheres&&this.ghostSpheres.left&&this.ghostSpheres.right&&(this.ghostSpheres.left.visible=!0,this.ghostSpheres.right.visible=!0)):(this._ghostSphereAttachRetries||(this._ghostSphereAttachRetries=0),this._ghostSphereAttachRetries<40?(this._ghostSphereAttachRetries++,setTimeout(r,250)):typeof window<"u"&&window.console&&console.warn("[MeasurementSystem] Could not find VR controllers to attach ghost spheres after multiple attempts."))};if(r(),i&&i.xr&&i.xr.addEventListener&&i.xr.addEventListener("sessionstart",r),this.sphereGeometry=new p.SphereGeometry(.02,8,6),this.placedMaterial=new p.MeshBasicMaterial({color:16777215}),this.vrLineMaterial=new me({color:16777215,linewidth:3,transparent:!0,opacity:.8,depthTest:!1,vertexColors:!1,dashed:!1}),this.desktopLineMaterial=new me({color:16777215,linewidth:3,transparent:!0,opacity:1,depthTest:!1,vertexColors:!1,dashed:!1}),this.MAX_DESKTOP_POINTS=2,this.DRAG_THRESHOLD=5,this.isDragging=!1,this.dragStartPosition={x:0,y:0},this.createMeasurementPanel(),this.updateMeasurementPanel(),this._boundOnMouseClick=this.onMouseClick.bind(this),this._boundOnMouseDown=this.onMouseDown.bind(this),this._boundOnMouseMove=this.onMouseMove.bind(this),this._boundOnMouseUp=this.onMouseUp.bind(this),this.renderer.domElement.addEventListener("click",this._boundOnMouseClick,!1),this.renderer.domElement.addEventListener("mousedown",this._boundOnMouseDown,!1),this.renderer.domElement.addEventListener("mousemove",this._boundOnMouseMove,!1),this.renderer.domElement.addEventListener("mouseup",this._boundOnMouseUp,!1),i&&i.xr&&typeof i.xr.getController=="function"){const A=()=>{if(i.xr.isPresenting){const h=i.xr.getController(0),d=i.xr.getController(1),g=i.xr.getControllerGrip?i.xr.getControllerGrip(0):void 0,u=i.xr.getControllerGrip?i.xr.getControllerGrip(1):void 0;this.attachVR({controller1:h,controller2:d,controllerGrip1:g,controllerGrip2:u})}};if(i.xr.addEventListener&&i.xr.addEventListener("sessionstart",A),i.xr.isPresenting&&A(),i.xr&&typeof i.xr.requestSession=="function"&&!i.xr._measurementSystemPatched){const h=i.xr.requestSession.bind(i.xr);i.xr.requestSession=async(...d)=>{const g=await h(...d);return setTimeout(()=>{A()},100),g},i.xr._measurementSystemPatched=!0}}setTimeout(()=>{i&&i.xr&&typeof i.xr.isPresenting=="boolean"&&i.xr.isPresenting&&!this.isVR&&console.warn("[MeasurementSystem] WARNING: attachVR() was never called. VR ghost spheres and VR measurement will not work.")},5e3)}enable(){this.desktopMeasurementMode=!0,this.updateMeasurementPanel()}disable(){this.desktopMeasurementMode=!1,this.updateMeasurementPanel(),this.clearDesktopMeasurement()}toggle(){this.desktopMeasurementMode=!this.desktopMeasurementMode,this.updateMeasurementPanel(),this.desktopMeasurementMode||this.clearDesktopMeasurement()}clear(){this.clearUnifiedMeasurement(),this.clearLegacyDesktopMeasurement(),this.clearLegacyVRMeasurement()}clearUnifiedMeasurement(){this.unifiedMeasurementPoints&&this.unifiedMeasurementPoints.length>0&&(this.unifiedMeasurementPoints.forEach(e=>{e.sphere&&this.scene.children.includes(e.sphere)&&this.scene.remove(e.sphere)}),this.unifiedMeasurementPoints.length=0),this.unifiedMeasurementLine&&(this.scene.remove(this.unifiedMeasurementLine),this.unifiedMeasurementLine=null),this.measurementSprite&&(this.measurementSprite.visible=!1,this.scene.remove(this.measurementSprite),this.measurementSprite=null),this.updateMeasurementPanel()}clearVRMeasurement(){this.measurementSpheres&&(this.measurementSpheres.forEach(e=>this.scene.remove(e)),this.measurementSpheres.length=0),this.measurementLine&&(this.scene.remove(this.measurementLine),this.measurementLine=null),this.measurementLabel&&(this.scene.remove(this.measurementLabel),this.measurementLabel=null),this.placedSpheres&&(this.placedSpheres.forEach(e=>this.scene.remove(e)),this.placedSpheres.length=0),this.connectionLine&&(this.scene.remove(this.connectionLine),this.connectionLine=null),this.measurementSprite&&(this.measurementSprite.visible=!1),this.measurementSystemEnabled=!0,this.updateMeasurementPanel()}clearLegacyVRMeasurement(){this.measurementSpheres&&this.measurementSpheres.length>0&&(this.measurementSpheres.forEach(e=>{e&&this.scene.children.includes(e)&&this.scene.remove(e)}),this.measurementSpheres.length=0),this.measurementLine&&(this.scene.remove(this.measurementLine),this.measurementLine=null),this.connectionLine&&(this.scene.remove(this.connectionLine),this.connectionLine=null),this.measurementLabel&&(this.scene.remove(this.measurementLabel),this.measurementLabel=null)}syncToVR(){if(this.desktopMeasurementPoints.length===2){if(this.clearVRMeasurement(),this.desktopMeasurementPoints.forEach(e=>{const t=new p.Mesh(this.sphereGeometry,this.placedMaterial);t.position.copy(e.position),this.scene.add(t),this.measurementSpheres.push(t)}),this.measurementSpheres.length===2){const e=new p.BufferGeometry().setFromPoints([this.measurementSpheres[0].position,this.measurementSpheres[1].position]),t=this.vrLineMaterial||new p.LineBasicMaterial({color:16777215,transparent:!0,opacity:.8,depthTest:!1});this.connectionLine=new p.Line(e,t),this.scene.add(this.connectionLine),this.createMeasurementDisplay(this.measurementSpheres[0].position.distanceTo(this.measurementSpheres[1].position)),this.measurementSprite&&!this.scene.children.includes(this.measurementSprite)&&this.scene.add(this.measurementSprite)}this.measurementSystemEnabled=!0,this.updateMeasurementPanel()}}syncToDesktop(){if(this.measurementSpheres&&this.measurementSpheres.length===2){this.clearDesktopMeasurement();for(let e=0;e<2;e++){const t=this.measurementSpheres[e].position.clone();let i=t;if(this._raycastTargets&&this._raycastTargets.length>0&&this.camera){const o=t.clone().sub(this.camera.position).normalize(),a=new p.Raycaster(this.camera.position,o).intersectObjects(this._raycastTargets,!0);a.length>0&&(i=a[0].point)}const s=new p.Mesh(this.sphereGeometry,this.placedMaterial);s.position.copy(i),this.scene.add(s),this.desktopMeasurementPoints.push(s)}if(this.desktopMeasurementPoints.length===2){const e=new Ve;e.setPositions([this.desktopMeasurementPoints[0].position.x,this.desktopMeasurementPoints[0].position.y,this.desktopMeasurementPoints[0].position.z,this.desktopMeasurementPoints[1].position.x,this.desktopMeasurementPoints[1].position.y,this.desktopMeasurementPoints[1].position.z]),this.desktopMeasurementLine=new Tt(e,this.desktopLineMaterial),this.desktopMeasurementLine.computeLineDistances(),this.scene.add(this.desktopMeasurementLine);const t=this.desktopMeasurementPoints[0].position.distanceTo(this.desktopMeasurementPoints[1].position);if(this.createMeasurementDisplay(t),this.measurementSprite){const i=new p.Vector3;i.addVectors(this.desktopMeasurementPoints[0].position,this.desktopMeasurementPoints[1].position),i.multiplyScalar(.5);const s=Math.max(.05,Math.min(.2,t*.03));i.y+=s,this.measurementSprite.position.copy(i),this.measurementSprite.visible=!1,this.scene.children.includes(this.measurementSprite)||this.scene.add(this.measurementSprite)}}this.updateMeasurementPanel()}}createMeasurementDisplay(e){const t=window.devicePixelRatio||1,i=256,s=64,o=i*t,n=s*t;this.measurementCanvas||(this.measurementCanvas=document.createElement("canvas")),(this.measurementCanvas.width!==o||this.measurementCanvas.height!==n)&&(this.measurementCanvas.width=o,this.measurementCanvas.height=n);const a=this.measurementCanvas.getContext("2d");a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,o,n),a.save(),a.scale(t,t);const r=24;let A;e<=2?A=.4+e/2*.3:e<=4?A=.7+(e-2)/2*.2:A=.9+Math.min((e-4)/16,1)*.5;const h=Math.round(r*A);a.font=`600 ${h}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif`;const d=`${e.toFixed(2)}m`,u=a.measureText(d).width,m=h,I=Math.max(6,h*.3),B=u+I*2,f=m+I*2,b=(i-B)/2,E=(s-f)/2;if(a.fillStyle="rgba(0, 0, 0, 0.8)",a.beginPath(),a.roundRect(b,E,B,f,Math.max(4,h*.2)),a.fill(),a.fillStyle="white",a.textAlign="center",a.textBaseline="middle",a.fillText(d,i/2,s/2),a.restore(),this.measurementTexture?this.measurementTexture.needsUpdate=!0:(this.measurementTexture=new p.CanvasTexture(this.measurementCanvas),this.measurementTexture.minFilter=p.LinearFilter,this.measurementTexture.magFilter=p.LinearFilter),!this.measurementSprite){const S=new p.SpriteMaterial({map:this.measurementTexture,depthTest:!1,depthWrite:!1});this.measurementSprite=new p.Sprite(S)}const y=.3*A,w=i/s;return this.measurementSprite.scale.set(y*w,y,1),this.measurementSprite}attachVR({controller1:e,controller2:t,controllerGrip1:i,controllerGrip2:s}){this.controller1=e,this.controller2=t,this.controllerGrip1=i,this.controllerGrip2=s;const o=new p.MeshBasicMaterial({color:8947848,transparent:!0,opacity:.25,depthTest:!1,depthWrite:!1});this.ghostSpheres.left&&this.ghostSpheres.left.parent&&this.ghostSpheres.left.parent.remove(this.ghostSpheres.left),this.ghostSpheres.right&&this.ghostSpheres.right.parent&&this.ghostSpheres.right.parent.remove(this.ghostSpheres.right),this.ghostSpheres.left=new p.Mesh(this.sphereGeometry,o.clone()),this.ghostSpheres.right=new p.Mesh(this.sphereGeometry,o.clone()),this.ghostSpheres.left.scale.set(1,1,1),this.ghostSpheres.right.scale.set(1,1,1),this.ghostSpheres.left.position.set(0,0,-.05),this.ghostSpheres.right.position.set(0,0,-.05),this.ghostSpheres.left.visible=!0,this.ghostSpheres.right.visible=!0,this.controller1&&this.controller1.add(this.ghostSpheres.left),this.controller2&&this.controller2.add(this.ghostSpheres.right),this.yButtonPressed=!1,this.MAX_SPHERES=2,this.triggerState={left:!1,right:!1},this._onVRTriggerDown=this._onVRTriggerDown.bind(this),this._onVRTriggerUp=this._onVRTriggerUp.bind(this),this._onVRYButtonDown=this._onVRYButtonDown.bind(this),this._onVRYButtonUp=this._onVRYButtonUp.bind(this),this.controller1&&this.controller2&&(this.controller1.addEventListener("selectstart",this._onVRTriggerDown),this.controller1.addEventListener("selectend",this._onVRTriggerUp),this.controller2.addEventListener("selectstart",this._onVRTriggerDown),this.controller2.addEventListener("selectend",this._onVRTriggerUp),this.controller1.addEventListener("ybuttondown",this._onVRYButtonDown),this.controller1.addEventListener("ybuttonup",this._onVRYButtonUp),this.controller2.addEventListener("ybuttondown",this._onVRYButtonDown),this.controller2.addEventListener("ybuttonup",this._onVRYButtonUp)),this.isVR=!0,this.refreshMeasurementDisplayForVR()}_onVRTriggerDown(e){var i,s;(s=(i=e.target.userData)==null?void 0:i.inputSource)!=null&&s.handedness}_onVRTriggerUp(e){var s,o;const t=e.target;(o=(s=t.userData)==null?void 0:s.inputSource)!=null&&o.handedness;const i=performance.now();if(!(this.lastTriggerTime&&i-this.lastTriggerTime<200)&&(this.lastTriggerTime=i,this.measurementSystemEnabled)){const n=new p.Vector3;let a=null;if(t===this.controller1&&this.ghostSpheres.left?a=this.ghostSpheres.left:t===this.controller2&&this.ghostSpheres.right&&(a=this.ghostSpheres.right),a)a.getWorldPosition(n);else{t.getWorldPosition(n);const r=new p.Vector3(0,0,-.05);r.applyQuaternion(t.quaternion),n.add(r)}this._placeVRMeasurementPoint(n)}}_onVRYButtonDown(e){this.clearUnifiedMeasurement()}_onVRYButtonUp(e){}_getVRControllerIntersection(e){const t=new p.Matrix4;t.identity().extractRotation(e.matrixWorld);const i=new p.Vector3,s=new p.Vector3(0,0,-1).applyMatrix4(t);e.getWorldPosition(i);const a=new p.Raycaster(i,s.normalize()).intersectObjects(this.scene.children,!0).filter(r=>{const A=this.unifiedMeasurementPoints.some(g=>g.sphere===r.object),h=r.object===this.unifiedMeasurementLine,d=this.isMeasurementHelper(r.object);return!A&&!h&&!d});return a.length>0?a[0]:null}_placeVRMeasurementPoint(e){this.measurementSystemEnabled&&this.placeUnifiedMeasurementPoint(e,"vr")}clearLegacyDesktopMeasurement(){this.desktopMeasurementPoints&&this.desktopMeasurementPoints.length>0&&(this.desktopMeasurementPoints.forEach(e=>{e&&this.scene.children.includes(e)&&this.scene.remove(e)}),this.desktopMeasurementPoints.length=0),this.desktopMeasurementLine&&(this.scene.remove(this.desktopMeasurementLine),this.desktopMeasurementLine=null)}placeUnifiedMeasurementPoint(e,t="unknown"){if(this.unifiedMeasurementPoints.length===0&&(this.clearLegacyVRMeasurement(),this.clearLegacyDesktopMeasurement()),this.unifiedMeasurementPoints.length>=2){const s=this.unifiedMeasurementPoints.shift();s.sphere&&this.scene.remove(s.sphere)}const i=new p.Mesh(this.sphereGeometry,this.placedMaterial);i.position.copy(e),i.userData.isMeasurementSphere=!0,this.scene.add(i),this.unifiedMeasurementPoints.push({position:e.clone(),sphere:i,source:t}),this.updateUnifiedMeasurementLine(),this.updateMeasurementPanel()}updateUnifiedMeasurementLine(){if(this.unifiedMeasurementLine&&(this.scene.remove(this.unifiedMeasurementLine),this.unifiedMeasurementLine=null),this.unifiedMeasurementPoints.length===2){const e=this.unifiedMeasurementPoints[0].position,t=this.unifiedMeasurementPoints[1].position,i=new Ve;i.setPositions([e.x,e.y,e.z,t.x,t.y,t.z]),this.unifiedMeasurementLine=new Tt(i,this.desktopLineMaterial),this.unifiedMeasurementLine.computeLineDistances(),this.unifiedMeasurementLine.userData.isMeasurementLine=!0,this.scene.add(this.unifiedMeasurementLine);const s=e.distanceTo(t);if(this.createMeasurementDisplay(s),this.measurementSprite){const o=new p.Vector3;o.addVectors(e,t),o.multiplyScalar(.5);const n=Math.max(.05,Math.min(.2,s*.03));o.y+=n,this.measurementSprite.position.copy(o),this.scene.children.includes(this.measurementSprite)||this.scene.add(this.measurementSprite);const a=this.renderer&&this.renderer.xr&&this.renderer.xr.isPresenting;this.measurementSprite.visible=a}this.desktopMeasurementMode||(this.desktopMeasurementMode=!0)}}resetGhostSpherePositions(){this.isVR&&this.ghostSpheres&&(this.ghostSpheres.left&&this.controller1&&this.ghostSpheres.left.parent===this.controller1&&(this.ghostSpheres.left.position.set(0,0,-.05),this.ghostSpheres.left.rotation.set(0,0,0),this.ghostSpheres.left.scale.set(1,1,1)),this.ghostSpheres.right&&this.controller2&&this.ghostSpheres.right.parent===this.controller2&&(this.ghostSpheres.right.position.set(0,0,-.05),this.ghostSpheres.right.rotation.set(0,0,0),this.ghostSpheres.right.scale.set(1,1,1)))}update(){if(this.isVR&&this.ghostSpheres&&(this.ghostSpheres.left&&this.controller1&&this.ghostSpheres.left.visible&&this.ghostSpheres.left.position.length()>1&&this.resetGhostSpherePositions(),this.ghostSpheres.right&&this.controller2&&this.ghostSpheres.right.visible&&this.ghostSpheres.right.position.length()>1&&this.resetGhostSpherePositions()),this.measurementSprite){const e=this.renderer&&this.renderer.xr&&this.renderer.xr.isPresenting,t=this.unifiedMeasurementPoints&&this.unifiedMeasurementPoints.length===2;this.measurementSprite.visible=e&&t}}dispose(){this.measurementPanel&&this.measurementPanel.parentNode&&(this.measurementPanel.parentNode.removeChild(this.measurementPanel),this.measurementPanel=null),this.renderer.domElement.removeEventListener("click",this._boundOnMouseClick,!1),this.renderer.domElement.removeEventListener("mousedown",this._boundOnMouseDown,!1),this.renderer.domElement.removeEventListener("mousemove",this._boundOnMouseMove,!1),this.renderer.domElement.removeEventListener("mouseup",this._boundOnMouseUp,!1),this.controller1&&this.controller2&&(this.controller1.removeEventListener("selectstart",this._onVRTriggerDown),this.controller1.removeEventListener("selectend",this._onVRTriggerUp),this.controller2.removeEventListener("selectstart",this._onVRTriggerDown),this.controller2.removeEventListener("selectend",this._onVRTriggerUp),this.controller1.removeEventListener("ybuttondown",this._onVRYButtonDown),this.controller1.removeEventListener("ybuttonup",this._onVRYButtonUp),this.controller2.removeEventListener("ybuttondown",this._onVRYButtonDown),this.controller2.removeEventListener("ybuttonup",this._onVRYButtonUp)),this.clearDesktopMeasurement(),this.clearVRMeasurement(),this.ghostSpheres&&(this.ghostSpheres.left&&this.scene.remove(this.ghostSpheres.left),this.ghostSpheres.right&&this.scene.remove(this.ghostSpheres.right),this.ghostSpheres=null),this.measurementSprite&&this.scene.children.includes(this.measurementSprite)&&(this.scene.remove(this.measurementSprite),this.measurementSprite=null),this.connectionLine&&this.scene.children.includes(this.connectionLine)&&(this.scene.remove(this.connectionLine),this.connectionLine=null),this.measurementSpheres=[],this.isVR=!1,typeof window<"u"&&window.measurementSystem===this&&(window.measurementSystem=void 0)}createMeasurementPanel(){const e=document.createElement("div");e.id="measurementPanel",e.className=`measurement-panel${this.theme==="light"?" light-theme":""}`,e.addEventListener("click",()=>{this.renderer&&this.renderer.xr&&this.renderer.xr.isPresenting?(this.measurementSystemEnabled=!this.measurementSystemEnabled,this.measurementSystemEnabled?(this.ghostSpheres.left&&(this.ghostSpheres.left.visible=!0),this.ghostSpheres.right&&(this.ghostSpheres.right.visible=!0),this.resetGhostSpherePositions()):(this.clearUnifiedMeasurement(),this.ghostSpheres.left&&(this.ghostSpheres.left.visible=!1),this.ghostSpheres.right&&(this.ghostSpheres.right.visible=!1)),this.updateMeasurementPanel()):(this.desktopMeasurementMode=!this.desktopMeasurementMode,this.desktopMeasurementMode||this.clearUnifiedMeasurement(),this.updateMeasurementPanel())}),(this.renderer&&this.renderer.domElement&&this.renderer.domElement.parentElement||document.body).appendChild(e),this.measurementPanel=e}updateMeasurementPanel(){const e=this.measurementPanel;if(!e)return;const t=this.renderer&&this.renderer.xr&&this.renderer.xr.isPresenting,i=this.unifiedMeasurementPoints?this.unifiedMeasurementPoints.length:0,s=i===2,o=t?this.measurementSystemEnabled:this.desktopMeasurementMode;let n;if(s&&(n=this.unifiedMeasurementPoints[0].position.distanceTo(this.unifiedMeasurementPoints[1].position)),e.classList.remove("disabled","active","measured"),!o)e.classList.add("disabled"),e.innerHTML=`
        <div>MEASURE</div>
        <div style="font-size: 12px; margin-top: 4px;">Click to enable</div>
      `;else if(s)e.classList.add("measured"),e.innerHTML=`
        <div>${n.toFixed(2)}m</div>
        <div style="font-size: 12px; margin-top: 4px;">Click to disable</div>
      `;else{e.classList.add("active");const a=t?"Use triggers":"Click points";e.innerHTML=`
        <div>MEASURE: ON</div>
        <div style="font-size: 12px; margin-top: 4px;">${a} (${i}/2)</div>
      `}}onMouseDown(e){this.isDragging=!1,this.dragStartPosition.x=e.clientX,this.dragStartPosition.y=e.clientY}onMouseMove(e){if(!this.isDragging){const t=Math.abs(e.clientX-this.dragStartPosition.x),i=Math.abs(e.clientY-this.dragStartPosition.y);(t>this.DRAG_THRESHOLD||i>this.DRAG_THRESHOLD)&&(this.isDragging=!0)}}onMouseUp(e){setTimeout(()=>{this.isDragging=!1},10)}onMouseClick(e){const t=Date.now(),i=t-this.lastClickTime<300;if(this.lastClickTime=t,this.isDragging||!this.desktopMeasurementMode)return;this.desktopMeasurementMode&&(e.stopPropagation(),e.preventDefault());const s=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-s.left)/s.width*2-1,this.mouse.y=-((e.clientY-s.top)/s.height)*2+1;let o=this.camera;if(this.renderer&&this.renderer.xr&&this.renderer.xr.isPresenting){const A=this.renderer.xr.getCamera();A&&(o=A)}if((!o||!o.isPerspectiveCamera&&!o.isOrthographicCamera)&&this.scene&&this.scene.children){for(const A of this.scene.children)if(A.isCamera){o=A;break}}if((!o||!o.isPerspectiveCamera&&!o.isOrthographicCamera)&&typeof window<"u"&&window.camera&&(window.camera.isPerspectiveCamera||window.camera.isOrthographicCamera)&&(o=window.camera),!o||!o.isPerspectiveCamera&&!o.isOrthographicCamera&&o.type!=="ArrayCamera")return;this.raycaster.setFromCamera(this.mouse,o);const n=this._raycastTargets&&this._raycastTargets.length>0?this._raycastTargets:[];if(n.length===0)return;const a=this.raycaster.intersectObjects(n,!0);if(a.length===0)return;const r=a.filter(A=>{const h=this.unifiedMeasurementPoints.some(u=>u.sphere===A.object),d=A.object===this.unifiedMeasurementLine,g=this.isMeasurementHelper(A.object);return!h&&!d&&!g});if(r.length>0)if(i)this.focusOnPoint(r[0].point);else{const A=r[0].point;this.placeUnifiedMeasurementPoint(A,"desktop")}}focusOnPoint(e){this.focusAnimation&&(cancelAnimationFrame(this.focusAnimation),this.focusAnimation=null);const t=this.controls.target.clone(),i=this.camera.position.clone(),s=i.clone().sub(t),o=e.clone().add(s),n=1e3,a=performance.now(),r=()=>{const A=performance.now()-a,h=Math.min(A/n,1),d=1-Math.pow(1-h,3);this.controls.target.lerpVectors(t,e,d),this.camera.position.lerpVectors(i,o,d),h<1?this.focusAnimation=requestAnimationFrame(r):this.focusAnimation=null};this.focusAnimation=requestAnimationFrame(r)}_focusOnPoint(e){if(this.focusAnimation&&(cancelAnimationFrame(this.focusAnimation),this.focusAnimation=null),!this.controls||!this.camera){console.warn("[MeasurementSystem] No controls or camera available for focusing");return}const t=this.controls.target.clone(),i=this.camera.position.clone(),s=i.clone().sub(t),o=e.clone().add(s),n=1e3,a=performance.now(),r=()=>{const A=performance.now()-a,h=Math.min(A/n,1),d=1-Math.pow(1-h,3);this.controls.target.lerpVectors(t,e,d),this.camera.position.lerpVectors(i,o,d),this.controls.update(),h<1?this.focusAnimation=requestAnimationFrame(r):this.focusAnimation=null};this.focusAnimation=requestAnimationFrame(r)}refreshMeasurementDisplayForVR(){if(this.unifiedMeasurementPoints&&this.unifiedMeasurementPoints.length===2){const e=this.unifiedMeasurementPoints[0].position,t=this.unifiedMeasurementPoints[1].position,i=e.distanceTo(t);if(this.createMeasurementDisplay(i),this.measurementSprite){const s=new p.Vector3;s.addVectors(e,t),s.multiplyScalar(.5);const o=Math.max(.05,Math.min(.2,i*.03));s.y+=o,this.measurementSprite.position.copy(s),this.scene.children.includes(this.measurementSprite)||this.scene.add(this.measurementSprite),this.measurementSprite.visible=!0}}}}class Oe{constructor(e,t={}){this.vrManager=e,this.isComfortMode=!1,this.options={containerId:t.containerId||"modelSelector",useInlineLayout:t.useInlineLayout!==!1,position:t.position||"bottom-right",offsetX:t.offsetX||20,offsetY:t.offsetY||120,...t},this.element=null,this.init()}init(){this.createElement(),this.attachStyles(),this.attachEvents(),this.updateVisualState()}createElement(){this.options.useInlineLayout?this.createInlineElement():this.createFloatingElement()}createInlineElement(){const e=document.getElementById("modeToggleContainer");if(!e){console.warn("VRComfortGlyph: modeToggleContainer not found, falling back to floating mode"),this.createFloatingElement();return}this.element=document.createElement("div"),this.element.id="vrComfortGlyph",this.element.className="vr-comfort-circle comfort-off",this.element.textContent="🛡️",this.element.tabIndex=0,this.element.role="button",this.element.title="Comfort Mode: OFF (Smooth Movement)",this.element.setAttribute("aria-label","Comfort Mode is OFF - Click to enable");const t=e.querySelector(".semantic-toggle");t?e.insertBefore(this.element,t.nextSibling):e.appendChild(this.element),this.updateInlineVisualState()}createFloatingElement(){this.element=document.createElement("div"),this.element.id="vrComfortGlyph",this.element.className="vr-comfort-glyph comfort-off",this.element.textContent="🛡️",this.element.title="Comfort Mode: OFF (Smooth Movement)",this.element.tabIndex=0,this.element.role="button",this.element.setAttribute("aria-label","Comfort Mode is OFF - Click to enable comfortable movement");const e=this.options.containerId?document.getElementById(this.options.containerId):document.body;e?e.appendChild(this.element):(console.warn("VRComfortGlyph: Container not found, appending to body"),document.body.appendChild(this.element))}attachStyles(){if(document.getElementById("vr-comfort-glyph-styles"))return;const e=document.createElement("style");e.id="vr-comfort-glyph-styles",e.textContent=`
      /* VR Comfort Glyph Styles */
      .vr-comfort-glyph {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid #666;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 20px;
        z-index: 10000;
        backdrop-filter: blur(10px);
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        touch-action: manipulation;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      /* Inline Comfort Circle Styles - matches Survey/Dive toggle design */
      .vr-comfort-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 20px;
        margin-left: 15px;
        position: relative;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        touch-action: manipulation;
        overflow: hidden;
        flex-shrink: 0;
      }
      
      .vr-comfort-circle:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.02);
      }
      
      .vr-comfort-circle:focus {
        outline: 2px solid #4ade80;
        outline-offset: 2px;
      }
      
      .vr-comfort-circle:active {
        transform: scale(0.98);
      }
      
      .vr-comfort-circle.comfort-off {
        color: rgba(255, 255, 255, 0.5) !important;
        background: rgba(255, 255, 255, 0.06) !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
        box-shadow: none !important;
      }
      
      .vr-comfort-circle.comfort-off:hover {
        color: rgba(255, 255, 255, 0.7) !important;
        background: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
        box-shadow: none !important;
      }
      
      .vr-comfort-circle.comfort-on {
        color: #4ade80 !important;
        background: rgba(74, 222, 128, 0.1) !important;
        border-color: rgba(74, 222, 128, 0.3) !important;
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.1) !important;
      }
      
      .vr-comfort-circle.comfort-on:hover {
        background: rgba(74, 222, 128, 0.15) !important;
        border-color: rgba(74, 222, 128, 0.4) !important;
        box-shadow: 0 0 30px rgba(74, 222, 128, 0.15) !important;
      }
      
      /* Update modeToggleContainer to flex layout */
      #modeToggleContainer {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0 !important;
      }
      
      /* Ensure semantic toggle doesn't take full width */
      .semantic-toggle {
        flex-shrink: 0 !important;
      }
      
      /* Original floating glyph styles */
      .vr-comfort-glyph:hover {
        transform: scale(1.1);
        background: rgba(0, 0, 0, 0.8);
      }
      
      .vr-comfort-glyph:focus {
        outline: 3px solid #4ade80;
        outline-offset: 2px;
      }
      
      .vr-comfort-glyph.comfort-off {
        color: #666;
        border-color: #666;
        background: rgba(0, 0, 0, 0.6);
        box-shadow: none;
        filter: none;
      }
      
      .vr-comfort-glyph.comfort-on {
        color: #4ade80;
        border-color: #4ade80;
        background: rgba(74, 222, 128, 0.1);
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
        filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.4));
      }
      
      /* Position variants for floating mode */
      .vr-comfort-glyph.position-bottom-right {
        bottom: var(--vr-comfort-offset-y, 120px);
        right: var(--vr-comfort-offset-x, 20px);
      }
      
      .vr-comfort-glyph.position-bottom-left {
        bottom: var(--vr-comfort-offset-y, 120px);
        left: var(--vr-comfort-offset-x, 20px);
      }
      
      .vr-comfort-glyph.position-top-right {
        top: var(--vr-comfort-offset-y, 20px);
        right: var(--vr-comfort-offset-x, 20px);
      }
      
      .vr-comfort-glyph.position-top-left {
        top: var(--vr-comfort-offset-y, 20px);
        left: var(--vr-comfort-offset-x, 20px);
      }
      
      /* Mobile responsive */
      @media (max-width: 768px) {
        .vr-comfort-circle {
          width: 50px;
          height: 50px;
          font-size: 18px;
          margin-left: 10px;
        }
        
        #modeToggleContainer {
          flex-wrap: nowrap !important;
          justify-content: center !important;
        }
        
        
        .vr-comfort-glyph {
          width: 48px !important;
          height: 48px !important;
          font-size: 24px !important;
        }
        
        .vr-comfort-glyph.position-bottom-right {
          bottom: var(--vr-comfort-offset-y-mobile, 130px);
          right: var(--vr-comfort-offset-x-mobile, 15px);
        }
        
        .vr-comfort-glyph.position-bottom-left {
          bottom: var(--vr-comfort-offset-y-mobile, 130px);
          left: var(--vr-comfort-offset-x-mobile, 15px);
        }
      }
    `,document.head.appendChild(e),document.documentElement.style.setProperty("--vr-comfort-offset-x",this.options.offsetX+"px"),document.documentElement.style.setProperty("--vr-comfort-offset-y",this.options.offsetY+"px"),document.documentElement.style.setProperty("--vr-comfort-offset-x-mobile",this.options.offsetX-5+"px"),document.documentElement.style.setProperty("--vr-comfort-offset-y-mobile",this.options.offsetY+10+"px")}attachEvents(){if(!this.element)return;const e=()=>{this.toggle()};this.element.addEventListener("click",e),this.element.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),e())})}updatePosition(){this.element&&(this.element.classList.remove("position-bottom-right","position-bottom-left","position-top-right","position-top-left"),this.element.classList.add(`position-${this.options.position}`))}updateVisualState(){this.element&&(this.options.useInlineLayout?this.updateInlineVisualState():this.updateFloatingVisualState())}updateInlineVisualState(){this.element&&(this.element.classList.remove("comfort-off","comfort-on"),this.element.style.removeProperty("background"),this.element.style.removeProperty("border-color"),this.element.style.removeProperty("color"),this.element.style.removeProperty("box-shadow"),this.element.textContent="🛡️",this.element.offsetHeight,this.isComfortMode?(this.element.classList.add("comfort-on"),this.element.title="Comfort Mode: ON (Teleport Movement)",this.element.setAttribute("aria-label","Comfort Mode is ON - Click to disable")):(this.element.classList.add("comfort-off"),this.element.title="Comfort Mode: OFF (Smooth Movement)",this.element.setAttribute("aria-label","Comfort Mode is OFF - Click to enable")),setTimeout(()=>{this.element&&this.element.offsetHeight},0))}updateFloatingVisualState(){this.element&&(this.updatePosition(),this.element.textContent="🛡️",this.element.classList.remove("comfort-off","comfort-on"),this.isComfortMode?(this.element.classList.add("comfort-on"),this.element.title="Comfort Mode: ON (Teleport Movement)",this.element.setAttribute("aria-label","Comfort Mode is ON - Click to disable")):(this.element.classList.add("comfort-off"),this.element.title="Comfort Mode: OFF (Smooth Movement)",this.element.setAttribute("aria-label","Comfort Mode is OFF - Click to enable comfortable movement")),this.element.style.display="none",this.element.offsetHeight,this.element.style.display="flex")}toggle(){this.isComfortMode=!this.isComfortMode,this.vrManager&&(this.isComfortMode?this.vrManager.setComfortPreset("max-comfort"):this.vrManager.setComfortPreset("performance")),this.updateVisualState();const e=new CustomEvent("vrcomfortchange",{detail:{isComfortMode:this.isComfortMode,preset:this.isComfortMode?"max-comfort":"performance"}});this.element.dispatchEvent(e)}setComfortMode(e){this.isComfortMode!==e&&this.toggle()}getComfortMode(){return this.isComfortMode}updateOptions(e){this.options={...this.options,...e},e.offsetX!==void 0&&(document.documentElement.style.setProperty("--vr-comfort-offset-x",this.options.offsetX+"px"),document.documentElement.style.setProperty("--vr-comfort-offset-x-mobile",this.options.offsetX-5+"px")),e.offsetY!==void 0&&(document.documentElement.style.setProperty("--vr-comfort-offset-y",this.options.offsetY+"px"),document.documentElement.style.setProperty("--vr-comfort-offset-y-mobile",this.options.offsetY+10+"px")),e.position!==void 0&&this.updatePosition()}hide(){this.element&&(this.element.style.display="none")}show(){this.element&&(this.element.style.display="flex")}dispose(){if(this.element&&(this.element.removeEventListener("click",this.toggle),this.element.removeEventListener("keydown",this.toggle),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null),document.querySelectorAll(".vr-comfort-glyph").length===0){const t=document.getElementById("vr-comfort-glyph-styles");t&&t.remove()}this.vrManager=null}static create(e,t={}){return new Oe(e,t)}}class Ls{constructor(e){this.scene=e,this.particleBounds={min:new p.Vector3(-50,-25,-50),max:new p.Vector3(50,25,50)},this.particleCount=1750,this.createParticleSystem()}calculateParticleCount(e){const t=new p.Vector3;e.getSize(t);const s=t.clone().multiplyScalar(2.5),o=s.x*s.y*s.z;let n;o<5e3?n=.0625:o<2e4?n=.0625+(o-5e3)/15e3*1.9375:n=3.5;const a=Math.round(o*n);return Math.max(100,Math.min(8e3,a))}createParticleSystem(){const e=new Float32Array(this.particleCount*3),t=new Float32Array(this.particleCount*3),i=new Float32Array(this.particleCount);this.initializeParticleData(e,t,i);const s=new p.BufferGeometry,o=new Float32Array(this.particleCount);for(let n=0;n<this.particleCount;n++)o[n]=n;s.setAttribute("position",new p.BufferAttribute(e,3)),s.setAttribute("originalSize",new p.BufferAttribute(i,1)),s.setAttribute("velocity",new p.BufferAttribute(t,3)),s.setAttribute("particleIndex",new p.BufferAttribute(o,1)),this.originalMaterial=this.createParticleMaterial(),this.particles=new p.Points(s,this.originalMaterial),this.particles.visible=!1,this.scene.add(this.particles)}initializeParticleData(e,t,i){for(let s=0;s<this.particleCount;s++){const o=s*3;e[o]=this.particleBounds.min.x+Math.random()*(this.particleBounds.max.x-this.particleBounds.min.x),e[o+1]=this.particleBounds.min.y+Math.random()*(this.particleBounds.max.y-this.particleBounds.min.y),e[o+2]=this.particleBounds.min.z+Math.random()*(this.particleBounds.max.z-this.particleBounds.min.z);const n=1e-5,a=-5e-6,r=5e-6;t[o]=n+(Math.random()-.5)*2e-5,t[o+1]=a+(-Math.random()*1e-5-5e-6),t[o+2]=r+(Math.random()-.5)*2e-5;const A=Math.random();A<.7?i[s]=.03+Math.random()*.02:A<.9?i[s]=.05+Math.random()*.03:i[s]=.08+Math.random()*.04}}createParticleMaterial(){const e=document.createElement("canvas");e.width=e.height=32;const t=e.getContext("2d"),i=t.createRadialGradient(16,16,0,16,16,16);i.addColorStop(0,"rgba(255, 255, 255, 1)"),i.addColorStop(.7,"rgba(255, 255, 255, 0.8)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=i,t.fillRect(0,0,32,32);const s=new p.CanvasTexture(e);return s.needsUpdate=!0,new p.ShaderMaterial({uniforms:{time:{value:0},pointTexture:{value:s},color:{value:new p.Color(16777215)},opacity:{value:1},size:{value:2},boundsMin:{value:this.particleBounds.min.clone()},boundsMax:{value:this.particleBounds.max.clone()},fogColor:{value:new p.Color(268073)},fogDensity:{value:0}},vertexShader:`
        uniform float time;
        uniform float size;
        uniform vec3 boundsMin;
        uniform vec3 boundsMax;
        
        attribute float originalSize;
        attribute vec3 velocity;
        attribute float particleIndex;
        
        varying float vOpacity;
        varying float vFogFactor;
        
        void main() {
          // Calculate animated position
          vec3 animatedPosition = position;
          
          // Apply constant velocity drift
          animatedPosition += velocity * time;
          
          // Add gentle wave motion
          float waveX = sin(time * 0.00025 + particleIndex * 0.01) * 0.5;
          float waveY = cos(time * 0.0002 + particleIndex * 0.008) * 0.25;
          float waveZ = sin(time * 0.0003 + particleIndex * 0.012) * 0.5;
          animatedPosition += vec3(waveX, waveY, waveZ);
          
          // Boundary wrapping
          vec3 boundsSize = boundsMax - boundsMin;
          animatedPosition = boundsMin + mod(animatedPosition - boundsMin, boundsSize);
          
          // Size calculation
          float finalSize = originalSize * size;
          
          // Transform to screen space
          vec4 mvPosition = modelViewMatrix * vec4(animatedPosition, 1.0);
          gl_Position = projectionMatrix * mvPosition;
          
          // Size attenuation
          gl_PointSize = finalSize * (300.0 / -mvPosition.z);
          
          // Calculate fog factor for exponential squared fog
          float fogDistance = -mvPosition.z;
          vFogFactor = 1.0 - exp(-fogDistance * fogDistance * 0.0064);
          vFogFactor = clamp(vFogFactor, 0.0, 1.0);
          
          // Simple opacity variation
          vOpacity = 0.8 + sin(particleIndex * 0.1) * 0.2;
        }
      `,fragmentShader:`
        uniform sampler2D pointTexture;
        uniform vec3 color;
        uniform float opacity;
        uniform vec3 fogColor;
        
        varying float vOpacity;
        varying float vFogFactor;
        
        void main() {
          // Sample the circular texture
          vec4 textureColor = texture2D(pointTexture, gl_PointCoord);
          
          // Base particle color
          vec3 finalColor = color;
          
          // Apply fog mixing
          finalColor = mix(finalColor, fogColor, vFogFactor);
          
          // Final alpha with fog consideration
          float finalAlpha = textureColor.a * opacity * vOpacity * (1.0 - vFogFactor * 0.8);
          
          gl_FragColor = vec4(finalColor, finalAlpha);
          
          // Alpha test
          if (gl_FragColor.a < 0.01) discard;
        }
      `,transparent:!0,depthWrite:!1,blending:p.NormalBlending,fog:!1})}enable(){this.particles&&(this.particles.material=this.originalMaterial,this.particles.visible=!0)}disable(){this.particles&&(this.particles.visible=!1)}update(e){this.particles&&this.particles.material&&this.particles.material.uniforms&&(this.particles.material.uniforms.time.value=e)}updateBounds(e){if(!e)return;const t=new p.Box3().setFromObject(e),i=t.getSize(new p.Vector3),s=t.getCenter(new p.Vector3),n=i.clone().multiplyScalar(2.5*.5);this.particleBounds.min.copy(s).sub(n),this.particleBounds.max.copy(s).add(n);const a=this.calculateParticleCount(new p.Box3(this.particleBounds.min,this.particleBounds.max));Math.abs(a-this.particleCount)>this.particleCount*.2?(this.particles&&(this.scene.remove(this.particles),this.particles.geometry&&this.particles.geometry.dispose(),this.particles.material&&this.particles.material.dispose(),this.particles=null),this.particleCount=a,this.createParticleSystem()):this.redistributeParticles()}redistributeParticles(){if(!this.particles||!this.particles.geometry.attributes.position)return;const e=this.particles.geometry.attributes.position.array;for(let t=0;t<this.particleCount;t++){const i=t*3;e[i]=this.particleBounds.min.x+Math.random()*(this.particleBounds.max.x-this.particleBounds.min.x),e[i+1]=this.particleBounds.min.y+Math.random()*(this.particleBounds.max.y-this.particleBounds.min.y),e[i+2]=this.particleBounds.min.z+Math.random()*(this.particleBounds.max.z-this.particleBounds.min.z)}this.particles.geometry.attributes.position.needsUpdate=!0,this.particles.material.uniforms&&(this.particles.material.uniforms.boundsMin.value.copy(this.particleBounds.min),this.particles.material.uniforms.boundsMax.value.copy(this.particleBounds.max))}updateFog(e){this.particles&&this.particles.material&&this.particles.material.uniforms&&(e?(this.particles.material.uniforms.fogColor.value.copy(e.color),this.particles.material.uniforms.fogDensity.value=e.density):this.particles.material.uniforms.fogDensity.value=0)}dispose(){this.particles&&(this.scene.remove(this.particles),this.particles.geometry&&this.particles.geometry.dispose(),this.particles.material&&this.particles.material.dispose(),this.particles=null)}}class Fs{constructor(e){this.scene=e,this.controllerSpotlight=null,this.spotlightTarget=null,this.isQuest2=!1,this.isQuest3=!1,this.detectQuestDevice(),this.createSpotlight()}detectQuestDevice(){try{const e=navigator.userAgent.toLowerCase();return e.includes("quest 2")||e.includes("oculus quest 2")||e.includes("oculus")&&e.includes("android")&&!e.includes("quest 3")?(this.isQuest2=!0,"quest2"):e.includes("quest 3")||e.includes("oculus quest 3")||e.includes("meta quest 3")?(this.isQuest3=!0,"quest3"):"unknown"}catch(e){return console.warn("Device detection failed:",e),"unknown"}}createSpotlight(e=25){this.controllerSpotlight&&(this.scene.remove(this.controllerSpotlight),this.scene.remove(this.spotlightTarget));const t=e*Math.PI/180,i=(this.isQuest2,15);this.controllerSpotlight=new p.SpotLight(16777215,2.5,i,t,.15,.8),this.controllerSpotlight.position.set(0,0,0),this.controllerSpotlight.visible=!0,this.controllerSpotlight.castShadow=!0;const s=this.isQuest2?512:1024;this.controllerSpotlight.shadow.mapSize.width=s,this.controllerSpotlight.shadow.mapSize.height=s,this.controllerSpotlight.shadow.camera.near=.1,this.controllerSpotlight.shadow.camera.far=i,this.controllerSpotlight.shadow.camera.fov=e,this.controllerSpotlight.shadow.bias=-5e-4,this.controllerSpotlight.shadow.normalBias=.02,this.controllerSpotlight.shadow.radius=4,this.controllerSpotlight.shadow.blurSamples=10,this.scene.add(this.controllerSpotlight),this.spotlightTarget=new p.Object3D,this.scene.add(this.spotlightTarget),this.controllerSpotlight.target=this.spotlightTarget}enableTorch(){this.controllerSpotlight?this.controllerSpotlight.visible=!0:console.error("Cannot enable torch - controllerSpotlight is null")}disableTorch(){this.controllerSpotlight&&(this.controllerSpotlight.visible=!1)}updatePosition(e){if(!this.controllerSpotlight||!this.spotlightTarget||!e){e||console.warn("updatePosition called with null controller");return}const t=new p.Vector3,i=new p.Quaternion;e.getWorldPosition(t),e.getWorldQuaternion(i),this.controllerSpotlight.position.copy(t);const s=new p.Vector3(0,0,-1);s.applyQuaternion(i);const o=t.clone().add(s.multiplyScalar(2));this.spotlightTarget.position.copy(o)}updateCameraPosition(e){if(!this.controllerSpotlight||!this.spotlightTarget)return;this.controllerSpotlight.position.copy(e.position);const t=new p.Vector3(0,0,-1);t.applyQuaternion(e.quaternion);const i=e.position.clone().add(t.multiplyScalar(8));this.spotlightTarget.position.copy(i)}setIntensity(e){this.controllerSpotlight&&(this.controllerSpotlight.intensity=e)}setColor(e){this.controllerSpotlight&&this.controllerSpotlight.color.setHex(e)}setBeamWidth(e){if(this.controllerSpotlight){const t=e*Math.PI/180;this.controllerSpotlight.angle=t,this.controllerSpotlight.shadow.camera.fov=e,this.controllerSpotlight.shadow.camera.updateProjectionMatrix()}}setDistance(e){this.controllerSpotlight&&(this.controllerSpotlight.distance=e,this.controllerSpotlight.shadow.camera.far=e,this.controllerSpotlight.shadow.camera.updateProjectionMatrix())}isVisible(){return this.controllerSpotlight?this.controllerSpotlight.visible:!1}update(e){}dispose(){this.controllerSpotlight&&(this.scene.remove(this.controllerSpotlight),this.controllerSpotlight=null),this.spotlightTarget&&(this.scene.remove(this.spotlightTarget),this.spotlightTarget=null)}}class ks{constructor(e){this.scene=e,this.overheadLight=null,this.clearModeDirectionalLight=null,this.clearModeHemisphereLight=null,this.isTransitioning=!1,this.currentMode="survey",this.pendingAnimations=new Set,this.isDisposed=!1,this.initializeLighting()}initializeLighting(){if(this.isDisposed||!this.scene){console.warn("Cannot initialize lighting: system disposed or no scene");return}try{this.overheadLight=new p.AmbientLight(16777215,.5),this.currentMode=null}catch(e){console.error("Failed to initialize lighting system:",e)}}createSurveyModeLights(){if(!(this.isDisposed||!this.scene))try{this.clearModeDirectionalLight||(this.clearModeDirectionalLight=new p.DirectionalLight(16777215,1.2),this.clearModeDirectionalLight.position.set(10,20,10),this.clearModeDirectionalLight.castShadow=!0,this.clearModeDirectionalLight.shadow.mapSize.width=2048,this.clearModeDirectionalLight.shadow.mapSize.height=2048,this.clearModeDirectionalLight.shadow.camera.near=.5,this.clearModeDirectionalLight.shadow.camera.far=100,this.clearModeDirectionalLight.shadow.camera.left=-20,this.clearModeDirectionalLight.shadow.camera.right=20,this.clearModeDirectionalLight.shadow.camera.top=20,this.clearModeDirectionalLight.shadow.camera.bottom=-20,this.scene.add(this.clearModeDirectionalLight)),this.clearModeHemisphereLight||(this.clearModeHemisphereLight=new p.HemisphereLight(16777215,4473924,.7),this.scene.add(this.clearModeHemisphereLight)),this.fillLight||(this.fillLight=new p.DirectionalLight(16777215,.8),this.fillLight.position.set(-10,10,-10),this.scene.add(this.fillLight)),this.bottomLight||(this.bottomLight=new p.DirectionalLight(16777215,.3),this.bottomLight.position.set(0,-10,0),this.scene.add(this.bottomLight))}catch(e){console.error("Failed to create survey mode lights:",e)}}enableDiveMode(){this.overheadLight&&this.scene.children.includes(this.overheadLight)&&this.scene.remove(this.overheadLight),this.clearModeDirectionalLight&&(this.scene.remove(this.clearModeDirectionalLight),this.clearModeDirectionalLight=null),this.clearModeHemisphereLight&&(this.scene.remove(this.clearModeHemisphereLight),this.clearModeHemisphereLight=null),this.fillLight&&(this.scene.remove(this.fillLight),this.fillLight=null),this.bottomLight&&(this.scene.remove(this.bottomLight),this.bottomLight=null),this.currentMode="dive"}enableSurveyMode(){this.overheadLight&&!this.scene.children.includes(this.overheadLight)&&this.scene.add(this.overheadLight),this.overheadLight&&(this.overheadLight.intensity=.6,this.overheadLight.color.setHex(16777215)),this.createSurveyModeLights(),this.currentMode="survey"}setVRDiveMode(){this.overheadLight&&this.scene.children.includes(this.overheadLight)&&this.scene.remove(this.overheadLight)}setDesktopDiveMode(){this.overheadLight&&this.scene.children.includes(this.overheadLight)&&this.scene.remove(this.overheadLight)}fadeLighting({target:e,fromIntensity:t,toIntensity:i,fromColor:s,toColor:o,duration:n=500,onComplete:a}){if(this.isDisposed||!e){a&&a();return}const r=Symbol("fade-animation");this.pendingAnimations.add(r);const A=performance.now(),h=i-t;let d,g;s!==void 0&&o!==void 0&&(d=new p.Color(s),g=new p.Color(o));const u=m=>{if(!this.pendingAnimations.has(r)||this.isDisposed){a&&a();return}try{const I=m-A,B=Math.min(I/n,1),f=1-Math.pow(1-B,3);if(!e||this.scene&&!this.scene.children.includes(e)){this.pendingAnimations.delete(r),a&&a();return}e.intensity=t+h*f,d&&g&&e.color&&e.color.lerpColors(d,g,f),B<1?requestAnimationFrame(u):(this.pendingAnimations.delete(r),a&&a())}catch(I){console.error("Error in lighting animation:",I),this.pendingAnimations.delete(r),a&&a()}};requestAnimationFrame(u)}cancelActiveAnimations(){this.pendingAnimations.clear()}safeRemoveFromScene(e){if(this.scene&&e&&this.scene.children.includes(e))try{this.scene.remove(e)}catch(t){console.error("Error removing object from scene:",t)}}getCurrentMode(){return this.currentMode}isTransitionInProgress(){return this.isTransitioning}dispose(){this.isDisposed=!0,this.cancelActiveAnimations(),requestAnimationFrame(()=>{try{this.overheadLight&&(this.safeRemoveFromScene(this.overheadLight),this.overheadLight=null),this.clearModeDirectionalLight&&(this.safeRemoveFromScene(this.clearModeDirectionalLight),this.clearModeDirectionalLight=null),this.clearModeHemisphereLight&&(this.safeRemoveFromScene(this.clearModeHemisphereLight),this.clearModeHemisphereLight=null),this.scene=null}catch(e){console.error("Error during lighting system disposal:",e)}})}}class Rs{constructor(e,t,i){this.scene=e,this.renderer=t,this.camera=i,this.isDiveModeEnabled=!1,this.currentVRMode=null,this.lighting=new ks(e),this.particles=new Ls(e),this.torch=new Fs(e),this.isQuest2=!1,this.isQuest3=!1,this.detectQuestDevice(),this.applyModeSettings()}toggleDiveMode(){this.isDiveModeEnabled,this.isDiveModeEnabled=!this.isDiveModeEnabled;const e=document.getElementById("modeToggleSwitch");e&&(e.checked=this.isDiveModeEnabled),this.applyModeSettings()}setDiveMode(e){this.isDiveModeEnabled!==e&&this.toggleDiveMode()}isDiveMode(){return this.isDiveModeEnabled}detectQuestDevice(){try{const e=navigator.userAgent.toLowerCase();return e.includes("quest 2")||e.includes("oculus quest 2")||e.includes("oculus")&&e.includes("android")&&!e.includes("quest 3")?(this.isQuest2=!0,"quest2"):e.includes("quest 3")||e.includes("oculus quest 3")||e.includes("meta quest 3")?(this.isQuest3=!0,"quest3"):"unknown"}catch(e){return console.warn("Device detection failed:",e),"unknown"}}applyQuestOptimizations(){this.isQuest2?(this.camera.far=20,this.camera.updateProjectionMatrix(),this.isDiveModeEnabled&&(this.scene.fog=new p.FogExp2(268073,.084))):(this.camera.far=2e3,this.camera.updateProjectionMatrix(),this.isDiveModeEnabled&&(this.scene.fog=new p.FogExp2(268073,.056)))}applyModeSpecificSettings(){const e=this.renderer.xr.isPresenting;if(this.currentVRMode!==e){if(this.currentVRMode=e,!this.isDiveModeEnabled){this.scene.fog=null;return}e?(this.scene.fog=new p.FogExp2(268073,.056),this.lighting.setVRDiveMode(),this.isDiveModeEnabled&&this.torch.enableTorch()):(this.scene.fog=new p.FogExp2(268073,.005),this.lighting.setDesktopDiveMode()),this.particles.updateFog(this.scene.fog)}}applyModeSettings(){this.isDiveModeEnabled?this.enableDiveMode():this.disableDiveMode()}enableDiveMode(){this.lighting.enableDiveMode(),this.applyQuestOptimizations(),this.particles.enable(),this.torch.enableTorch()}disableDiveMode(){this.scene.fog=null,this.particles.disable(),this.torch.disableTorch(),this.lighting.enableSurveyMode()}updateParticleBounds(e){e?this.particles.updateBounds(e):console.warn("updateParticleBounds called with no model")}updateTorchPosition(e){this.isDiveModeEnabled&&this.torch.updatePosition(e)}updateTorchFromRightController(){if(!this.renderer.xr.isPresenting||!this.isDiveModeEnabled)return;const e=this.renderer.xr.getSession&&this.renderer.xr.getSession();if(!e)return;const t=e.inputSources;for(let i=0;i<t.length;i++)if(t[i].handedness==="right"){const s=this.renderer.xr.getController(i);this.updateTorchPosition(s);break}}updateTorchFromVRManager(e){if(!e||!e.isVRPresenting||!this.isDiveModeEnabled){e?e.isVRPresenting&&this.isDiveModeEnabled:console.warn("updateTorchFromVRManager: vrManager is null");return}if(e.controller2)this.updateTorchPosition(e.controller2);else if(e.controllers&&e.controllers.length>0){const t=e.controllers.find(i=>i.userData&&i.userData.inputSource&&i.userData.inputSource.handedness==="right");t&&this.updateTorchPosition(t)}}update(e,t){this.particles.update(e),this.torch.update(t),this.renderer&&this.checkVRControllerButtons(this.renderer),this.applyModeSpecificSettings()}initializeToggleSwitch(){const e=document.getElementById("modeToggleSwitch");e?(e.checked=!1,this.isDiveModeEnabled=!1,this.disableDiveMode(),e.addEventListener("change",()=>{this.toggleDiveMode()})):this.disableDiveMode(),document.querySelectorAll(".toggle-option").forEach(i=>{i.addEventListener("click",()=>{const s=i.classList.contains("right"),o=e?e.checked:!1;(s&&!o||!s&&o)&&this.toggleDiveMode()})})}handleControllerButton(e,t){return t===4?(this.toggleDiveMode(),!0):!1}checkVRControllerButtons(e){if(!e||!e.xr)return;const t=e.xr.getSession();if(t){for(let i of t.inputSources)if(i.gamepad&&i.handedness){const s=i.gamepad,o=i.handedness;[4,5].forEach(a=>{if(s.buttons[a]){const r=s.buttons[a],A=`${o}-${a}`;this.buttonStates||(this.buttonStates=new Map);const h=this.buttonStates.get(A)||!1,d=r.pressed;d&&!h&&this.toggleDiveMode(),this.buttonStates.set(A,d)}})}}}dispose(){this.lighting.dispose(),this.particles.dispose(),this.torch.dispose()}}class _t extends le{constructor(e={}){super(),this.viewer=e.viewer,this.scene=e.scene,this.camera=e.camera,this.renderer=e.renderer,this.controls=e.controls,this.canvas=e.canvas,this.container=e.container||document.body,this.options={markerColor:"#FFFFFF",markerBorderColor:"#2D3748",markerTextColor:"#2D3748",markerSize:.6,maxMarkers:99,autoSave:!0,occludedOpacity:.3,...e},this.annotations=[],this.markers=new Map,this.activePanel=null,this.activeCard=null,this.activeAnnotation=null,this.editMode=!1,this.nextIndex=1,this.currentAnimation=null,this.cardClickOutsideHandler=null,this.renderLoopId=null,this.cardPositionUpdateId=null,this.raycaster=new p.Raycaster,this.mouse=new p.Vector2,this._raycastTargets=[],this.init()}init(){this.setupEventListeners(),this.setupAnnotationSyncing()}setupAnnotationSyncing(){this.on("annotationUpdated",e=>{e.source==="manager"&&this.activeCard&&this.activeAnnotation&&this.activeAnnotation.id===e.annotation.id&&this.updateActiveCard(e.updates)})}updateActiveCard(e){this.activeCard&&Object.keys(e).forEach(t=>{const i=this.activeCard.querySelector(`[data-field="${t}"]`);i&&(i.textContent=e[t])})}startRenderLoop(){const e=()=>{this.markers.size>0&&this.updateAllMarkerScales(),this.renderLoopId=requestAnimationFrame(e)};this.renderLoopId=requestAnimationFrame(e)}stopRenderLoop(){this.renderLoopId&&(cancelAnimationFrame(this.renderLoopId),this.renderLoopId=null)}onModelLoaded(){this.loadAnnotationsFromStorage()}setRaycastTargets(e){if(!e){this._raycastTargets=[];return}const t=Array.isArray(e)?e:[e],i=[];t.forEach(s=>{s&&s.type==="Mesh"?i.push(s):s&&s.children&&s.traverse(o=>{o.type==="Mesh"&&i.push(o)})}),this._raycastTargets=i}setupEventListeners(){if(!this.canvas){console.warn("No canvas found for annotation system event listeners");return}this.canvas.addEventListener("click",e=>{this.editMode?this.handleEditModeClick(e):this.handleViewModeClick(e)}),this.canvas.addEventListener("mousemove",e=>{this.handleMouseMove(e)}),this.canvas.addEventListener("mouseleave",()=>{this.clearAllHoverStates()}),this.canvas.addEventListener("mousedown",()=>{this.currentAnimation&&this.stopCameraAnimation()}),this.controls&&this.controls.addEventListener("start",()=>{this.currentAnimation&&this.stopCameraAnimation()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(this.hideAnnotationCard(),this.currentAnimation&&this.stopCameraAnimation())})}validateAnnotationData(e){const t={version:"string",modelId:"string",annotations:"array",tourSettings:"object"};if(!e||typeof e!="object")throw new Error("Invalid annotation data: must be an object");for(const[i,s]of Object.entries(t))if(i!=="tourSettings"){if(!(i in e))throw new Error(`Missing required field: ${i}`);if(s==="array"){if(!Array.isArray(e[i]))throw new Error(`Invalid type for ${i}: expected ${s}, got ${typeof e[i]}`)}else if(typeof e[i]!==s)throw new Error(`Invalid type for ${i}: expected ${s}, got ${typeof e[i]}`)}if(!Array.isArray(e.annotations))throw new Error("annotations must be an array");return e.annotations.forEach((i,s)=>{this.validateAnnotation(i,s)}),!0}validateAnnotation(e,t=0){const i=["id","index","position","title"];for(const s of i)if(!(s in e))throw new Error(`Annotation ${t}: missing required field '${s}'`);if(!this.isValidVector3(e.position))throw new Error(`Annotation ${t}: invalid position vector`);if(e.normal&&!this.isValidVector3(e.normal))throw new Error(`Annotation ${t}: invalid normal vector`);if(e.cameraView&&(!this.isValidVector3(e.cameraView.position)||!this.isValidVector3(e.cameraView.target)))throw new Error(`Annotation ${t}: invalid camera view`);return!0}isValidVector3(e){return e&&typeof e=="object"&&typeof e.x=="number"&&typeof e.y=="number"&&typeof e.z=="number"}createAnnotationData(){return{version:"1.0",modelId:this.viewer.currentModel||"default",annotations:this.annotations,tourSettings:{defaultDuration:8e3,transitionDuration:2e3,vrTeleportEnabled:!0}}}enterEditMode(){this.editMode=!0,this.canvas&&this.canvas.style&&(this.canvas.style.cursor="crosshair"),console.log("Entered annotation edit mode")}exitEditMode(){this.editMode=!1,this.canvas&&this.canvas.style&&(this.canvas.style.cursor="default"),console.log("Exited annotation edit mode")}handleEditModeClick(e){if(e.preventDefault(),!this._raycastTargets||this._raycastTargets.length===0){console.warn("No raycast targets set for annotation placement");return}const t=this.canvas.getBoundingClientRect();if(this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,!this.camera){console.warn("No camera found for raycasting");return}this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(this._raycastTargets,!0);if(i.length>0){const s=i[0];this.createAnnotationAtPoint(s.point,s.face.normal)}}handleViewModeClick(e){e.preventDefault();const t=this.canvas.getBoundingClientRect();if(this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1,!this.camera){console.warn("No camera found for raycasting");return}this.raycaster.setFromCamera(this.mouse,this.camera);const i=Array.from(this.markers.values()),s=this.raycaster.intersectObjects(i);if(s.length>0){const o=s[0].object,n=this.annotations.find(a=>a.id===o.userData.annotationId);n&&this.selectAnnotation(n)}else this.hideAnnotationCard()}createAnnotationAtPoint(e,t=null){const s={id:`annotation_${this.nextIndex}`,index:this.nextIndex,position:{x:e.x,y:e.y,z:e.z},normal:t?{x:t.x,y:t.y,z:t.z}:{x:0,y:1,z:0},title:`Annotation ${this.nextIndex}`,description:"Click to edit this annotation description",cameraView:this.getCurrentCameraView(),metadata:{created:new Date().toISOString()}};this.addAnnotation(s),this.selectAnnotation(s)}addAnnotation(e){this.annotations.push(e),this.createMarker(e),this.nextIndex++,this.options.autoSave&&this.saveAnnotationsToStorage(),this.emit("annotationAdded",{annotation:e}),this.emit("annotationsChanged",{annotations:this.annotations}),console.log("Added annotation:",e)}createMarker(e){const t=this.createMarkerTexture(e,"normal"),i=new p.SpriteMaterial({map:t,transparent:!0,alphaTest:.1,depthTest:!1,depthWrite:!1,opacity:.7});i.userData={annotation:e,normalTexture:t,hoverTexture:null,selectedTexture:null,isHovered:!1,isSelected:!1};const s=new p.Sprite(i);return s.position.set(e.position.x,e.position.y,e.position.z),s.userData.annotationId=e.id,s.userData.annotationType="marker",s.userData.baseSize=this.options.markerSize,this.updateMarkerScale(s),this.markers.set(e.id,s),this.scene&&this.scene.add(s),s}createMarkerTexture(e,t="normal"){const i=document.createElement("canvas"),s=i.getContext("2d"),o=256;i.width=i.height=o;const n=o/2,a=100;s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";let r=this.options.markerColor,A=this.options.markerBorderColor,h=this.options.markerTextColor,d=.3,g=!1,u=!1;t==="hover"?(r="#FFFFFF",A="#1A202C",g=!0,d=.4):t==="selected"&&(r="#64B5F6",A="#1976D2",h="#FFFFFF",u=!0,d=.6),s.save(),s.shadowColor=`rgba(0, 0, 0, ${d})`,s.shadowBlur=t==="selected"?12:8,s.shadowOffsetX=2,s.shadowOffsetY=2,s.fillStyle=r,s.beginPath(),s.arc(n,n,a,0,Math.PI*2),s.fill(),s.restore(),u&&(s.save(),s.shadowColor="rgba(25, 118, 210, 0.8)",s.shadowBlur=25,s.strokeStyle="rgba(25, 118, 210, 0.9)",s.lineWidth=4,s.beginPath(),s.arc(n,n,a+8,0,Math.PI*2),s.stroke(),s.shadowColor="rgba(100, 181, 246, 0.6)",s.shadowBlur=15,s.strokeStyle="rgba(100, 181, 246, 0.7)",s.lineWidth=2,s.beginPath(),s.arc(n,n,a+12,0,Math.PI*2),s.stroke(),s.restore()),s.strokeStyle=A,s.lineWidth=6,s.beginPath(),s.arc(n,n,a,0,Math.PI*2),s.stroke(),g&&(s.save(),s.fillStyle="rgba(255, 255, 255, 0.15)",s.beginPath(),s.arc(n,n,a-8,0,Math.PI*2),s.fill(),s.restore()),s.strokeStyle=t==="normal"?"rgba(45, 55, 72, 0.1)":"rgba(45, 55, 72, 0.2)",s.lineWidth=2,s.beginPath(),s.arc(n,n,a-15,0,Math.PI*2),s.stroke(),s.fillStyle=h,s.font='bold 84px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif',s.textAlign="center",s.textBaseline="middle",s.save(),s.shadowColor="rgba(0, 0, 0, 0.9)",s.shadowBlur=4,s.shadowOffsetX=1,s.shadowOffsetY=1,s.fillText(e.index.toString(),n,n),s.restore(),s.save(),s.shadowColor="rgba(255, 255, 255, 0.4)",s.shadowBlur=1,s.fillText(e.index.toString(),n,n),s.restore();const m=new p.CanvasTexture(i);return m.generateMipmaps=!1,m.minFilter=p.LinearFilter,m.magFilter=p.LinearFilter,m}handleMouseMove(e){if(!this.raycaster||!this.camera)return;const t=document.elementFromPoint(e.clientX,e.clientY);if(t&&t.closest(".belowjs-annotation-card")){this.clearAllHoverStates();return}const i=this.canvas.getBoundingClientRect(),s=new p.Vector2((e.clientX-i.left)/i.width*2-1,-((e.clientY-i.top)/i.height)*2+1);this.raycaster.setFromCamera(s,this.camera);const o=Array.from(this.markers.values());this.raycaster.near=.1,this.raycaster.far=1e3;const n=this.raycaster.intersectObjects(o);let a=null;n.length>0&&(a=n[0].object.userData.annotationId),this.markers.forEach((r,A)=>{this.setMarkerHovered(A,!1)}),a&&this.setMarkerHovered(a,!0),this.canvas.style.cursor=a?"pointer":"default"}clearAllHoverStates(){this.markers.forEach((e,t)=>{this.setMarkerHovered(t,!1)}),this.canvas.style.cursor="default"}setMarkerHovered(e,t){const i=this.markers.get(e);if(!i)return;const s=i.material,o=s.userData;!o||o.isHovered===t||(o.isHovered=t,t&&!o.isSelected?(o.hoverTexture||(o.hoverTexture=this.createMarkerTexture(o.annotation,"hover")),s.map=o.hoverTexture,s.opacity=1):o.isSelected||(s.map=o.normalTexture,s.opacity=.7),s.needsUpdate=!0,this.updateMarkerScale(i))}setMarkerSelected(e,t){const i=this.markers.get(e);if(!i)return;const s=i.material,o=s.userData;o.isSelected!==t&&(o.isSelected=t,t?(o.selectedTexture||(o.selectedTexture=this.createMarkerTexture(o.annotation,"selected")),s.map=o.selectedTexture,s.opacity=1):o.isHovered?(o.hoverTexture||(o.hoverTexture=this.createMarkerTexture(o.annotation,"hover")),s.map=o.hoverTexture,s.opacity=1):(s.map=o.normalTexture,s.opacity=.7),s.needsUpdate=!0,this.updateMarkerScale(i))}selectAnnotation(e){this.activeAnnotation&&this.setMarkerSelected(this.activeAnnotation.id,!1),this.activeAnnotation=e,e&&this.setMarkerSelected(e.id,!0),this.updateAnnotationOpacity(),this.showAnnotationCard(e),!this.editMode&&e.cameraView&&this.animateToAnnotation(e),this.emit("annotationSelected",{annotation:e})}updateAnnotationOpacity(){this.markers.forEach((e,t)=>{this.activeAnnotation&&t===this.activeAnnotation.id?e.material.opacity=.8:e.material.opacity=.7})}updateMarkerScale(e){if(!this.camera)return;const t=.8;let i=t;const s=e.material.userData;s&&s.isHovered&&!s.isSelected&&(i=t*1.15),e.scale.set(i,i,1)}updateAllMarkerScales(){this.camera&&this.markers.forEach(e=>{this.updateMarkerScale(e)})}updateAnnotationCameraView(e){const t=this.annotations.find(i=>i.id===e);return t?(t.cameraView=this.getCurrentCameraView(),t.metadata=t.metadata||{},t.metadata.modified=new Date().toISOString(),this.options.autoSave&&this.saveAnnotationsToStorage(),this.emit("annotationUpdated",{annotation:t,updates:{cameraView:t.cameraView}}),this.emit("annotationsChanged",{annotations:this.annotations}),console.log("Updated camera view for annotation:",e),!0):(console.warn("Annotation not found:",e),!1)}updateAnnotation(e,t){const i=this.annotations.find(s=>s.id===e);return i?(Object.assign(i,t),i.metadata=i.metadata||{},i.metadata.modified=new Date().toISOString(),this.options.autoSave&&this.saveAnnotationsToStorage(),this.emit("annotationUpdated",{annotation:i,updates:t}),this.emit("annotationsChanged",{annotations:this.annotations}),!0):(console.warn("Annotation not found:",e),!1)}removeAnnotation(e){const t=this.annotations.findIndex(o=>o.id===e);if(t===-1)return console.warn("Annotation not found:",e),!1;const i=this.annotations[t],s=this.markers.get(e);return s&&(this.scene&&this.scene.remove(s),this.markers.delete(e)),this.annotations.splice(t,1),this.activeAnnotation&&this.activeAnnotation.id===e&&this.hideAnnotationCard(),this.options.autoSave&&this.saveAnnotationsToStorage(),this.emit("annotationRemoved",{annotation:i}),this.emit("annotationsChanged",{annotations:this.annotations}),!0}showAnnotationCard(e){if(this.hideAnnotationCard(),!this.camera||!this.renderer){console.warn("Missing camera or renderer for annotation card positioning");return}if(!this.markers.get(e.id)){console.warn("No marker found for annotation:",e.id);return}const i=this.editMode,s=document.createElement("div");if(s.className="belowjs-annotation-card belowjs-annotation-card-base",s.innerHTML=`
            <div class="belowjs-annotation-card-header">
                <span class="belowjs-annotation-card-index">${e.index}.</span>
                <h4 class="belowjs-annotation-card-title" contenteditable="${i}" data-field="title">${this.escapeHtml(e.title)}</h4>
                <div class="belowjs-annotation-card-actions">
                    ${i?`
                        <button class="belowjs-annotation-card-action-btn card-camera" title="Update camera view">📷</button>
                        <button class="belowjs-annotation-card-action-btn card-delete" title="Delete annotation">🗑️</button>
                    `:""}
                    <button class="belowjs-annotation-card-action-btn card-close" title="Close">×</button>
                </div>
            </div>
            <div class="belowjs-annotation-card-content">
                <div class="belowjs-annotation-card-description" contenteditable="${i}" data-field="description">${this.escapeHtml(e.description||"")}</div>
            </div>
        `,this.activeCard=s,this.activePanel=e,s.querySelector(".card-close").addEventListener("click",()=>this.hideAnnotationCard()),i){const n=s.querySelector(".card-camera"),a=s.querySelector(".card-delete");n&&n.addEventListener("click",()=>this.updateAnnotationCameraView(e.id)),a&&a.addEventListener("click",()=>{confirm("Are you sure you want to delete this annotation?")&&this.removeAnnotation(e.id)})}i&&this.setupCardEditing(s,e),this.positionCard(s,e),this.container.appendChild(s),this.setupCardClickOutside(s),this.startCardPositionUpdates(e),s.classList.add("active"),console.log("Annotation card shown for:",e.title)}setupCardEditing(e,t){e.querySelectorAll('[contenteditable="true"]').forEach(s=>{s.addEventListener("blur",()=>{const o=s.dataset.field,n=s.textContent.trim(),a=t[o];n!==a&&(this.updateAnnotation(t.id,{[o]:n}),this.emit("annotationUpdated",{annotation:t,updates:{[o]:n},source:"card"}))}),s.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),s.blur())})})}setupCardClickOutside(e){this.cardClickOutsideHandler&&document.removeEventListener("click",this.cardClickOutsideHandler),this.cardClickOutsideHandler=t=>{e.contains(t.target)||this.hideAnnotationCard()},setTimeout(()=>{document.addEventListener("click",this.cardClickOutsideHandler)},100)}hideAnnotationCard(){this.stopCardPositionUpdates(),this.cardClickOutsideHandler&&(document.removeEventListener("click",this.cardClickOutsideHandler),this.cardClickOutsideHandler=null),this.activeCard&&(this.activeCard.remove(),this.activeCard=null),this.activePanel=null,this.activeAnnotation=null,this.updateAnnotationOpacity(),this.emit("annotationDeselected")}positionCard(e,t){const i=this.markers.get(t.id);if(!i||!this.camera||!this.renderer){e.style.position="fixed",e.style.left="50px",e.style.top="100px",e.style.zIndex="1001";return}try{const s=i.position.clone();s.project(this.camera);const n=this.renderer.domElement.getBoundingClientRect(),a=(s.x*.5+.5)*n.width+n.left,r=(-s.y*.5+.5)*n.height+n.top,A=280,h=40,d=-20;let g=a+h,u=r+d;g+A>window.innerWidth-20&&(g=a-A-h),g=Math.max(20,Math.min(g,window.innerWidth-A-20)),u=Math.max(20,Math.min(u,window.innerHeight-200)),e.style.position="fixed",e.style.left=g+"px",e.style.top=u+"px",e.style.zIndex="1001"}catch(s){console.warn("Error positioning annotation card:",s),e.style.position="fixed",e.style.left="50px",e.style.top="100px",e.style.zIndex="1001"}}startCardPositionUpdates(e){this.cardPositionUpdateId&&this.stopCardPositionUpdates();const t=()=>{this.activeCard&&this.activeAnnotation&&e.id===this.activeAnnotation.id&&(this.positionCard(this.activeCard,e),this.cardPositionUpdateId=requestAnimationFrame(t))};this.cardPositionUpdateId=requestAnimationFrame(t)}stopCardPositionUpdates(){this.cardPositionUpdateId&&(cancelAnimationFrame(this.cardPositionUpdateId),this.cardPositionUpdateId=null)}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}getCurrentCameraView(){var e,t,i,s,o,n,a,r,A,h,d,g,u;return{position:{x:((t=(e=this.camera)==null?void 0:e.position)==null?void 0:t.x)||0,y:((s=(i=this.camera)==null?void 0:i.position)==null?void 0:s.y)||0,z:((n=(o=this.camera)==null?void 0:o.position)==null?void 0:n.z)||0},target:{x:((r=(a=this.controls)==null?void 0:a.target)==null?void 0:r.x)||0,y:((h=(A=this.controls)==null?void 0:A.target)==null?void 0:h.y)||0,z:((g=(d=this.controls)==null?void 0:d.target)==null?void 0:g.z)||0},fov:((u=this.camera)==null?void 0:u.fov)||75}}animateToAnnotation(e,t=2e3){if(!e.cameraView||!this.camera||!this.controls)return;this.currentAnimation&&(cancelAnimationFrame(this.currentAnimation),this.currentAnimation=null);const i={position:this.camera.position.clone(),target:this.controls.target.clone()},s={position:new p.Vector3(e.cameraView.position.x,e.cameraView.position.y,e.cameraView.position.z),target:new p.Vector3(e.cameraView.target.x,e.cameraView.target.y,e.cameraView.target.z)},o=performance.now();let n;const a=r=>{const A=r-o,h=Math.min(A/t,1),d=this.easeInOutCubic(h);this.camera.position.lerpVectors(i.position,s.position,d),this.controls.target.lerpVectors(i.target,s.target,d),this.controls.update(),h<1?(n=requestAnimationFrame(a),this.currentAnimation=n):(this.currentAnimation=null,this.emit("cameraAnimationComplete",{annotation:e}))};n=requestAnimationFrame(a),this.currentAnimation=n,this.emit("cameraAnimationStart",{annotation:e})}stopCameraAnimation(){this.currentAnimation&&(cancelAnimationFrame(this.currentAnimation),this.currentAnimation=null,this.emit("cameraAnimationInterrupted"),console.log("Camera animation interrupted"))}easeInOutCubic(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}updateAnnotationList(){const e=document.getElementById("annotationList");e&&(e.innerHTML="",this.annotations.forEach(t=>{const i=document.createElement("div");i.className="annotation-item",i.textContent=`${t.index}. ${t.title}`,i.addEventListener("click",()=>this.selectAnnotation(t)),e.appendChild(i)}))}saveAnnotationsToStorage(){const e=this.createAnnotationData();localStorage.setItem("belowjs_annotations",JSON.stringify(e))}loadAnnotationsFromStorage(){const e=localStorage.getItem("belowjs_annotations");if(e)try{const t=JSON.parse(e);this.loadAnnotations(t)}catch(t){console.error("Failed to load annotations from storage:",t)}}loadAnnotations(e){try{this.validateAnnotationData(e),this.clearAnnotations(),this.annotations=e.annotations,this.nextIndex=Math.max(...this.annotations.map(t=>t.index),0)+1,this.annotations.forEach(t=>{this.createMarker(t)}),this.emit("annotationsLoaded",{data:e,annotations:this.annotations}),this.emit("annotationsChanged",{annotations:this.annotations}),console.log(`Loaded ${this.annotations.length} annotations`)}catch(t){console.error("Failed to load annotations:",t),this.emit("annotationError",{error:t,message:"Failed to load annotations"})}}clearAnnotations(){this.markers.forEach(e=>{this.scene&&this.scene.remove(e)}),this.markers.clear(),this.annotations=[],this.activeAnnotation=null,this.hideAnnotationCard(),this.emit("annotationsCleared"),this.emit("annotationsChanged",{annotations:this.annotations})}exportAnnotations(){const e=this.createAnnotationData(),t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download=`annotations_${Date.now()}.json`,this.container.appendChild(o),o.click(),this.container.removeChild(o),URL.revokeObjectURL(s),console.log("Exported annotations:",e)}importAnnotations(e){const t=new FileReader;t.onload=i=>{try{const s=JSON.parse(i.target.result);this.loadAnnotations(s)}catch(s){console.error("Failed to import annotations:",s),alert("Failed to import annotations: Invalid JSON file")}},t.readAsText(e)}dispose(){this.clearAnnotations(),this.hideAnnotationCard(),this.cardClickOutsideHandler&&(document.removeEventListener("click",this.cardClickOutsideHandler),this.cardClickOutsideHandler=null),this.currentAnimation&&(cancelAnimationFrame(this.currentAnimation),this.currentAnimation=null),this.stopCardPositionUpdates()}}class Ts extends le{constructor(e,t={}){super(),typeof e=="string"&&(e=document.querySelector(e)),this.container=e||document.body,window.getComputedStyle(this.container).position==="static"&&(this.container.style.position="relative"),this.options={models:{},autoLoadFirst:!0,showLoadingIndicator:!0,showStatus:!0,showInfo:!1,enableVR:!1,enableMeasurement:!1,measurementTheme:"dark",enableVRComfortGlyph:!1,enableDiveSystem:!1,enableFullscreen:!1,enableAnnotations:!1,annotationOptions:{},...t},this.currentModelKey=null,this.belowViewer=null,this.ui={},this.measurementSystem=null,this.comfortGlyph=null,this.diveSystem=null,this.fullscreenButton=null,this.annotationSystem=null,this.lastComfortMode=null,typeof window<"u"&&(window.modelViewer=this),this.init()}init(){const e={scene:{background:{type:"color",value:"#041729"},fog:{enabled:!1,color:"#041729",near:10,far:100}},camera:{fov:65,near:.05,far:2e3,position:{x:0,y:5,z:10},desktop:{enableDamping:!0,dampingFactor:.08,maxDistance:100,minDistance:.5}},renderer:{antialias:!0,alpha:!1,powerPreference:"high-performance"}},t={...e,...this.options.viewerConfig,...this.options.enableVR&&{vr:{enabled:!0}},...this.options.audioPath&&{audioPath:this.options.audioPath},...typeof this.options.enableVRAudio<"u"&&{enableVRAudio:this.options.enableVRAudio},...this.options.scene&&{scene:{...e.scene,...this.options.scene}},...this.options.camera&&{camera:{...e.camera,...this.options.camera}},...this.options.renderer&&{renderer:{...e.renderer,...this.options.renderer}},...this.options.vr&&{vr:{...this.options.vr}}};if(this.belowViewer=new vt(this.container,t),this.setupEventForwarding(),this.belowViewer.on("initialized",()=>{this.setupFocusInteraction(),this._maybeAttachMeasurementSystem(),this._maybeAttachVRComfortGlyph(),this._maybeAttachDiveSystem(),this._maybeAttachAnnotationSystem(),this._maybeAttachFullscreenButton()}),this.belowViewer.isInitialized&&(this.setupFocusInteraction(),this._maybeAttachMeasurementSystem(),this._maybeAttachVRComfortGlyph(),this._maybeAttachDiveSystem(),this._maybeAttachAnnotationSystem(),this._maybeAttachFullscreenButton()),Object.keys(this.options.models).length>0&&(this.createUI(),this.populateDropdown(),this.options.autoLoadFirst)){const i=Object.keys(this.options.models)[0];setTimeout(()=>this.loadModel(i),100)}}_maybeAttachMeasurementSystem(){if(!this.options.enableMeasurement||this.measurementSystem)return;this.measurementSystem=new Ds({scene:this.belowViewer.sceneManager.scene,camera:this.belowViewer.cameraManager.camera,renderer:this.belowViewer.renderer,controls:this.belowViewer.cameraManager.controls,theme:this.options.measurementTheme});const e=()=>this.measurementSystem&&this.measurementSystem.update();if(this.belowViewer.onAfterRender)this.belowViewer.onAfterRender(e);else if(this.onAfterRender)this.onAfterRender(e);else{const t=()=>{e(),requestAnimationFrame(t)};t()}if(this.belowViewer.loadedModels&&this.belowViewer.loadedModels.length>0){const t=this.belowViewer.loadedModels[0].model;this.measurementSystem.setRaycastTargets(t)}}async _maybeAttachVRComfortGlyph(){!this.options.enableVRComfortGlyph||this.comfortGlyph||this.belowViewer.vrManager&&this.belowViewer.vrManager.vrCore&&(await this.belowViewer.vrManager.vrCore.checkVRSupported(),this.belowViewer.vrManager.vrCore.isVRSupported&&(this.comfortGlyph=new Oe(this.belowViewer.vrManager,{position:"bottom-right",offsetX:20,offsetY:70}),this.lastComfortMode=this.comfortGlyph.isComfortMode,this.comfortGlyph.element.addEventListener("vrcomfortchange",e=>{this.lastComfortMode=e.detail.isComfortMode}),this.belowViewer.vrManager&&this.belowViewer.vrManager.vrCore&&(this.belowViewer.vrManager.vrCore.onSessionStart=()=>{this.lastComfortMode!==null&&setTimeout(()=>{this.lastComfortMode?this.belowViewer.vrManager.setComfortPreset("max-comfort"):this.belowViewer.vrManager.setComfortPreset("performance"),this.comfortGlyph.setComfortMode(this.lastComfortMode)},50)}),document.addEventListener("keydown",e=>{e.code==="KeyC"&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.comfortGlyph&&this.comfortGlyph.toggle())}),window.addEventListener("beforeunload",()=>this.comfortGlyph&&this.comfortGlyph.dispose())))}_maybeAttachDiveSystem(){if(!this.options.enableDiveSystem||this.diveSystem)return;this.diveSystem=new Rs(this.belowViewer.sceneManager.scene,this.belowViewer.renderer,this.belowViewer.cameraManager.camera),setTimeout(()=>{this.diveSystem.initializeToggleSwitch()},100);const e=t=>{if(this.diveSystem){const i=performance.now();this.diveSystem.update(i,t),this.belowViewer.vrManager&&this.diveSystem.updateTorchFromVRManager(this.belowViewer.vrManager),this.belowViewer.renderer.xr.isPresenting||this.diveSystem.torch.updateCameraPosition(this.belowViewer.cameraManager.camera)}};this.belowViewer.onAfterRender?this.belowViewer.onAfterRender(e):this.belowViewer.on("before-render",e),this.on("model-loaded",t=>{this.diveSystem&&t.model&&this.diveSystem.updateParticleBounds(t.model)}),typeof window<"u"&&(window.diveSystem=this.diveSystem)}async _maybeAttachAnnotationSystem(){var e;if(!(!this.options.enableAnnotations||this.annotationSystem)){if(this.annotationSystem=new _t({viewer:this.belowViewer,scene:this.belowViewer.sceneManager.scene,camera:this.belowViewer.cameraManager.camera,renderer:this.belowViewer.renderer,controls:this.belowViewer.cameraManager.controls,canvas:this.belowViewer.renderer.domElement,container:this.container,...this.options.annotationOptions}),this.modelReady&&this.currentModelKey&&((e=this.belowViewer.loadedModels)==null?void 0:e.length)>0){const t=this.belowViewer.loadedModels[0].model;this.annotationSystem.setRaycastTargets(t),this.annotationSystem.onModelLoaded()}typeof window<"u"&&(window.annotationSystem=this.annotationSystem)}}_maybeAttachFullscreenButton(){if(!this.options.enableFullscreen||this.fullscreenButton)return;const e=document.createElement("div");e.id="fullscreenButton",e.className="fullscreen-button",this.options.measurementTheme==="light"&&e.classList.add("light-theme"),this.options.enableMeasurement||e.classList.add("no-measurement"),e.textContent="⛶",e.tabIndex=0,e.title="Enter Fullscreen",e.setAttribute("aria-label","Enter Fullscreen"),e.addEventListener("click",()=>this.toggleFullscreen()),e.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),this.toggleFullscreen())}),this.container.appendChild(e),this.fullscreenButton=e,this.ui.fullscreen=e,this._onFullscreenChange=()=>this.updateFullscreenButton(),document.addEventListener("fullscreenchange",this._onFullscreenChange),this.updateFullscreenButton()}toggleFullscreen(){if(this.isFullscreen()){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document),this.updateFullscreenButton()}else{const e=this.container,t=e.requestFullscreen||e.webkitRequestFullscreen||e.msRequestFullscreen;t&&t.call(e).catch(i=>console.error("[ModelViewer] Failed to enter fullscreen",i)),this.updateFullscreenButton()}}isFullscreen(){const e=this.container;return document.fullscreenElement===e||document.webkitFullscreenElement===e||document.msFullscreenElement===e}updateFullscreenButton(){if(!this.fullscreenButton)return;const e=this.isFullscreen();this.fullscreenButton.title=e?"Exit Fullscreen":"Enter Fullscreen",this.fullscreenButton.setAttribute("aria-label",e?"Exit Fullscreen":"Enter Fullscreen"),this.fullscreenButton.textContent="⛶"}setupEventForwarding(){this.belowViewer.on("initialized",e=>this.emit("initialized",e)),this.belowViewer.on("model-load-start",e=>this.emit("model-load-start",e)),this.belowViewer.on("model-load-progress",e=>{this.emit("model-load-progress",e),this.updateLoadingProgress(e)}),this.belowViewer.on("model-loaded",e=>{this.emit("model-loaded",e),this.emit("modelLoaded",e),this.onModelLoaded(e)}),this.belowViewer.on("model-load-error",e=>{this.emit("model-load-error",e),this.onModelLoadError(e)}),this.belowViewer.on("model-load-cancelled",e=>this.emit("model-load-cancelled",e)),this.belowViewer.on("error",e=>this.emit("error",e)),this.belowViewer.on("vr-session-start",e=>{this.emit("vr-session-start",e),this.onVRSessionStart()}),this.belowViewer.on("vr-session-end",e=>{this.emit("vr-session-end",e),this.onVRSessionEnd()}),this.belowViewer.on("vr-mode-toggle",e=>{this.emit("vr-mode-toggle",e),this.onVRModeToggle()}),this.belowViewer.on("vr-movement-start",e=>this.emit("vr-movement-start",e)),this.belowViewer.on("vr-movement-stop",e=>this.emit("vr-movement-stop",e)),this.belowViewer.on("vr-movement-update",e=>this.emit("vr-movement-update",e))}onVRSessionStart(){this.ui.info&&(this.ui.info.style.display="none"),this.ui.selector&&(this.ui.selector.style.pointerEvents="none",this.ui.selector.style.opacity="0.5"),this.measurementSystem&&typeof this.measurementSystem.attachVR=="function"&&setTimeout(()=>{var t;const e=(t=this.belowViewer)==null?void 0:t.renderer;if(e&&e.xr&&typeof e.xr.getController=="function"){const i=e.xr.getController(0),s=e.xr.getController(1),o=e.xr.getControllerGrip?e.xr.getControllerGrip(0):void 0,n=e.xr.getControllerGrip?e.xr.getControllerGrip(1):void 0;this.measurementSystem.attachVR({controller1:i,controller2:s,controllerGrip1:o,controllerGrip2:n}),this.measurementSystem.resetGhostSpherePositions()}},100)}onVRSessionEnd(){this.ui.info&&this.options.showInfo&&(this.ui.info.style.display="block"),this.ui.selector&&(this.ui.selector.style.pointerEvents="auto",this.ui.selector.style.opacity="1"),this.measurementSystem&&(this.measurementSystem.controller1=null,this.measurementSystem.controller2=null,this.measurementSystem.controllerGrip1=null,this.measurementSystem.controllerGrip2=null,this.measurementSystem.isVR=!1,this.measurementSystem.ghostSpheres&&(this.measurementSystem.ghostSpheres.left&&(this.measurementSystem.ghostSpheres.left.visible=!1),this.measurementSystem.ghostSpheres.right&&(this.measurementSystem.ghostSpheres.right.visible=!1)))}onVRModeToggle(){}setupFocusInteraction(){const e=this.belowViewer.renderer.domElement,t=300;let i=0,s=!1,o={x:0,y:0};const n=5,a=d=>{s=!1,o.x=d.clientX,o.y=d.clientY},r=d=>{if(!s){const g=Math.abs(d.clientX-o.x),u=Math.abs(d.clientY-o.y);(g>n||u>n)&&(s=!0)}},A=()=>{setTimeout(()=>{s=!1},10)},h=d=>{var m;const g=Date.now(),u=g-i<t;i=g,!((m=this.belowViewer.renderer.xr)!=null&&m.isPresenting||s)&&u&&this.focusOnPoint(d)};e.addEventListener("mousedown",a),e.addEventListener("mousemove",r),e.addEventListener("mouseup",A),e.addEventListener("click",h),this.focusEventHandlers={onMouseDown:a,onMouseMove:r,onMouseUp:A,onMouseClick:h}}focusOnPoint(e){const i=this.belowViewer.renderer.domElement.getBoundingClientRect(),s={x:(e.clientX-i.left)/i.width*2-1,y:-((e.clientY-i.top)/i.height)*2+1},o=new p.Raycaster,n=this.belowViewer.cameraManager.getCamera();o.setFromCamera(s,n);let a=[];if(this.measurementSystem&&this.measurementSystem._raycastTargets&&this.measurementSystem._raycastTargets.length>0)a=this.measurementSystem._raycastTargets;else{const A=this.belowViewer.sceneManager.getScene();a=[],A.traverse(h=>{h.isMesh&&h.geometry&&!this.isMeasurementHelper(h)&&a.push(h)})}if(a.length===0){console.debug("[ModelViewer] No valid raycast targets found for focusing");return}const r=o.intersectObjects(a,!0);if(r.length>0){const A=r[0].point;this.belowViewer.cameraManager.focusOn(A),this.emit("focus",{point:A,intersect:r[0]})}else console.debug("[ModelViewer] No intersections found with valid targets")}isMeasurementHelper(e){if(!e)return!1;if(e.userData.isMeasurementSphere||e.userData.isMeasurementLine||e.type==="Line2"||e.type==="Line")return!0;if(e.geometry&&["RingGeometry","TubeGeometry","PlaneGeometry","CircleGeometry","SphereGeometry"].includes(e.geometry.type))if(e.geometry.type==="SphereGeometry"){const i=e.geometry;if(i.parameters&&i.parameters.radius<.1)return!0}else return!0;return!!(typeof e.name=="string"&&(e.name.startsWith("MeasurementHelper")||e.name.includes("measurement")||e.name.includes("ghost")))}createUI(){this.container===document.body?document.documentElement.classList.add("below-viewer"):this.container.classList.add("below-viewer-container"),Object.keys(this.options.models).length>1&&!this.ui.dropdown&&this.createModelSelector(),this.options.showInfo&&!this.ui.info&&this.createInfoPanel(),this.options.showLoadingIndicator&&!this.ui.loading&&this.createLoadingIndicator(),this.options.showStatus&&!this.ui.status&&this.createStatusIndicator(),this.ui.dropdown&&this.ui.dropdown.addEventListener("change",t=>{t.target.value&&this.loadModel(t.target.value)})}createModelSelector(){const e=this.container,t=e.querySelector("#modelSelector")||document.getElementById("modelSelector");t&&t.parentElement&&t.remove();const i=document.createElement("div");i.id="modelSelector",i.className="below-panel",e.appendChild(i);const s=document.createElement("select");if(s.id="modelDropdown",i.appendChild(s),this.options.enableDiveSystem){const o=document.createElement("div");o.id="modeToggleContainer";const n=document.createElement("div");n.className="semantic-toggle";const a=document.createElement("input");a.type="checkbox",a.id="modeToggleSwitch",n.appendChild(a);const r=document.createElement("div");r.className="toggle-slider-bg",n.appendChild(r);const A=document.createElement("div");A.className="toggle-option left";const h=document.createElement("div");h.className="toggle-icon",h.textContent="📋";const d=document.createElement("div");d.className="toggle-text",d.textContent="Survey",A.appendChild(h),A.appendChild(d);const g=document.createElement("div");g.className="toggle-option right";const u=document.createElement("div");u.className="toggle-icon",u.textContent="🌊";const m=document.createElement("div");m.className="toggle-text",m.textContent="Dive",g.appendChild(u),g.appendChild(m),n.appendChild(A),n.appendChild(g),o.appendChild(n),i.appendChild(o)}this.ui.dropdown=s,this.ui.selector=i}createLoadingIndicator(){const e=document.createElement("div");e.id="loading",e.className="below-loading",e.textContent="Loading...",e.style.display="none",this.container.appendChild(e),this.ui.loading=e}createStatusIndicator(){const e=document.createElement("div");e.id="status",e.className="status below-status",e.style.display="none",this.container.appendChild(e),this.ui.status=e}createInfoPanel(){const e=document.createElement("div");e.id="info",e.className="below-panel";const t=document.createElement("div");t.id="infoTitle",t.textContent="BelowJS";const i=document.createElement("div");i.id="infoControls",i.innerHTML=`
      <strong>Desktop:</strong> Drag to rotate • Scroll to zoom<br>
      <strong>Mobile:</strong> Touch and drag to explore
    `,e.appendChild(t),e.appendChild(i),this.container.appendChild(e),this.ui.info=e}populateDropdown(){if(!this.ui.dropdown)return;this.ui.dropdown.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="Select a Model",e.disabled=!0,e.selected=!0,this.ui.dropdown.appendChild(e),Object.entries(this.options.models).forEach(([t,i])=>{const s=document.createElement("option");s.value=t,s.textContent=i.name||t,this.ui.dropdown.appendChild(s)})}async loadModel(e){const t=this.options.models[e];if(!t){console.error("Model not found:",e);return}this.currentModelKey=e,this.ui.dropdown&&(this.ui.dropdown.value=e),this.showLoading(`Loading ${t.name||e}...`),document.title=`BelowJS – ${t.name||e}`;try{this.measurementSystem&&(this.measurementSystem.clearUnifiedMeasurement(),this.measurementSystem.clearLegacyVRMeasurement(),this.measurementSystem.clearLegacyDesktopMeasurement()),this.belowViewer.clearModels(),await new Promise(s=>setTimeout(s,50));const i=await this.belowViewer.loadModel(t.url,{autoFrame:!1,initialPositions:t.initialPositions});i&&(this.applyInitialPositions(t,i),this.hideLoading(),this.updateStatus(`Loaded: ${t.name||e}`),this.measurementSystem&&this.measurementSystem.setRaycastTargets(i),this.annotationSystem&&(this.annotationSystem.setRaycastTargets(i),this.annotationSystem.onModelLoaded()),this.modelReady=!0,this.emit("model-switched",{modelKey:e,model:i,config:t}),this.emit("modelLoaded",{modelKey:e,model:i,config:t}))}catch(i){i.message!=="Loading cancelled"&&(console.error("Failed to load model:",i),this.hideLoading(),this.updateStatus(`Error loading ${t.name||e}`),this.measurementSystem&&this.measurementSystem.setRaycastTargets([]),this.annotationSystem&&this.annotationSystem.setRaycastTargets([]))}}applyInitialPositions(e,t){const i=e.initialPositions;if(!i)return;const s=this.belowViewer.isVRPresenting();if(s&&i.vr){const o=this.belowViewer.getCamera().parent;o&&(o.position.set(i.vr.dolly.x,i.vr.dolly.y,i.vr.dolly.z),o.rotation.set(i.vr.rotation.x,i.vr.rotation.y,i.vr.rotation.z))}else if(!s&&i.desktop){const o=this.belowViewer.getCamera(),n=this.belowViewer.cameraManager.controls;o&&n&&(o.position.set(i.desktop.camera.x,i.desktop.camera.y,i.desktop.camera.z),n.target.set(i.desktop.target.x,i.desktop.target.y,i.desktop.target.z),n.update())}}showLoading(e="Loading..."){this.ui.loading&&(this.ui.loading.textContent=e,this.ui.loading.style.display="block")}hideLoading(){this.ui.loading&&(this.ui.loading.style.display="none")}updateStatus(e){this.ui.status&&(this.ui.status.textContent=e,this.ui.status.style.display="block")}updateLoadingProgress({progress:e}){if(e.lengthComputable&&this.currentModelKey){const t=this.options.models[this.currentModelKey],i=Math.round(e.loaded/e.total*100);this.showLoading(`Loading ${(t==null?void 0:t.name)||"model"}: ${i}%`)}}onModelLoaded({model:e}){const t=e.userData.boundingBox;t&&t.getSize(new p.Vector3),this.measurementSystem&&this.measurementSystem.setRaycastTargets(e),this.annotationSystem&&(this.annotationSystem.setRaycastTargets(e),this.annotationSystem.onModelLoaded())}onModelLoadError({error:e}){this.hideLoading(),this.updateStatus(`Failed to load model: ${e.message}`)}getCurrentModel(){return this.belowViewer?this.belowViewer.getCurrentModel():null}getCamera(){return this.belowViewer?this.belowViewer.getCamera():null}getScene(){return this.belowViewer?this.belowViewer.sceneManager.scene:null}focusOn(e,t=null){var i;(i=this.belowViewer)!=null&&i.cameraManager&&(this.belowViewer.cameraManager.focusOn(e,t),this.emit("focus",{point:e,distance:t}))}resetCamera(){var e;if(this.currentModelKey&&this.belowViewer){const t=this.options.models[this.currentModelKey],i=(e=t==null?void 0:t.initialPositions)==null?void 0:e.desktop;if(i){const s=this.belowViewer.cameraManager.getCamera(),o=this.belowViewer.cameraManager.getControls();i.camera&&s.position.set(i.camera.x,i.camera.y,i.camera.z),i.target&&o&&(o.target.set(i.target.x,i.target.y,i.target.z),o.update()),this.emit("camera-reset",{modelKey:this.currentModelKey,position:i})}}}setVRComfortSettings(e){if(this.belowViewer&&this.belowViewer.setVRComfortSettings)return this.belowViewer.setVRComfortSettings(e)}setVRComfortPreset(e){if(this.belowViewer&&this.belowViewer.setVRComfortPreset)return this.belowViewer.setVRComfortPreset(e)}getVRComfortSettings(){return this.belowViewer&&this.belowViewer.getVRComfortSettings?this.belowViewer.getVRComfortSettings():null}dispose(){var e,t;if(typeof window<"u"&&window.modelViewer===this&&(window.modelViewer=null),this.focusEventHandlers&&((t=(e=this.belowViewer)==null?void 0:e.renderer)!=null&&t.domElement)){const i=this.belowViewer.renderer.domElement;i.removeEventListener("mousedown",this.focusEventHandlers.onMouseDown),i.removeEventListener("mousemove",this.focusEventHandlers.onMouseMove),i.removeEventListener("mouseup",this.focusEventHandlers.onMouseUp),i.removeEventListener("click",this.focusEventHandlers.onMouseClick),this.focusEventHandlers=null}this.measurementSystem&&(this.measurementSystem.dispose(),this.measurementSystem=null),this.comfortGlyph&&(this.comfortGlyph.dispose(),this.comfortGlyph=null),this.diveSystem&&(this.diveSystem.dispose(),this.diveSystem=null,typeof window<"u"&&window.diveSystem===this.diveSystem&&(window.diveSystem=null)),this.annotationSystem&&(this.annotationSystem.dispose(),this.annotationSystem=null,typeof window<"u"&&window.annotationSystem===this.annotationSystem&&(window.annotationSystem=null)),this.fullscreenButton&&(this.fullscreenButton.remove(),this.fullscreenButton=null,document.removeEventListener("fullscreenchange",this._onFullscreenChange)),this.belowViewer&&this.belowViewer.dispose(),this.removeAllListeners()}}class _s{constructor(e,t={}){this.annotationSystem=e,this.options={theme:"light",position:"right",collapsed:!1,showFileControls:!0,container:null,...t},this.element=null,this.isCollapsed=this.options.collapsed||!1,this.init()}init(){this.createElement(),this.attachEventListeners(),this.updateAnnotationList(),this.annotationSystem&&(this.annotationSystem.on("annotationAdded",()=>this.updateAnnotationList()),this.annotationSystem.on("annotationRemoved",()=>this.updateAnnotationList()),this.annotationSystem.on("annotationsLoaded",()=>this.updateAnnotationList()),this.annotationSystem.on("annotationsChanged",()=>this.updateAnnotationList()),this.annotationSystem.on("annotationUpdated",e=>{e.source==="card"&&this.updateAnnotationList()}),this.annotationSystem.on("annotationSelected",e=>this.onAnnotationSelected(e.annotation)),this.annotationSystem.on("annotationDeselected",()=>this.onAnnotationDeselected()))}createElement(){const e=document.querySelector(".belowjs-annotation-manager");e&&(e.remove(),console.log("Removed existing annotation manager")),this.element=document.createElement("div"),this.element.className=`belowjs-annotation-manager ${this.options.theme}-theme ${this.isCollapsed?"collapsed":""}`,this.options.position==="right"&&(this.element.style.left="auto",this.element.style.right="0"),this.element.innerHTML=`
            <div class="manager-panel">
                <div class="manager-header">
                    <h3 class="manager-title">Annotations</h3>
                    <button class="manager-minimize" title="Collapse panel">‹</button>
                </div>
                <div class="manager-content">
                    <div class="manager-controls">
                        <button class="control-btn" id="editModeBtn">Edit Mode</button>
                        <button class="control-btn" id="clearAllBtn">Clear All</button>
                    </div>
                    
                    <div class="manager-list-container">
                        <div class="manager-list" id="annotationList">
                            <!-- Annotation items will be populated here -->
                        </div>
                    </div>
                    
                    ${this.options.showFileControls?`
                    <div class="manager-shelf">
                        <div class="shelf-divider"></div>
                        <div class="shelf-controls">
                            <button class="shelf-btn" id="exportBtn">Export JSON</button>
                            <button class="shelf-btn" id="importBtn">Import JSON</button>
                            <input type="file" class="file-input" id="importFile" accept=".json">
                        </div>
                    </div>
                    `:""}
                </div>
            </div>
        `,(this.options.container||this.annotationSystem&&this.annotationSystem.container||document.body).appendChild(this.element),this.createTab()}createTab(){const e=document.querySelector(".belowjs-annotation-tab");e&&e.remove(),this.tabElement=document.createElement("div"),this.tabElement.className=`belowjs-annotation-tab ${this.isCollapsed?"collapsed":""}`,this.tabElement.id="managerTab",this.tabElement.innerHTML=`
            <span class="tab-label">Annotations</span>
        `,(this.options.container||this.annotationSystem&&this.annotationSystem.container||document.body).appendChild(this.tabElement)}attachEventListeners(){const e=this.element.querySelector(".manager-minimize"),t=this.element.querySelector("#editModeBtn"),i=this.element.querySelector("#clearAllBtn"),s=this.element.querySelector("#exportBtn"),o=this.element.querySelector("#importBtn"),n=this.element.querySelector("#importFile"),a=this.tabElement||document.querySelector("#managerTab");e==null||e.addEventListener("click",()=>this.toggleMinimize()),t==null||t.addEventListener("click",()=>this.toggleEditMode()),i==null||i.addEventListener("click",()=>this.clearAllAnnotations()),s==null||s.addEventListener("click",()=>this.exportAnnotations()),o==null||o.addEventListener("click",()=>n==null?void 0:n.click()),n==null||n.addEventListener("change",r=>this.importAnnotations(r)),a==null||a.addEventListener("click",()=>this.toggleMinimize()),document.addEventListener("keydown",r=>{var A;r.key==="Escape"&&((A=this.annotationSystem)!=null&&A.editMode)&&this.toggleEditMode()})}toggleMinimize(){var t,i;this.isCollapsed=!this.isCollapsed;const e=this.element.querySelector(".manager-minimize");(t=this.tabElement)==null||t.querySelector(".tab-arrow"),console.log("Toggling collapse state. Current:",this.isCollapsed),this.isCollapsed?(this.element.classList.add("collapsed"),this.tabElement&&this.tabElement.classList.add("collapsed"),e&&(e.textContent="›",e.title="Expand panel")):(this.element.classList.remove("collapsed"),this.tabElement&&this.tabElement.classList.remove("collapsed"),e&&(e.textContent="‹",e.title="Collapse panel")),console.log("Collapse state after toggle:",this.isCollapsed,"Panel classes:",this.element.className,"Tab classes:",(i=this.tabElement)==null?void 0:i.className)}toggleEditMode(){if(!this.annotationSystem){console.warn("No annotation system available for edit mode toggle");return}const e=this.element.querySelector("#editModeBtn");console.log("Toggling edit mode. Current state:",this.annotationSystem.editMode),this.annotationSystem.editMode?(this.annotationSystem.exitEditMode(),e&&(e.textContent="Edit Mode",e.classList.remove("active")),this.element.classList.remove("edit-mode")):(this.annotationSystem.enterEditMode(),e&&(e.textContent="Exit Edit",e.classList.add("active")),this.element.classList.add("edit-mode")),console.log("Edit mode after toggle:",this.annotationSystem.editMode),this.updateAnnotationList()}syncEditModeState(){if(!this.annotationSystem||!this.element)return;const e=this.annotationSystem.editMode,t=this.element.querySelector("#editModeBtn");e?this.element.classList.add("edit-mode"):this.element.classList.remove("edit-mode"),t&&(e?(t.textContent="Exit Edit",t.classList.add("active")):(t.textContent="Edit Mode",t.classList.remove("active")))}clearAllAnnotations(){this.annotationSystem&&confirm("Are you sure you want to clear all annotations? This cannot be undone.")&&(this.annotationSystem.clearAnnotations(),this.updateAnnotationList())}exportAnnotations(){this.annotationSystem&&this.annotationSystem.exportAnnotations()}importAnnotations(e){if(!this.annotationSystem)return;const t=e.target.files[0];t&&this.annotationSystem.importAnnotations(t)}updateAnnotationList(){var s,o;const e=(s=this.element)==null?void 0:s.querySelector("#annotationList");if(!e||!this.annotationSystem)return;this.syncEditModeState();const t=this.annotationSystem.annotations||[];if(t.length===0){e.innerHTML=`
                <div style="text-align: center; color: #666; font-size: 13px; padding: 20px;">
                    No annotations yet.<br>
                    ${this.annotationSystem.editMode?"Click on the 3D model to add annotations.":"Enter edit mode to start adding annotations."}
                </div>
            `;return}const i=((o=this.annotationSystem)==null?void 0:o.editMode)||!1;e.innerHTML=t.map((n,a)=>`
            <div class="annotation-list-item belowjs-annotation-card-base" data-annotation-id="${n.id}" draggable="${i}">
                <div class="belowjs-annotation-card-header">
                    <span class="drag-handle">⋮⋮</span>
                    <span class="belowjs-annotation-card-index">${a+1}.</span>
                    <span class="belowjs-annotation-card-title" contenteditable="${i}" data-field="title">${this.escapeHtml(n.title)}</span>
                    <div class="belowjs-annotation-card-actions">
                        <button class="belowjs-annotation-card-action-btn item-camera-btn" title="Update camera view" data-annotation-id="${n.id}">📷</button>
                        <button class="belowjs-annotation-card-action-btn item-delete" title="Delete annotation">🗑️</button>
                    </div>
                </div>
                <div class="belowjs-annotation-card-content">
                    <div class="belowjs-annotation-card-description" contenteditable="${i}" data-field="description">${this.escapeHtml(n.description||"")}</div>
                </div>
            </div>
        `).join(""),e.querySelectorAll(".annotation-list-item").forEach(n=>{const a=n.dataset.annotationId,r=t.find(d=>d.id===a);n.addEventListener("click",d=>{d.target.contentEditable==="true"||d.target.classList.contains("belowjs-annotation-card-action-btn")||d.target.classList.contains("item-delete")||r&&this.selectAnnotation(r)}),i&&n.querySelectorAll('[contenteditable="true"]').forEach(g=>{g.addEventListener("blur",()=>{const u=g.dataset.field,m=g.textContent.trim(),I=r[u];m!==I&&this.updateAnnotationField(a,u,m)}),g.addEventListener("keydown",u=>{u.key==="Enter"&&(u.preventDefault(),g.blur())})});const A=n.querySelector(".item-delete");A&&A.addEventListener("click",d=>{d.stopPropagation(),this.deleteAnnotation(a)});const h=n.querySelector(".item-camera-btn");h&&h.addEventListener("click",d=>{d.stopPropagation(),this.updateAnnotationCamera(a)}),i&&this.setupDragAndDrop(n,a)})}selectAnnotation(e){this.annotationSystem&&this.annotationSystem.selectAnnotation(e)}onAnnotationSelected(e){this.element.querySelectorAll(".annotation-list-item").forEach(i=>{i.classList.remove("active")});const t=this.element.querySelector(`[data-annotation-id="${e.id}"]`);t&&t.classList.add("active"),this.updateCameraButtonState()}onAnnotationDeselected(){this.element.querySelectorAll(".annotation-list-item").forEach(e=>{e.classList.remove("active")}),this.updateCameraButtonState()}updateAnnotationField(e,t,i){if(!this.annotationSystem)return;const s={};s[t]=i,this.annotationSystem.updateAnnotation(e,s);const o=this.annotationSystem.annotations.find(n=>n.id===e);o&&this.annotationSystem.emit("annotationUpdated",{annotation:o,updates:s,source:"manager"}),console.log(`Updated annotation ${e} ${t}:`,i)}deleteAnnotation(e){this.annotationSystem&&confirm("Are you sure you want to delete this annotation?")&&this.annotationSystem.removeAnnotation(e)}setTheme(e){this.options.theme=e,this.element.className=`belowjs-annotation-manager ${e}-theme`}show(){this.element&&this.element.classList.remove("hidden")}hide(){this.element&&this.element.classList.add("hidden")}updateSelectedCamera(){if(!this.annotationSystem||!this.annotationSystem.activeAnnotation){console.warn("No annotation selected");return}const e=this.annotationSystem.activeAnnotation.id;this.annotationSystem.updateAnnotationCameraView(e)&&(this.updateAnnotationList(),console.log("Camera position updated for annotation:",e))}updateCameraButtonState(){}updateAnnotationCamera(e){this.annotationSystem&&this.annotationSystem.updateAnnotationCameraView(e)&&console.log("Camera position updated for annotation:",e)}setupDragAndDrop(e,t){let i=null;e.addEventListener("dragstart",s=>{console.log("Drag started for:",t),i=e,e.classList.add("dragging"),s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/html",e.outerHTML)}),e.addEventListener("dragend",()=>{console.log("Drag ended for:",t),e.classList.remove("dragging"),i=null,document.querySelectorAll(".drag-over").forEach(s=>s.classList.remove("drag-over"))}),e.addEventListener("dragover",s=>{s.preventDefault(),s.dataTransfer.dropEffect="move",i&&i!==e&&e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",s=>{s.preventDefault(),e.classList.remove("drag-over"),i&&i!==e&&(console.log("Dropping:",i.dataset.annotationId,"on:",e.dataset.annotationId),this.reorderAnnotations(i.dataset.annotationId,e.dataset.annotationId))})}reorderAnnotations(e,t){if(!this.annotationSystem)return;console.log("Reordering annotations:",e,"->",t);const i=this.annotationSystem.annotations,s=i.findIndex(a=>a.id===e),o=i.findIndex(a=>a.id===t);if(console.log("Found indexes:",s,"->",o),s===-1||o===-1){console.warn("Could not find annotation indexes");return}const[n]=i.splice(s,1);i.splice(o,0,n),console.log("Reordered array, updating indexes..."),this.updateAnnotationIndexes(),this.annotationSystem.options.autoSave&&this.annotationSystem.saveAnnotationsToStorage(),console.log("Refreshing annotation list..."),this.updateAnnotationList(),this.annotationSystem.emit("annotationsReordered",{annotations:i})}updateAnnotationIndexes(){this.annotationSystem&&(console.log("Updating annotation indexes..."),this.annotationSystem.annotations.forEach((e,t)=>{const i=t+1,s=e.index;e.index=i,console.log(`Updating annotation ${e.id}: ${s} -> ${i}`);const o=this.annotationSystem.markers.get(e.id);o?(console.log(`Recreating marker for annotation ${e.id} with new index ${i}`),this.annotationSystem.markers.delete(e.id),this.annotationSystem.scene&&this.annotationSystem.scene.remove(o),this.annotationSystem.createMarker(e)):console.warn(`No marker found for annotation ${e.id}`)}),this.annotationSystem.nextIndex=this.annotationSystem.annotations.length+1,console.log("Updated nextIndex to:",this.annotationSystem.nextIndex),this.annotationSystem.updateAnnotationOpacity())}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}dispose(){this.element&&(this.element.remove(),this.element=null),this.tabElement&&(this.tabElement.remove(),this.tabElement=null)}}U.AnnotationManager=_s,U.AnnotationSystem=_t,U.BelowViewer=vt,U.Camera=Ye,U.ConfigValidator=qe,U.EventSystem=le,U.ModelLoader=O,U.ModelViewer=Ts,U.Scene=je,U.VRManager=Qt,Object.defineProperty(U,Symbol.toStringTag,{value:"Module"})});
